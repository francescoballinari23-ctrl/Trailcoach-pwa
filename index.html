<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v14.2 (Mod)</title>
<meta name="theme-color" content="#000000">
<style>
Â  body {
Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
Â  Â  background: #fafafa;
Â  Â  color: #111;
Â  Â  margin: 12px;
Â  }
Â  h1 { text-align: center; font-size: 22px; margin: 6px 0; }
Â  .card { background: #fff; border-radius: 10px; padding: 12px; margin: 10px 0;
Â  Â  Â  Â  Â  box-shadow: 0 1px 6px rgba(0,0,0,.06); }
Â  label { display:block; margin:8px 0 6px; font-weight:600; }
Â  input, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  font-size:15px; box-sizing:border-box; }
Â  button {
Â  Â  background:#007aff; color:#fff; border:none; padding:9px 14px;
Â  Â  border-radius:8px; font-weight:600; cursor:pointer; font-size:14px;
Â  }
Â  button:hover { background:#005fd6; }
Â  button.reset { background:#ff3b30; margin-left:6px; }
Â  .week { background:#f7f9ff; border-radius:8px; margin:8px 0; padding:8px 10px; }
Â  .days { margin-top:6px; padding-left:10px; display:none; }
Â  .day { padding:6px 0; border-bottom:1px solid #eee; }
Â  .detail { background:#fff; border-radius:8px; padding:10px; margin-top:6px; border:1px solid #eee; }
Â  .chk-btn { background:#f0f0f0; border-radius:8px; padding:8px; text-align:center;
Â  Â  Â  Â  Â  Â  Â cursor:pointer; border:1px solid transparent; font-weight:700; }
Â  .chk-btn.active { background:#007aff; color:#fff; border-color:#005fd6; }
Â  .checkbox-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:6px; }
Â  .checkbox-grid-bottom { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
Â  .fileline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
Â  .meta { font-size:13px; color:#333; }
Â  .muted { color:#666; font-size:13px; }
Â  .small { font-size:13px; color:#555; margin-top:6px; }
Â  button.small-btn { background:#eee; color:#007aff; border:1px solid #007aff; padding:4px 8px; font-size:13px; border-radius:6px; }
</style>
</head>
<body>
<h1>ğŸ”ï¸ TrailCoach AI v14.2 (Mod)</h1>

<div class="card" id="settingsCard">
Â  <label>Livello atleta</label>
Â  <select id="livello">
Â  Â  <option value="principiante">Principiante</option>
Â  Â  <option value="intermedio">Intermedio</option>
Â  Â  <option value="avanzato">Avanzato</option>
Â  </select>

Â  <label>Obiettivo distanza gara (km)</label>
Â  <input id="obbKm" type="number" value="42" />

Â  <label>Obiettivo dislivello gara (m)</label>
Â  <input id="obbAsc" type="number" value="2000" />

Â  <label>Durata piano (settimane)</label>
Â  <input id="settimane" type="number" value="12" min="1" max="52" />

Â  <label>Allenamenti totali a settimana (es. 4.5)</label>
Â  <input id="allenTot" type="number" step="0.5" value="4.5" min="2" max="7" />

Â  <label>Giorni palestra</label>
Â  <div class="checkbox-grid" id="palestraTop">
Â  Â  <div class="chk-btn" data-day="LunedÃ¬">Lun</div>
Â  Â  <div class="chk-btn" data-day="MartedÃ¬">Mar</div>
Â  Â  <div class="chk-btn" data-day="MercoledÃ¬">Mer</div>
Â  </div>
Â  <div class="checkbox-grid-bottom" id="palestraBottom">
Â  Â  <div class="chk-btn" data-day="GiovedÃ¬">Gio</div>
Â  Â  <div class="chk-btn" data-day="VenerdÃ¬">Ven</div>
Â  Â  <div class="chk-btn" data-day="Sabato">Sab</div>
Â  Â  <div class="chk-btn" data-day="Domenica">Dom</div>
Â  </div>

Â  <div style="margin-top:10px;">
Â  Â  <button id="genLocal">âš™ï¸ Genera piano</button>
Â  Â  <button id="resetData" class="reset">ğŸ—‘ï¸ Reset</button>
Â  </div>
</div>

<div class="card">
Â  <label>Piano settimanale</label>
Â  <div id="planView" class="small">Nessun piano ancora generato.</div>
</div>

<input id="hiddenFileInput" type="file" accept=".gpx" style="display:none" />

<script>
// === CORE FUNZIONI ===
const STORAGE_KEY = "trailcoach_v14_2_state";
let STATE = { settings:{}, planData:[] };

function paceByLevel(l){ return l==="principiante"?6.2:l==="intermedio"?5.8:5.4; }
const GIORNI = ["LunedÃ¬","MartedÃ¬","MercoledÃ¬","GiovedÃ¬","VenerdÃ¬","Sabato","Domenica"];
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }
function loadState(){ const r=localStorage.getItem(STORAGE_KEY); if(r) STATE=JSON.parse(r); }

// === GESTIONE SELEZIONE GIORNI PALESTRA ===
document.getElementById("settingsCard").addEventListener("click",e=>{
Â  if(e.target.classList.contains("chk-btn")){
Â  Â  e.target.classList.toggle("active");
Â  }
});

// === SELEZIONE GIORNI CORSA MODIFICATA PER EXTRA SETTIMANALE ===
function selectRunDays(allenTot, giorniPalestra, settimane, weekIndex){
Â  const full = Math.floor(allenTot);
Â  const runNeededStandard = Math.max(0, full - giorniPalestra.length);
  
Â  const free = GIORNI.filter(d=>!giorniPalestra.includes(d));
Â  const runSlots = Math.min(runNeededStandard, free.length);
Â  const selected = [];
  
Â  if(runSlots > 0){
    const step = free.length / runSlots;
    for(let i=0;i<runSlots;i++){ selected.push(free[Math.floor(i*step)]); }
  }
  
Â  let extraRunDay = null;
Â  const isExtraWeek = allenTot % 1 >= 0.4 && (weekIndex + 1) % 2 === 0;
  
Â  if (isExtraWeek && runSlots < free.length) {
      extraRunDay = free.find(day => !selected.includes(day));
      if (extraRunDay) {
          selected.push(extraRunDay);
      }
Â  }

Â  return { runDays: selected, extraRunDay: extraRunDay, isExtraWeek };
}

// === GENERA DETTAGLI REALISTICI con correzione del volume ===
function creaDettagliAllenamento(type, weeklyKm, weeklyAsc, runsCount, livello, factor=1, isExtraDay=false){
Â  const pctLungo=0.55, pctQuality=0.20, pctFondo=0.25;
Â  runsCount=Math.max(1, runsCount); // runsCount Ã¨ il numero di corse TOTALI (standard + extra)

  // *** MODIFICA FONDAMENTALE PER LA SOMMA ***
  // Se Ã¨ un giorno extra, il volume di base (weeklyKm/Asc) rappresenta il 100%
  // che deve essere distribuito sugli allenamenti STANDARD.
  // L'allenamento extra (factor=0.5) contribuisce al volume totale.

  // Volume BASE (da dividere tra Lungo, QualitÃ , Fondo)
  let baseKm = weeklyKm;
  let baseAsc = weeklyAsc;
  
  // Se c'Ã¨ un allenamento extra in questa settimana, sottraiamo il volume
  // che l'allenamento extra "mangia" dal totale BASE.
  // Ipotizziamo che l'allenamento extra sia Fondo Lento (pctFondo).
  if(runsCount > 1 && isExtraDay) {
      // In realtÃ , questo calcolo deve essere fatto nel generatore,
      // qui dobbiamo solo distribuire il volume che ci viene dato.

      // Se NON Ã¨ l'allenamento extra, il volume da distribuire Ã¨ base.
      // Se Ãˆ l'allenamento extra, il volume viene gestito direttamente da factor=0.5.
  }

Â  const longKm=baseKm*pctLungo, longAsc=baseAsc*pctLungo;
Â  const qualKm=baseKm*pctQuality, qualAsc=baseAsc*pctQuality;
Â  
  // Distribuzione Fondo solo sul volume residuo diviso per il numero di allenamenti di Fondo standard
Â  const numStandardFondo=Math.max(0,Math.round((runsCount - (isExtraDay?1:0)) * pctFondo) || 1); 
Â  const fondoKm=baseKm*pctFondo/(numStandardFondo), fondoAsc=baseAsc*pctFondo/(numStandardFondo);
  
  
Â  let dist=0,asc=0;
Â  if(/Lungo/i.test(type)){ dist=longKm; asc=longAsc; }
Â  else if(/Ripetute|Progressivo|Fartlek/.test(type)){ dist=qualKm; asc=qualAsc; }
Â  else { dist=fondoKm; asc=fondoAsc; }

  // Applica il fattore di riduzione (per l'allenamento extra)
  if (isExtraDay) {
      // Il volume dell'extra Ã¨ fisso, diciamo il 10% del totale BASE, moltiplicato per 0.5 di riduzione.
      // Semplifichiamo prendendo il volume Fondo e moltiplicandolo per il fattore di riduzione
      // Questo rende l'extra un allenamento corto.
      dist = baseKm * pctFondo * 0.5;
      asc = baseAsc * pctFondo * 0.5;
  } else {
      // Per gli allenamenti standard, applichiamo il volume calcolato sopra.
      // Aggiungiamo un toFixed per evitare numeri troppo piccoli se runsCount Ã¨ alto
      dist = +dist.toFixed(2);
      asc = +asc.toFixed(2);
  }


Â  const dur=dist*paceByLevel(livello);
Â  let det="";
Â  if(/Ripetute/.test(type)) det=`${Math.min(12,Math.max(4,Math.round(dist)))}Ã—400 m in salita, rec. 90â€“120s`;
Â  else if(/Progressivo/.test(type)) det=`Progressivo: aumenta ritmo negli ultimi km`;
Â  else if(/Lungo/.test(type)) det=`Lungo trail: endurance e gestione salita`;
Â  else det=`Fondo lento: ritmo facile, resistenza base`;
Â  return {distance:+dist.toFixed(1), ascent:Math.round(asc), durationMin:Math.round(dur), detailText:det};
}

// === GENERAZIONE PIANO ===
function generaPiano(){
Â  const livello=document.getElementById("livello").value;
Â  const obbKm=+document.getElementById("obbKm").value;
Â  const obbAsc=+document.getElementById("obbAsc").value;
Â  const settimane=+document.getElementById("settimane").value;
Â  const allenTot=parseFloat(document.getElementById("allenTot").value)||4;
Â  const giorniPalestra=[...document.querySelectorAll(".chk-btn.active")].map(b=>b.dataset.day);

Â  if (obbKm <= 0 || obbAsc <= 0) { alert("Inserisci KM e Dislivello validi!"); return; }

Â  const plan=[];Â 
Â  const progressioni=[0.6,0.7,0.8,0.85,0.9,0.95,1.0];
Â  for(let w=1;w<=settimane;w++){
Â  Â  const coeff=progressioni[Math.min(progressioni.length-1,Math.floor((w-1)/Math.max(1,settimane/progressioni.length)))];
Â  Â  const isScarico = (w===settimane-1);
    
    // Calcola i giorni di corsa e il giorno extra
Â  Â  const { runDays, extraRunDay, isExtraWeek } = selectRunDays(allenTot, giorniPalestra, settimane, w-1);
Â  Â  const runsCountStandard = runDays.length - (extraRunDay ? 1 : 0);

    // Calcola il coefficiente di volume extra
    let extraVolumeFactor = 0;
    if (extraRunDay) {
        // Se c'Ã¨ un giorno extra, aggiunge 0.5 al fattore di volume totale della settimana
        // 0.5 Ã¨ il fattore che usiamo per la corsa extra
        extraVolumeFactor = 0.5;
    }

    // Il volume BASE Ã¨ il coefficiente di progressione
Â  Â  const baseKm = obbKm * coeff * (isScarico?0.7:1);
Â  Â  const baseAsc = obbAsc * coeff * (isScarico?0.7:1);
    
    // Volume Totale Settimanale = Volume Base * (1 + (Extra Volume Factor / Allenamenti Standard))
    // Per semplificare, usiamo il volume BASE per gli allenamenti standard e aggiungiamo l'extra.
    // Il target visualizzato deve includere l'extra.

    // Nel rendering, usiamo il target teorico (progressione)
    const weekKm = +baseKm.toFixed(1);
    const weekAsc = Math.round(baseAsc);


Â  Â  const settimana=[];
Â  Â  let totalWeeklyKm = 0; // Inizializza il totale effettivo
    let totalWeeklyAsc = 0;

Â  Â  for(const day of GIORNI){
Â  Â  Â  if(giorniPalestra.includes(day)){
Â  Â  Â  Â  settimana.push({day,type:"Palestra",summary:"ğŸ‹ï¸ Palestra",completed:false});
Â  Â  Â  } else if(runDays.includes(day)){
Â  Â  Â  Â  let type="";
        let factor = 1;
        const isCurrentDayExtra = day === extraRunDay;

        // Gestione Allenamento Extra (Fondo Lento a volume ridotto)
        if (isCurrentDayExtra) {
            type = "Fondo lento";
            // L'allenamento extra Ã¨ un fondo lento a 0.5 del volume Fondo standard
            factor = 0.5; 
        } 
        // Logica Allenamenti Standard
        else if(day==="Sabato"||day==="Domenica") {
            type="Lungo trail";
        } else if(settimana.filter(x=>/Ripetute|Progressivo|Fartlek/.test(x.type)).length===0) {
            type="Ripetute collinari";
        } else {
            type="Fondo lento";
        }

Â  Â  Â  Â  // Passiamo a creaDettagliAllenamento il volume BASE e gli indichiamo se Ã¨ l'extra
Â  Â  Â  Â  const det=creaDettagliAllenamento(type, baseKm, baseAsc, runsCountStandard, livello, factor, isCurrentDayExtra);
        let summaryText = `ğŸƒ ${type} â€” ${det.distance} km`;
        if (isCurrentDayExtra) summaryText += " (Extra)";

        // Aggiorna il totale settimanale EFFETTIVO
        totalWeeklyKm += det.distance;
        totalWeeklyAsc += det.ascent;

Â  Â  Â  Â  settimana.push({day,type,summary:summaryText,details:det,completed:false});
Â  Â  Â  } else {
Â  Â  Â  Â  settimana.push({day,type:"Riposo",summary:"Riposo"});
Â  Â  Â  }
Â  Â  }
    
    // Nel piano, mostriamo il totale EFFETTIVO calcolato
Â  Â  plan.push({settimana:w,targetKm:+totalWeeklyKm.toFixed(1),targetAsc:Math.round(totalWeeklyAsc),allenamenti:settimana,isScarico});
Â  }
Â  STATE={settings:{livello,obbKm,obbAsc,settimane,allenTot,giorniPalestra},planData:plan};
Â  saveState();
Â  renderPiano();
}

// === RENDERING PIANO (senza modifiche) ===
function renderPiano(){
Â  const c=document.getElementById("planView");
Â  if(!STATE.planData?.length){ c.textContent="Nessun piano ancora generato."; return; }
Â  c.innerHTML="";
Â  STATE.planData.forEach(w=>{
Â  Â  const wd=document.createElement("div"); wd.className="week";
Â  Â  const h=document.createElement("h3");
Â  Â  h.textContent=`ğŸ“… Settimana ${w.settimana} â€” ${w.targetKm} km / +${w.targetAsc} m ${w.isScarico?"(Scarico)":""}`;
Â  Â  wd.appendChild(h);
Â  Â  const days=document.createElement("div"); days.className="days";

Â  Â  w.allenamenti.forEach(a=>{
Â  Â  Â  const d=document.createElement("div"); d.className="day";
Â  Â  Â  const s=document.createElement("div");
Â  Â  Â  s.innerHTML=`<strong>${a.day}</strong> â€” ${a.summary}`;
Â  Â  Â  const detBtn=document.createElement("button"); detBtn.className="small-btn"; detBtn.textContent="Dettagli";
Â  Â  Â  const fileBtn=document.createElement("button"); fileBtn.className="small-btn"; fileBtn.textContent="Carica GPX";
Â  Â  Â  s.appendChild(detBtn); s.appendChild(fileBtn);
Â  Â  Â  d.appendChild(s);
Â  Â  Â  const det=document.createElement("div"); det.className="detail"; det.style.display="none";
Â  Â  Â  if(a.details){
Â  Â  Â  Â  det.innerHTML=`<div><em>${a.details.detailText}</em></div>
Â  Â  Â  Â  Â  <div class="muted">Obiettivo: ${a.details.distance} km â€¢ +${a.details.ascent} m â€¢ ${a.details.durationMin} min</div>`;
Â  Â  Â  }
Â  Â  Â  detBtn.onclick=()=>{det.style.display=det.style.display==="none"?"block":"none";};
Â  Â  Â  fileBtn.onclick=()=>{uploadGPX(a);};
Â  Â  Â  d.appendChild(det);
Â  Â  Â  days.appendChild(d);
Â  Â  });
Â  Â  wd.appendChild(days);
Â  Â  h.onclick=()=>{days.style.display=days.style.display==="block"?"none":"block";};
Â  Â  c.appendChild(wd);
Â  });
}

// === GPX UPLOAD (senza modifiche) ===
function uploadGPX(activity){
Â  const input=document.getElementById("hiddenFileInput");
Â  input.onchange=(e)=>{
Â  Â  const file=e.target.files[0];
Â  Â  if(!file) return;
Â  Â  const reader=new FileReader();
Â  Â  reader.onload=()=>{
Â  Â  Â  const text=reader.result;
Â  Â  Â  const parser=new DOMParser();
Â  Â  Â  const xml=parser.parseFromString(text,"application/xml");
Â  Â  Â  const trkpts=xml.getElementsByTagName("trkpt");
Â  Â  Â  if(!trkpts.length){ alert("File GPX non valido"); return; }

Â  Â  Â  let dist=0, asc=0, prev=null;
Â  Â  Â  for(const p of trkpts){
Â  Â  Â  Â  const lat=parseFloat(p.getAttribute("lat"));
Â  Â  Â  Â  const lon=parseFloat(p.getAttribute("lon"));
Â  Â  Â  Â  const ele=parseFloat(p.getElementsByTagName("ele")[0]?.textContent||0);
Â  Â  Â  Â  if(prev){
Â  Â  Â  Â  Â  const R=6371000;
Â  Â  Â  Â  Â  const dLat=(lat-prev.lat)*Math.PI/180, dLon=(lon-prev.lon)*Math.PI/180;
Â  Â  Â  Â  Â  const a=Math.sin(dLat/2)**2+Math.cos(lat*Math.PI/180)*Math.cos(prev.lat*Math.PI/180)*Math.sin(dLon/2)**2;
Â  Â  Â  Â  Â  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
Â  Â  Â  Â  Â  dist+=R*c;
Â  Â  Â  Â  Â  const diff=ele-prev.ele; if(diff>0) asc+=diff;
Â  Â  Â  Â  }
Â  Â  Â  Â  prev={lat,lon,ele};
Â  Â  Â  }
Â  Â  Â  const km=(dist/1000).toFixed(1);
Â  Â  Â  const ascM=Math.round(asc);
Â  Â  Â  alert(`ğŸ“ˆ File GPX caricato: ${km} km â€¢ +${ascM} m`);
Â  Â  };
Â  Â  reader.readAsText(file);
Â  };
Â  input.click();
}

// === EVENTI ===
document.getElementById("genLocal").onclick=generaPiano;
document.getElementById("resetData").onclick=()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); };

loadState();
if(STATE.planData?.length) renderPiano();
</script>
</body>
</html>
