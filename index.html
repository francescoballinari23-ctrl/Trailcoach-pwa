<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v11 (fit + gpx robust)</title>
<meta name="theme-color" content="#000000">
<style>
  :root{--card-radius:12px;}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;}
  h1{text-align:center;font-size:22px;margin:6px 0;}
  .card{background:#fff;border-radius:var(--card-radius);padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.06);}
  label{display:block;margin:8px 0 6px;font-weight:600;}
  input[type="number"], select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box;}
  button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:8px;cursor:pointer;}
  button.reset{background:#ff3b30;margin-left:8px;}
  .week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
  .week h3{margin:0;cursor:pointer;font-size:17px;display:flex;justify-content:space-between;align-items:center;}
  .days{margin-top:6px;padding-left:10px;display:none;}
  .days .day{padding:6px 0;border-bottom:1px solid #eee;}
  .small{font-size:13px;color:#666;margin-top:6px;}
  .toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:6px 10px;font-size:13px;margin-top:-4px;}
  .checkbox-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;}
  .checkbox-grid-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;}
  .chk-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;background:#f2f2f2;cursor:pointer;border:1px solid transparent;font-weight:700;}
  .chk-btn.active{background:#007aff;color:#fff;border-color:#0060d6;}
  .detail{background:#fff;border-radius:8px;padding:10px;margin:6px 0 10px;border:1px solid #eee;font-size:14px;}
  .muted{color:#666;font-size:13px;}
  .fileline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
  .meta{font-size:13px;color:#333;margin-top:6px;}
  .alert{background:#fff3cd;border:1px solid #ffeeba;padding:8px;border-radius:8px;margin-top:8px;color:#856404;}
  a.guide{color:#0060d6;text-decoration:underline;}
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v11</h1>

<div class="card" id="topSummaryCard" style="display:none;">
  <div id="summaryText" class="muted"></div>
</div>

<div class="card" id="settingsCard">
  <div>
    <span style="font-weight:600;">‚öôÔ∏è Impostazioni</span>
    <button id="toggleSettings" class="toggle-btn" aria-expanded="true">Nascondi</button>
  </div>
  <div id="settingsContent">
    <label>Livello atleta</label>
    <select id="livello">
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzato">Avanzato</option>
    </select>

    <label>Obiettivo distanza gara (km)</label>
    <input id="obbKm" type="number" placeholder="es. 20" />

    <label>Obiettivo dislivello gara (m)</label>
    <input id="obbAsc" type="number" placeholder="es. 1000" />

    <label>Durata piano (settimane)</label>
    <input id="settimane" type="number" value="8" min="1" max="52" />

    <label>Allenamenti totali a settimana</label>
    <input id="allenTot" type="number" value="4" min="2" max="7" step="0.5" />

    <label>Giorni palestra (toggle)</label>
    <div>
      <div class="checkbox-grid" id="palestraTop">
        <div class="chk-btn" data-day="Luned√¨">Lun</div>
        <div class="chk-btn" data-day="Marted√¨">Mar</div>
        <div class="chk-btn" data-day="Mercoled√¨">Mer</div>
      </div>
      <div class="checkbox-grid-bottom" id="palestraBottom">
        <div class="chk-btn" data-day="Gioved√¨">Gio</div>
        <div class="chk-btn" data-day="Venerd√¨">Ven</div>
        <div class="chk-btn" data-day="Sabato">Sab</div>
        <div class="chk-btn" data-day="Domenica">Dom</div>
      </div>
    </div>

    <div style="margin-top:8px;">
      <button id="genLocal" class="save">‚öôÔ∏è Genera piano</button>
      <button id="resetData" class="reset">üóëÔ∏è Reset dati</button>
    </div>
    <div class="alert" id="fitHint" style="display:none;">
      Se il tuo file .fit non viene letto correttamente (es. file Zepp/Amazfit), prova ad esportarlo in <strong>GPX</strong> dall'app Zepp e caricarlo (.gpx) ‚Äî oppure usa un convertitore online come <a class="guide" href="https://www.gpsvisualizer.com/convert_input" target="_blank">GPSVisualizer</a>.
    </div>
  </div>
</div>

<div class="card">
  <label>Avanzamento</label>
  <canvas id="progressChart" width="360" height="140"></canvas>
  <div id="chartText" class="small"></div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView" class="small">Nessun piano ancora generato.</div>
</div>

<div class="card">
  <label>Storico allenamenti</label>
  <div id="historyList" class="small">Nessun allenamento registrato.</div>
</div>

<input id="hiddenFileInput" type="file" accept=".fit,.gpx" style="display:none" />

<script src="https://unpkg.com/fit-file-parser@1.21.0/dist/fit-file-parser.min.js"></script>
<script>
const STORAGE_KEY = "trailcoach_v11_state";
const DEFAULT_STATE = {
  settings: { livello:"principiante", obbKm:20, obbAsc:1000, settimane:8, allenTot:4, giorniPalestra:[] },
  planData: [],
  progress: { km:0, ascent:0 },
  history: []
};
let STATE = JSON.parse(JSON.stringify(DEFAULT_STATE));
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ try{ STATE = JSON.parse(raw); }catch(e){ console.warn("loadState parse error", e); } } }

const GIORNI = ["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
function paceByLevel(lvl){ return lvl==="principiante"?6 : lvl==="intermedio"?5.5 : 5; }
function formatTime(mins){ const h=Math.floor(mins/60); const m=Math.round(mins%60); return h>0?`${h}h ${m}m`:`${m}m`; }

// ------------------- Funzioni core -------------------
function selectRunDays(allenTot, giorniPalestra, weekNumber){
  const freeDays = GIORNI.filter(d => !giorniPalestra.includes(d));
  const baseRuns = Math.floor(allenTot - giorniPalestra.length);
  const halfRun = (allenTot - giorniPalestra.length) - baseRuns;
  const extraRun = (halfRun > 0 && weekNumber % 2 === 1) ? 1 : 0; 
  const totalRunsThisWeek = baseRuns + extraRun;

  const selected = [];
  if(totalRunsThisWeek >= freeDays.length){
    selected.push(...freeDays);
  } else {
    const step = freeDays.length / totalRunsThisWeek;
    for(let i=0;i<totalRunsThisWeek;i++){
      const idx = Math.floor(i*step + step/2);
      selected.push(freeDays[idx]);
    }
  }
  return selected;
}

function tipoAllenamentoForIndex(i,runsCount,day){
  if(runsCount===1) return "Lungo trail";
  if(day==="Sabato" || day==="Domenica") return "Lungo trail";
  const types=["Ripetute","Progressivo","Medio costante","Fartlek","Fondo lento"];
  return types[i % types.length];
}

function creaDettagliAllenamento(type, weeklyKm, weeklyAsc, runsCount, indexRun, livello, isScarico){
  let dist, asc;
  const basePace = paceByLevel(livello);

  if(type==="Lungo trail"){ dist=weeklyKm*0.55; asc=weeklyAsc*0.55; }
  else if(["Medio costante","Fartlek","Progressivo","Ripetute"].includes(type)){
    const remainingKm = weeklyKm*0.45;
    const remainingAsc = weeklyAsc*0.45;
    const runsOther = runsCount-1;
    const fraction = runsOther>0 ? 1/runsOther : 1;
    dist = remainingKm*fraction;
    asc = remainingAsc*fraction;
  } else { dist=weeklyKm*0.3/runsCount; asc=weeklyAsc*0.3/runsCount; }

  if(isScarico){ dist*=0.7; asc*=0.7; }
  const durationMin = dist*basePace;

  let details="";
  if(type.includes("Ripetute")) details=`${Math.min(12, Math.max(4, Math.round(dist)))}√ó400 m in salita, recupero 90‚Äì120s`;
  else if(type.includes("Progressivo")) details="Progressivo: aumenta ritmo negli ultimi km";
  else if(type.includes("Medio")) details=`Medio: ${Math.max(4,Math.round(dist*0.6))} km a ritmo sostenuto`;
  else if(type.includes("Lungo")) details="Lungo: ritmo lento, endurance";
  else if(type.includes("Fartlek")) details="Fartlek: alternare 2‚Äì3' veloce / 2' lento";
  else details="Ritmo facile, tecnica e recupero";

  return { distance:+dist.toFixed(1), ascent:Math.round(asc), durationMin:Math.round(durationMin), detailText:details };
}

// ------------------- Genera piano settimanale -------------------
function generaPiano(settings){
  const plan=[];
  const settimane=settings.settimane;
  const totaleKm=settings.obbKm;
  const totaleAsc=settings.obbAsc;

  for(let w=1; w<=settimane; w++){
    const isScarico=(w===settimane);
    const scaricoFactor=isScarico?0.7:1;
    const progFactor=0.4 + 0.6*((w-1)/(settimane-1)); // progressione 40%-100%
    const targetKm=+(totaleKm*progFactor*scaricoFactor).toFixed(1);
    const targetAsc=Math.round(totaleAsc*progFactor*scaricoFactor);

    // selezione giorni corsa considerando mezzi allenamenti
    const runDays=selectRunDays(settings.allenTot,settings.giorniPalestra,w);
    const runsCount=runDays.length||1;
    const settimanaArr=[];
    let runIndex=0;

    for(const day of GIORNI){
      if(settings.giorniPalestra.includes(day)){
        settimanaArr.push({day,type:"Palestra",summary:"üèãÔ∏è Palestra",details:{note:"Forza & Core"},uploaded:null,completed:false});
      } else if(runDays.includes(day)){
        const type=tipoAllenamentoForIndex(runIndex,runsCount,day);
        const det=creaDettagliAllenamento(type,targetKm,targetAsc,runsCount,runIndex,settings.livello,isScarico);
        settimanaArr.push({day,type:"Corsa",summary:`üèÉ ${type} ‚Äî ${det.distance} km`,details:det,uploaded:null,completed:false});
        runIndex++;
      } else {
        settimanaArr.push({day,type:"Riposo",summary:"Riposo",details:{note:"Recupero"},uploaded:null,completed:false});
      }
    }

    plan.push({settimana:w,targetKm,targetAsc,isScarico,allenamenti:settimanaArr,completato:false});
  }

  STATE.settings=settings;
  STATE.planData=plan;
  saveState();
  renderAll();
}

// ------------------- Render piano settimanale -------------------
function renderPiano(){
  const container=document.getElementById("planView");
  container.innerHTML="";
  if(!STATE.planData || STATE.planData.length===0){
    container.textContent="Nessun piano ancora generato.";
    return;
  }

  STATE.planData.forEach((week, weekIndex)=>{
    const weekDiv=document.createElement("div");
    weekDiv.className="week";

    const header=document.createElement("h3");
    header.textContent=`üìÖ Settimana ${week.settimana} ‚Äì Target: ${week.targetKm} km / +${week.targetAsc} m ${week.isScarico ? "‚Äî Scarico" : ""}`;
    header.style.cursor="pointer";

    const daysDiv=document.createElement("div");
    daysDiv.className="days";
    daysDiv.style.display="none";

    header.onclick=()=>{ daysDiv.style.display=daysDiv.style.display==="none"?"block":"none"; };

    week.allenamenti.forEach((a,dayIndex)=>{
      const dayDiv=document.createElement("div");
      dayDiv.className="day";

      const summaryDiv=document.createElement("div");
      summaryDiv.innerHTML=`<strong>${a.day}</strong> ‚Äî ${a.summary}`;
      summaryDiv.style.display="flex";
      summaryDiv.style.justifyContent="space-between";
      summaryDiv.style.alignItems="center";

      const openBtn=document.createElement("button");
      openBtn.textContent="Dettagli";
      openBtn.style.fontSize="13px";
      summaryDiv.appendChild(openBtn);

      dayDiv.appendChild(summaryDiv);

      const detailBox=document.createElement("div");
      detailBox.className="detail";
      detailBox.style.display="none";

      if(a.type==="Corsa" && a.details){
        detailBox.innerHTML=`
          <div><strong>${a.summary.split("‚Äî")[0].trim()}</strong></div>
          <div class="muted">Obiettivo: ${a.details.distance} km ‚Äî +${a.details.ascent} m ‚Äî ${formatTime(a.details.durationMin)}</div>
          <div style="margin-top:8px;"><em>${a.details.detailText}</em></div>
        `;
      } else if(a.type==="Palestra"){
        detailBox.innerHTML=`<div><strong>Palestra</strong></div><div class="muted">Forza & Core ‚Äî esercizi consigliati</div>`;
      } else {
        detailBox.innerHTML=`<div><strong>Riposo</strong></div><div class="muted">Recupero attivo consigliato</div>`;
      }

      openBtn.onclick=()=>{ detailBox.style.display=detailBox.style.display==="none"?"block":"none"; };

      dayDiv.appendChild(detailBox);
      daysDiv.appendChild(dayDiv);
    });

    weekDiv.appendChild(header);
    weekDiv.appendChild(daysDiv);
    container.appendChild(weekDiv);
  });
}

// ------------------- Utility render -------------------
function renderAll(){
  renderPlan();
}

// ------------------- Eventi UI -------------------
document.getElementById("genLocal").onclick=()=>{
  const settings={
    livello:document.getElementById("livello").value,
    obbKm:parseFloat(document.getElementById("obbKm").value),
    obbAsc:parseInt(document.getElementById("obbAsc").value),
    settimane:parseInt(document.getElementById("settimane").value),
    allenTot:parseFloat(document.getElementById("allenTot").value),
    giorniPalestra:Array.from(document.querySelectorAll(".chk-btn.active")).map(el=>el.dataset.day)
  };
  generaPiano(settings);
};

document.querySelectorAll(".chk-btn").forEach(btn=>{
  btn.onclick=()=>btn.classList.toggle("active");
});

document.getElementById("resetData").onclick=()=>{
  STATE=JSON.parse(JSON.stringify(DEFAULT_STATE));
  saveState();
  renderAll();
};

loadState();
renderAll();
</script>
</body>
</html>