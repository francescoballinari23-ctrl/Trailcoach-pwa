<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>üèîÔ∏è TrailCoach AI v17.0 ‚Äî Impostazioni + Calcolo corretto</title>
<meta name="theme-color" content="#000000">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    background:#fafafa; color:#111; margin:12px;
  }
  h1 { text-align:center; font-size:22px; margin:6px 0; }
  .card {
    background:#fff; border-radius:10px; padding:12px; margin:10px 0;
    box-shadow:0 1px 6px rgba(0,0,0,.06);
  }
  label { display:block; margin:8px 0 6px; font-weight:600; }
  input, select {
    width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;
    font-size:15px; box-sizing:border-box;
  }
  button {
    background:#007aff; color:#fff; border:none; padding:9px 14px;
    border-radius:8px; font-weight:600; cursor:pointer; font-size:14px;
  }
  button:hover { background:#005fd6; }
  button.reset { background:#ff3b30; margin-left:6px; }
  .week { background:#f7f9ff; border-radius:8px; margin:8px 0; padding:8px 10px; }
  .days { margin-top:6px; padding-left:10px; display:none; }
  .day { padding:6px 0; border-bottom:1px solid #eee; }
  .detail { background:#fff; border-radius:8px; padding:10px; margin-top:6px; border:1px solid #eee; }
  .chk-btn {
    background:#f2f2f2; border-radius:8px; padding:8px; text-align:center;
    cursor:pointer; border:1px solid transparent; font-weight:700;
  }
  .chk-btn.active { background:#007aff; color:#fff; border-color:#0060d6; }
  .checkbox-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:6px; }
  .checkbox-grid-bottom { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
  .muted { color:#666; font-size:13px; }
  button.small-btn {
    background:#eee; color:#007aff; border:1px solid #007aff;
    padding:6px 10px; font-size:13px; border-radius:8px; margin-left:8px;
  }
  button.small-btn:hover { background:#f0f6ff; }
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v17.0</h1>

<div style="text-align:center; margin-bottom:8px;">
  <button id="toggleSettings" style="display:none; background:#34c759;">‚öôÔ∏è Impostazioni</button>
</div>

<div class="card" id="settingsCard">
  <label>Livello atleta</label>
  <select id="livello">
    <option value="principiante">Principiante</option>
    <option value="intermedio">Intermedio</option>
    <option value="avanzato">Avanzato</option>
  </select>

  <label>Obiettivo distanza gara (km)</label>
  <input id="obbKm" type="number" value="42" />

  <label>Obiettivo dislivello gara (m)</label>
  <input id="obbAsc" type="number" value="2000" />

  <label>Durata piano (settimane)</label>
  <input id="settimane" type="number" value="12" min="1" max="52" />

  <label>Allenamenti totali a settimana (es. 4.5)</label>
  <input id="allenTot" type="number" step="0.5" value="4.5" min="2" max="7" />

  <label>Giorni palestra</label>
  <div class="checkbox-grid">
    <div class="chk-btn" data-day="Luned√¨">Lun</div>
    <div class="chk-btn" data-day="Marted√¨">Mar</div>
    <div class="chk-btn" data-day="Mercoled√¨">Mer</div>
  </div>
  <div class="checkbox-grid-bottom">
    <div class="chk-btn" data-day="Gioved√¨">Gio</div>
    <div class="chk-btn" data-day="Venerd√¨">Ven</div>
    <div class="chk-btn" data-day="Sabato">Sab</div>
    <div class="chk-btn" data-day="Domenica">Dom</div>
  </div>

  <div style="margin-top:10px;">
    <button id="genLocal">‚öôÔ∏è Genera piano</button>
    <button id="genAI">ü§ñ Genera con AI</button>
    <button id="resetData" class="reset">üóëÔ∏è Reset</button>
  </div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView" class="muted">Nessun piano ancora generato.</div>
</div>

<input id="hiddenFileInput" type="file" accept=".gpx" style="display:none" />

<script>
const STORAGE_KEY="trailcoach_v17";
let STATE={settings:{},planData:[]};
const GIORNI=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
function paceByLevel(l){return l==="principiante"?6.2:l==="intermedio"?5.8:5.4;}
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE));}
function loadState(){const r=localStorage.getItem(STORAGE_KEY);if(r)STATE=JSON.parse(r);}

document.getElementById("settingsCard").addEventListener("click",e=>{
  if(e.target.classList.contains("chk-btn")) e.target.classList.toggle("active");
});

document.getElementById("toggleSettings").onclick=()=>{
  const card=document.getElementById("settingsCard");
  card.style.display=card.style.display==="none"?"block":"none";
};

function selectRunDays(allenTot,giorniPalestra,weekIndex){
  const full=Math.floor(allenTot);
  const free=GIORNI.filter(d=>!giorniPalestra.includes(d));
  const runSlots=Math.min(full,free.length);
  const selected=[];
  const step=free.length/runSlots;
  for(let i=0;i<runSlots;i++) selected.push(free[Math.floor(i*step)]);
  let extraRunDay=null;
  const isExtraWeek=allenTot%1>=0.4&&(weekIndex+1)%2===0;
  if(isExtraWeek && selected.length<free.length){
    extraRunDay=free.find(d=>!selected.includes(d));
    if(extraRunDay) selected.push(extraRunDay);
  }
  return{runDays:selected,extraRunDay,isExtraWeek};
}

function creaDettagliAllenamento(type,weeklyKm,weeklyAsc,runsCount,livello,isExtra=false){
  const longPct=0.55, speedPct=0.25, fondoPct=0.20;
  const baseKm=weeklyKm, baseAsc=weeklyAsc;
  const longKm=baseKm*longPct, longAsc=baseAsc*longPct;
  const qualKm=baseKm*speedPct, qualAsc=baseAsc*speedPct;
  const fondoKm=(baseKm*fondoPct)/Math.max(1,runsCount-2), fondoAsc=(baseAsc*fondoPct)/Math.max(1,runsCount-2);
  let dist,asc;
  if(/Lungo/i.test(type)){dist=longKm;asc=longAsc;}
  else if(/Ripetute|Progressivo|Fartlek/.test(type)){dist=qualKm;asc=qualAsc;}
  else{dist=fondoKm;asc=fondoAsc;}
  if(isExtra){dist*=0.5;asc*=0.5;}
  const dur=dist*paceByLevel(livello);
  let det="";
  if(/Ripetute/.test(type))det=`${Math.min(12,Math.max(4,Math.round(dist)))}√ó400 m in salita, rec. 90‚Äì120s`;
  else if(/Progressivo/.test(type))det=`Progressivo: aumenta ritmo negli ultimi km`;
  else if(/Lungo/.test(type))det=`Lungo trail: endurance e gestione salita`;
  else det=`Fondo lento: ritmo facile, resistenza base`;
  return{distance:+dist.toFixed(1),ascent:Math.round(asc),durationMin:Math.round(dur),detailText:det,gpx:null};
}

function generaPiano(){
  const livello=document.getElementById("livello").value;
  const obbKm=+document.getElementById("obbKm").value;
  const obbAsc=+document.getElementById("obbAsc").value;
  const settimane=+document.getElementById("settimane").value;
  const allenTot=parseFloat(document.getElementById("allenTot").value)||4;
  const giorniPalestra=[...document.querySelectorAll(".chk-btn.active")].map(b=>b.dataset.day);

  if(obbKm<=0||obbAsc<=0){alert("Inserisci valori validi!");return;}

  const plan=[]; const progressioni=[0.6,0.7,0.8,0.9,1.0];
  for(let w=1;w<=settimane;w++){
    const coeff=progressioni[Math.min(progressioni.length-1,Math.floor((w-1)/Math.max(1,settimane/progressioni.length)))];
    const isScarico=(w%4===0);
    const baseKm=obbKm*coeff*(isScarico?0.7:1);
    const baseAsc=obbAsc*coeff*(isScarico?0.7:1);
    const {runDays,extraRunDay}=selectRunDays(allenTot,giorniPalestra,w-1);
    const runsCount=runDays.length;

    const settimana=[]; let totalKm=0,totalAsc=0;
    for(const day of GIORNI){
      if(giorniPalestra.includes(day)){
        settimana.push({day,type:"Palestra",summary:"üèãÔ∏è Palestra",details:{detailText:"Forza & Core"}});
      } else if(runDays.includes(day)){
        let type=""; const isExtra=(day===extraRunDay);
        if(day==="Sabato"||day==="Domenica")type="Lungo trail";
        else if(settimana.filter(x=>/Ripetute|Progressivo|Fartlek/.test(x.type)).length===0)type="Ripetute collinari";
        else type="Fondo lento";
        const det=creaDettagliAllenamento(type,baseKm,baseAsc,runsCount,livello,isExtra);
        totalKm+=det.distance; totalAsc+=det.ascent;
        settimana.push({day,type,summary:`üèÉ ${type} ‚Äî ${det.distance} km`,details:det});
      } else settimana.push({day,type:"Riposo",summary:"Riposo",details:{detailText:"Recupero"}});
    }
    plan.push({settimana:w,targetKm:+totalKm.toFixed(1),targetAsc:Math.round(totalAsc),allenamenti:settimana,isScarico});
  }

  STATE={settings:{livello,obbKm,obbAsc,settimane,allenTot,giorniPalestra},planData:plan};
  saveState();
  document.getElementById("settingsCard").style.display="none";
  document.getElementById("toggleSettings").style.display="inline-block";
  renderPiano();
}

function renderPiano(){
  const c=document.getElementById("planView");
  if(!STATE.planData?.length){c.textContent="Nessun piano ancora generato.";return;}
  c.innerHTML="";
  STATE.planData.forEach(w=>{
    const wd=document.createElement("div"); wd.className="week";
    const h=document.createElement("h3");
    h.textContent=`üìÖ Settimana ${w.settimana} ‚Äî ${w.targetKm} km / +${w.targetAsc} m ${w.isScarico?"(Scarico)":""}`;
    wd.appendChild(h);
    const days=document.createElement("div"); days.className="days";

    w.allenamenti.forEach((a,idx)=>{
      const d=document.createElement("div"); d.className="day";
      const s=document.createElement("div");
      s.innerHTML=`<strong>${a.day}</strong> ‚Äî ${a.summary}`;
      if(a.type!=="Riposo"){
        const detBtn=document.createElement("button"); detBtn.className="small-btn"; detBtn.textContent="Dettagli";
        detBtn.onclick=()=>{det.style.display=det.style.display==="none"?"block":"none";};
        s.appendChild(detBtn);
        if(a.details?.distance>0){
          const fileBtn=document.createElement("button"); fileBtn.className="small-btn"; fileBtn.textContent="Carica GPX";
          fileBtn.onclick=()=>uploadGPX(a,w.settimana,idx);
          s.appendChild(fileBtn);
        }
      }
      d.appendChild(s);
      const det=document.createElement("div"); det.className="detail"; det.style.display="none";
      if(a.details){
        let gpxTxt=a.details.gpx?`<div class="muted">üìà GPX caricato: ${a.details.gpx.km} km ‚Ä¢ +${a.details.gpx.asc} m</div>`:"";
        det.innerHTML=`<div><em>${a.details.detailText}</em></div>
        <div class="muted">Obiettivo: ${a.details.distance} km ‚Ä¢ +${a.details.ascent} m ‚Ä¢ ${a.details.durationMin} min</div>${gpxTxt}`;
      }
      d.appendChild(det);
      days.appendChild(d);
    });
    wd.appendChild(days);
    h.onclick=()=>{days.style.display=days.style.display==="block"?"none":"block";};
    c.appendChild(wd);
  });
}

function uploadGPX(activity,weekIdx,runIdx){
  const input=document.getElementById("hiddenFileInput");
  input.onchange=(e)=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=()=>{
      const xml=new DOMParser().parseFromString(reader.result,"application/xml");
      const pts=xml.getElementsByTagName("trkpt");
      if(!pts.length){alert("File GPX non valido");return;}
      let dist=0,asc=0,prev=null;
      for(const p of pts){
        const lat=parseFloat(p.getAttribute("lat"));
        const lon=parseFloat(p.getAttribute("lon"));
        const ele=parseFloat(p.getElementsByTagName("ele")[0]?.textContent||0);
        if(prev){
          const R=6371000;
          const dLat=(lat-prev.lat)*Math.PI/180, dLon=(lon-prev.lon)*Math.PI/180;
          const a=Math.sin(dLat/2)**2+Math.cos(lat*Math.PI/180)*Math.cos(prev.lat*Math.PI/180)*Math.sin(dLon/2)**2;
          const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
          dist+=R*c;
          const diff=ele-prev.ele;if(diff>0)asc+=diff;
        }
        prev={lat,lon,ele};
      }
      const km=(dist/1000).toFixed(1); const ascM=Math.round(asc);
      STATE.planData[weekIdx-1].allenamenti[runIdx].details.gpx={km,asc:ascM};
      saveState(); renderPiano();
    };
    reader.readAsText(file);
  };
  input.click();
}

// AI Stub ‚Äî per futura integrazione GPT
async function generatePlanAI(settings){
  console.log("ü§ñ In futuro qui chiameremo un modello AI con:",settings);
  // return fetch("/api/ai-plan", {method:"POST",body:JSON.stringify(settings)});
}

document.getElementById("genLocal").onclick=generaPiano;
document.getElementById("resetData").onclick=()=>{localStorage.removeItem(STORAGE_KEY);location.reload();};

loadState();
if(STATE.planData?.length){
  document.getElementById("settingsCard").style.display="none";
  document.getElementById("toggleSettings").style.display="inline-block";
  renderPiano();
}
</script>
<script>
async function generaPianoAI() {
  const livello = document.getElementById("livello").value;
  const obbKm = parseFloat(document.getElementById("obbKm").value);
  const obbAsc = parseFloat(document.getElementById("obbAsc").value);
  const allenTot = parseFloat(document.getElementById("allenTot").value);
  const settimane = parseInt(document.getElementById("settimane").value);
  const giorniPalestra = Array.from(document.querySelectorAll(".chk-btn.active"))
    .map(b => b.dataset.day);

  const container = document.getElementById("planView");
  container.innerHTML = "<p>‚è≥ Generazione piano AI in corso‚Ä¶</p>";

  try {
    // üîπ Chiama il tuo webhook Pipedream
    const response = await fetch("https://eoakctnc24hsvp9.m.pipedream.net", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        livello,
        km: obbKm,
        asc: obbAsc,
        allenTot,
        settimane,
        palestra: giorniPalestra
      })
    });

    if (!response.ok) throw new Error("Errore nella richiesta AI");
    const data = await response.json();

    // üîπ 1Ô∏è‚É£ Prendi il testo restituito dall‚ÄôAI (potrebbe essere un testo o un JSON)
    let testoAI = "";
    if (data.testo) testoAI = data.testo;
    else if (typeof data === "string") testoAI = data;
    else testoAI = JSON.stringify(data);

    // üîπ 2Ô∏è‚É£ Prova a estrarre un JSON leggibile (in caso GPT l‚Äôabbia inviato)
    let pianoAI = null;
    try {
      // Cerca blocchi tipo ```json ... ```
      const match = testoAI.match(/```json([\s\S]*?)```/);
      if (match) testoAI = match[1];
      pianoAI = JSON.parse(testoAI);
    } catch (e) {
      console.warn("‚ö†Ô∏è L'AI non ha restituito un JSON valido:", e);
    }

    // üîπ 3Ô∏è‚É£ Se il JSON contiene un piano compatibile, integralo nel rendering
    if (pianoAI && pianoAI.settimane) {
      // Adattamento struttura
      STATE = {
        settings: { livello, obbKm, obbAsc, settimane, allenTot, giorniPalestra },
        planData: pianoAI.settimane.map((sett, i) => ({
          settimana: i + 1,
          targetKm: sett.km_totali || 0,
          targetAsc: sett.asc_totale || 0,
          allenamenti: sett.giorni.map(g => ({
            day: g.giorno || g.nome || "Giorno",
            type: g.tipo || "Allenamento",
            summary: g.riassunto || `${g.tipo || "Allenamento"} - ${g.km || 0} km`,
            details: {
              detailText: g.descrizione || "Dettagli non forniti",
              distance: g.km || 0,
              ascent: g.asc || 0,
              durationMin: g.durata || 0
            }
          }))
        }))
      };
      saveState();
      document.getElementById("settingsCard").style.display = "none";
      document.getElementById("toggleSettings").style.display = "inline-block";
      renderPiano();
      return;
    }

    // üîπ 4Ô∏è‚É£ Se non c‚Äô√® JSON, mostra comunque il testo
    container.innerHTML = `
      <h3>üìä Risposta AI (testuale)</h3>
      <pre style="white-space:pre-wrap;">${testoAI}</pre>
      <p style="color:gray;">üí° Se vuoi che l‚ÄôAI generi un piano strutturato, assicurati che Pipedream chieda di rispondere in JSON.</p>
    `;

  } catch (err) {
    console.error(err);
    container.innerHTML = `<p style="color:red;">‚ùå Errore durante la generazione AI: ${err.message}</p>`;
  }
}

document.getElementById("genAI").addEventListener("click", generaPianoAI);
</script>
<!-- üîπ CONTENITORI per la risposta AI -->
<h2>Piano generato con AI</h2>
<div id="ai-output-raw" style="white-space: pre-wrap; background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px;"></div>
<div id="piano-generato"></div>

<script>
async function generaPianoAI() {
  const livello = document.getElementById("livello").value;
  const obbKm = parseFloat(document.getElementById("obbKm").value);
  const obbAsc = parseFloat(document.getElementById("obbAsc").value);
  const allenTot = parseFloat(document.getElementById("allenTot").value);
  const settimane = parseInt(document.getElementById("settimane").value);
  const giorniPalestra = Array.from(document.querySelectorAll(".chk-btn.active"))
    .map(b => b.dataset.day);

  const container = document.getElementById("planView");
  container.innerHTML = "<p>‚è≥ Generazione piano AI in corso‚Ä¶</p>";

  try {
    const response = await fetch("https://eoakctnc24hsvp9.m.pipedream.net", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        livello,
        km: obbKm,
        asc: obbAsc,
        allenTot,
        settimane,
        palestra: giorniPalestra
      })
    });

    if (!response.ok) throw new Error("Errore nella richiesta AI");
    const text = await response.text();

    // üîç Estrae la parte JSON (tra la prima e ultima graffa)
    const match = text.match(/{[\s\S]*}/);
    if (!match) throw new Error("Nessun JSON trovato nella risposta AI");

    const jsonString = match[0]
      .replace(/\\n/g, "")
      .replace(/```json/g, "")
      .replace(/```/g, "")
      .trim();

    let data;
    try {
      data = JSON.parse(jsonString);
    } catch (err) {
      console.error("Errore nel parsing JSON:", err);
      container.innerHTML = `<pre>${jsonString}</pre>`;
      return;
    }

    // ‚úÖ Costruisce layout in stile piano locale
    let html = `<h3>üìä Piano AI ‚Äî ${data.descrizione_generale || "Descrizione non disponibile"}</h3>`;

    data.settimane.forEach(sett => {
      html += `
        <div class="week">
          <h3 class="accordion">üìÖ Settimana ${sett.numero} ‚Äî ${sett.focus || ""}</h3>
          <div class="days panel">
            ${sett.allenamenti.map(a => `
              <div class="day">
                <div><strong>${a.tipo}</strong> ‚Äî ${a.km} km</div>
                <div class="muted">${a.dettagli}</div>
              </div>
            `).join("")}
          </div>
        </div>`;
    });

    container.innerHTML = html;

    // üéõÔ∏è Accordion interattivo
    document.querySelectorAll(".accordion").forEach(btn => {
      btn.addEventListener("click", function() {
        this.classList.toggle("active");
        const panel = this.nextElementSibling;
        panel.style.display = panel.style.display === "block" ? "none" : "block";
      });
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<p style="color:red;">‚ùå Errore durante la generazione AI: ${err.message}</p>`;
  }
}
</script>

<style>
  #piano-generato {
    font-family: system-ui, sans-serif;
    margin-top: 20px;
  }

  .descrizione {
    background: #eef8ff;
    padding: 10px;
    border-radius: 8px;
  }

  .accordion {
    background-color: #2a5d84;
    color: white;
    cursor: pointer;
    padding: 12px;
    width: 100%;
    text-align: left;
    border: none;
    outline: none;
    transition: background-color 0.2s ease;
    border-radius: 6px;
    margin-top: 10px;
  }

  .accordion.active, .accordion:hover {
    background-color: #357ca0;
  }

  .panel {
    background-color: #f8f8f8;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
    max-height: 0;
    border-radius: 6px;
    margin-bottom: 10px;
  }

  .tabella-allenamenti {
    width: 100%;
    border-collapse: collapse;
  }

  .tabella-allenamenti th, .tabella-allenamenti td {
    border: 1px solid #ccc;
    padding: 8px;
  }

  .tabella-allenamenti th {
    background: #e8f1f7;
  }
</style>
</body>
</html>