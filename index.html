<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>üèîÔ∏è TrailCoach AI v21.2 (P)</title>
<meta name="theme-color" content="#000000">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    background:#fafafa; color:#111; margin:12px;
  }
  h1 { text-align:center; font-size:22px; margin:6px 0; }
  .card {
    background:#fff; border-radius:10px; padding:12px; margin:10px 0;
    box-shadow:0 1px 6px rgba(0,0,0,.06);
  }
  label { display:block; margin:8px 0 6px; font-weight:600; }
  input, select {
    width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;
    font-size:15px; box-sizing:border-box;
  }
  button {
    background:#007aff; color:#fff; border:none; padding:9px 14px;
    border-radius:8px; font-weight:600; cursor:pointer; font-size:14px;
  }
  button:hover { background:#005fd6; }
  button.reset { background:#ff3b30; margin-left:6px; }
  .btn-action { margin-top: 10px; width: 100%; box-sizing: border-box; }
  
  .week { 
    background:#f7f9ff; border-radius:10px; margin:8px 0;
  }
  .days { margin-top:6px; padding: 0 10px 10px 10px; } 
  .day { padding:6px 0; border-bottom:1px solid #eee; }
  .day:last-child { border-bottom: none; }
  
  .chk-btn {
    background:#f2f2f2; border-radius:8px; padding:8px; text-align:center;
  cursor:pointer;
  border:1px solid transparent; font-weight:700;
  }
  .chk-btn.active { background:#007aff; color:#fff; border-color:#0060d6; }
  .checkbox-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:6px; }
  .checkbox-grid-bottom { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
  .muted { color:#666; font-size:13px; }

  /* Stili per l'Accordion Settimanale */
  .accordion {
    background-color: #2a5d84; color: white; cursor: pointer;
  padding: 12px; width: 93%; text-align: left; border: none; outline: none;
    transition: background-color 0.2s ease; border-radius: 10px 10px 0 0;
  margin-top: 0; margin-bottom: 0; font-size: 16px; font-weight: 600;
  }
  .accordion.active, .accordion:hover { background-color: #357ca0; }
  .days.panel {
    background-color: #fcfcfc; overflow: hidden; padding-top: 10px;
    border-radius: 0 0 10px 10px;
  border: 1px solid #eee; border-top: none;
    display: none; 
  }
  /* Stili per il Dettaglio/GPX Accordion (per singolo giorno) */
  .day-header {
    display: flex;
  justify-content: space-between; align-items: center;
    cursor: pointer; padding: 4px 0;
  }
  .day-status { font-size: 18px; margin-right: 8px; }
  .day-details-panel {
    background: #fff; border-radius: 8px; padding: 8px 10px; 
    margin: 6px 0;
  border: 1px solid #eee; display: none;
  }
  .gpx-data { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd; }
  .gpx-data p { margin: 4px 0; }
  .gpx-upload-btn {
    background:#34c759; color:#fff; padding:6px 10px; border-radius:6px;
  font-size:13px; margin-top: 6px; border: none;
  }
  .gpx-upload-btn:hover { background: #2f9a4b; }
  
  /* STILI PER IL MODAL DI MODIFICA */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); display: none; z-index: 1000;
    justify-content: center; align-items: center;
  }
  .modal-content {
    width: 90%; max-width: 400px; padding: 20px;
  }
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v21.2</h1>

<div style="text-align:center; margin-bottom:8px;">
  <button id="toggleSettings" style="background:#34c759;">‚öôÔ∏è Impostazioni</button> 
</div>

<div class="card" id="settingsCard" style="display: none;">
  <label>Livello atleta</label>
  <select id="livello">
    <option value="principiante">Principiante</option>
    <option value="intermedio">Intermedio</option>
    <option value="avanzato">Avanzato</option>
  </select>

  <label>Obiettivo distanza gara (km)</label>
  <input id="obbKm" type="number" value="42" />

  <label>Obiettivo dislivello gara (m)</label>
  <input id="obbAsc" type="number" value="1800" />
  
  <label>Data della gara</label>
  <input id="dataGara" type="date" />
  
  <label>Tempo Obiettivo Gara (Ore)</label>
  <input id="tempoObiettivo" type="number" value="5" min="1" step="0.5" />
  
  <label>Durata piano (settimane)</label>
  <input id="settimane" type="number" value="12" 
  min="1" max="52" />
  
  <label>Giorni di Corsa</label>
  <div id="checkbox-grid-corsa-top" class="checkbox-grid">
    <div class="chk-btn" data-day="Luned√¨" data-type="corsa">Lun</div>
    <div class="chk-btn" data-day="Marted√¨" data-type="corsa">Mar</div>
    <div class="chk-btn" data-day="Mercoled√¨" data-type="corsa">Mer</div>
  </div>
  <div id="checkbox-grid-corsa-bottom" class="checkbox-grid-bottom">
    <div class="chk-btn" data-day="Gioved√¨" data-type="corsa">Gio</div>
    <div class="chk-btn" data-day="Venerd√¨" data-type="corsa">Ven</div>
    <div class="chk-btn" data-day="Sabato" data-type="corsa">Sab</div>
    <div class="chk-btn" data-day="Domenica" data-type="corsa">Dom</div>
  </div>
  
  <label>Giorni palestra</label>
  <div id="checkbox-grid-palestra-top" class="checkbox-grid">
    <div class="chk-btn" data-day="Luned√¨" data-type="palestra">Lun</div>
    <div class="chk-btn" data-day="Marted√¨" data-type="palestra">Mar</div>
    <div class="chk-btn" data-day="Mercoled√¨" data-type="palestra">Mer</div>
  </div>
  <div id="checkbox-grid-palestra-bottom" class="checkbox-grid-bottom">
    <div class="chk-btn" data-day="Gioved√¨" data-type="palestra">Gio</div>
    <div class="chk-btn" data-day="Venerd√¨" data-type="palestra">Ven</div>
    <div class="chk-btn" data-day="Sabato" data-type="palestra">Sab</div>
    <div class="chk-btn" data-day="Domenica" data-type="palestra">Dom</div>
  </div>

  <div style="margin-top:10px;">
    <button id="genLocal">‚öôÔ∏è Genera piano</button>
    <button id="genAI">ü§ñ Genera con AI</button>
    <button id="resetData" class="reset">üóëÔ∏è Reset</button>
  </div>
</div>

<div class="card" id="PlandCard">
  <label>Piano settimanale (Locale)</label>
  <div id="planView" class="muted">Nessun piano ancora generato.</div>
  
  <button onclick="esportaInPDF('planView')" class="btn-action" style="background:#ef802e;">üìÑ Esporta Piano Locale in PDF</button>
</div>

<div class="card" id="aiPlanCard" style="display: none;">
  <h2><label>üìã Piano Generato (AI)</label></h2>
  <div id="piano-generato"></div>
  
  <button onclick="esportaInPDF('piano-generato')" class="btn-action" style="background:#ef802e;">üìÑ Esporta Piano AI in PDF (Solo Sezioni Aperte)</button>
</div>

<input id="hiddenFileInput" type="file" accept=".gpx" style="display:none" />

<div id="editModal" class="modal-overlay">
  <div class="modal-content card">
    <h3>Modifica Allenamento</h3>
    <div id="modalForm">
        </div>
    <div style="margin-top: 15px; text-align: right;">
        <button onclick="closeEditDialog()" style="background:#8e8e93;">Annulla</button>
        <button id="saveEditBtn" style="background:#34c759; margin-left: 8px;">Salva Modifiche</button>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const STORAGE_KEY="trailcoach_v17";
let STATE={settings:{},planData:null, planDataAI:null};
const GIORNI=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];

// NUOVA COSTANTE PER I TIPI DI CORSA
const CORSA_TYPES = [
    "Corsa Lenta",
    "Corsa Facile",
    "Lungo Lento",
    "Corsa in Collina",
    "Ripetute Veloci",
    "Fartlek",
    "Progressivo",
    "Interval Training",
    "Tempo Run"
];

// NUOVA FUNZIONE PER I DETTAGLI PREDEFINITI
function getDefaultDetails(type) {
    switch(type) {
        case "Corsa Lenta":
        case "Corsa Facile":
            return "Corri a ritmo tranquillo (Z1/Z2), focus sulla resistenza e la tecnica base. Durata tipica: 1 ora.";
        case "Lungo Lento":
            return "Lungo a ritmo costante, mantieni un'intensit√† bassa per costruire l'endurance. Durata tipica: 1.5 - 3 ore.";
        case "Corsa in Collina":
            return "Ripetute in salita (5-8 volte 100-200m) per forza e potenza. Recupero scendendo.";
        case "Ripetute Veloci":
            return "Ripetute in piano (es. 6x400m o 4x800m) con recupero attivo. Lavora sulla VMA. Riscaldamento e defaticamento inclusi.";
        case "Fartlek":
            return "Gioco di velocit√†: alterna tratti veloci e lenti in modo spontaneo, su sentieri vari.";
        case "Progressivo":
            return "Inizia lento e aumenta il ritmo ogni 2-3 km, finendo a ritmo gara (Z3/Z4).";
        case "Interval Training":
            return "Lavoro strutturato con intervalli ad alta intensit√† seguiti da recupero programmato.";
        case "Tempo Run":
            return "Corsa a soglia (Z3) per 20-30 minuti, per migliorare la capacit√† di sostenere un ritmo elevato. Riscaldamento e defaticamento inclusi.";
        case "Palestra":
            return "Allenamento di Forza o Core, 45-60 min. Focus su gambe, schiena e stabilit√†. Evita gambe il giorno prima della corsa lunga.";
        case "Riposo":
            return "Giorno di recupero completo. Ideale per stretching, mobilit√† o riposo passivo.";
        default:
            return "Dettagli specifici per l'allenamento. Modifica liberamente.";
    }
}


// --- FUNZIONI DI STATO E UTILITY PER LA DATA ---
function paceByLevel(l){return l==="principiante"?6.2:l==="intermedio"?5.8:5.4;}
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE));}
function addDays(date, days) {
    const result = new Date(date);
    result.setUTCDate(result.getUTCDate() + days); 
    return result;
}
function formatDate(date) {
    const d = new Date(date);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}
function calculatePlanDates(dataGara, settimane) {
    const raceDate = new Date(dataGara);
    raceDate.setHours(0, 0, 0, 0);
    const daysBeforeRace = settimane * 7;
    const startDate = addDays(raceDate, -daysBeforeRace); 
    
    return { startDate, raceDate };
}

function loadState(){
    const r=localStorage.getItem(STORAGE_KEY);
    if(r) {
        STATE=JSON.parse(r);
        if (!STATE.planData || STATE.planData.length === 0) STATE.planData = null;
        if (!STATE.planDataAI || Object.keys(STATE.planDataAI).length === 0) STATE.planDataAI = null;
        if (STATE.settings) {
            document.getElementById("livello").value = STATE.settings.livello || 'principiante';
            document.getElementById("obbKm").value = STATE.settings.obbKm || 42;
            document.getElementById("obbAsc").value = STATE.settings.obbAsc || 2000;
            document.getElementById("dataGara").value = STATE.settings.dataGara || '';
            document.getElementById("tempoObiettivo").value = STATE.settings.tempoObiettivo || 6;
            document.getElementById("settimane").value = STATE.settings.settimane || 12;
            // Rimosso l'input allenTot
            
            // Gestione dei checkbox per corsa e palestra
            document.querySelectorAll(".chk-btn").forEach(btn => {
                btn.classList.remove("active");
                const day = btn.dataset.day;
                const type = btn.dataset.type;
                
                if (type === 'palestra' && STATE.settings.giorniPalestra?.includes(day)) {
                    btn.classList.add("active");
                }
                if (type === 'corsa' && STATE.settings.giorniCorsa?.includes(day)) {
                    btn.classList.add("active");
                }
            });
        }
    }
}

// --- FIX: Funzione di reset consolidata ---
function resetApplicationData() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
}

// Gestione click sui bottoni di selezione Corsa/Palestra
document.getElementById("settingsCard").addEventListener("click",e=>{
  if(e.target.classList.contains("chk-btn")) {
      const day = e.target.dataset.day;
      const type = e.target.dataset.type;
      
      // Controllo esclusivo: se selezioni Corsa, deseleziona Palestra e viceversa sullo stesso giorno
      if (type === 'corsa' && e.target.classList.contains('active')) {
          // Se sto disattivando Corsa, non faccio nulla.
      } else if (type === 'corsa' && !e.target.classList.contains('active')) {
          // Sto attivando Corsa, disattivo Palestra (se attiva)
          document.querySelector(`.chk-btn[data-day="${day}"][data-type="palestra"]`)?.classList.remove('active');
      } else if (type === 'palestra' && !e.target.classList.contains('active')) {
          // Sto attivando Palestra, disattivo Corsa (se attiva)
          document.querySelector(`.chk-btn[data-day="${day}"][data-type="corsa"]`)?.classList.remove('active');
      }
      
      e.target.classList.toggle("active");
  }
});

document.getElementById("toggleSettings").onclick=()=>{
  const card=document.getElementById("settingsCard");
  card.style.display=card.style.display==="none"?"block":"none";
};

// **FUNZIONE selectRunDays RIMOSSA**

function creaDettagliAllenamento(type,weeklyKm,weeklyAsc,runsCount,livello,isExtra=false){
  // La logica di ripartizione √® mantenuta, ma basata sul runsCount EFFETTIVO
  if(runsCount === 0) return { distance: 0, ascent: 0, durationMin: 0, detailText: getDefaultDetails(type), completed: false, gpxData: null };
  
  const longPct=0.55, speedPct=0.25, fondoPct=0.20;
  const baseKm=weeklyKm, baseAsc=weeklyAsc;
  const longKm=baseKm*longPct, longAsc=baseAsc*longPct;
  const qualKm=baseKm*speedPct, qualAsc=baseAsc*speedPct;
  const fondoKm=(baseKm*fondoPct)/Math.max(1,runsCount-2), fondoAsc=(baseAsc*fondoPct)/Math.max(1,runsCount-2);
  let dist,asc;
  if(/Lungo/i.test(type)){dist=longKm;asc=longAsc;}
  else if(/Ripetute|Progressivo|Fartlek/.test(type)){dist=qualKm;asc=qualAsc;}
  else{dist=fondoKm;asc=fondoAsc;}
  if(isExtra){dist*=0.5;asc*=0.5;}
  const dur=dist*paceByLevel(livello);
  let det=getDefaultDetails(type);
  
  // Sovrascriviamo il dettaglio solo per dare un esempio concreto per il piano LOCALE
  if(/Ripetute/.test(type))det=`${Math.min(12,Math.max(4,Math.round(dist)))}√ó400 m in salita, rec. 90‚Äì120s`;
  else if(/Progressivo/.test(type))det=`Progressivo: aumenta ritmo negli ultimi km`;
  else if(/Lungo/.test(type))det=`Lungo trail: endurance e gestione salita`;
  else det=`Fondo lento: ritmo facile, resistenza base`;
  
  return{
    distance:+dist.toFixed(1),ascent:Math.round(asc),durationMin:Math.round(dur),
    detailText:det,
    completed: false, 
    gpxData: null
  };
}

function generaPiano(){
  const livello=document.getElementById("livello").value;
  const obbKm=+document.getElementById("obbKm").value;
  const obbAsc=+document.getElementById("obbAsc").value;
  const settimane=+document.getElementById("settimane").value;
  // AllenTot rimosso e sostituito da selezione esplicita
  const giorniPalestra=[...document.querySelectorAll(".chk-btn[data-type='palestra'].active")].map(b=>b.dataset.day);
  const giorniCorsa=[...document.querySelectorAll(".chk-btn[data-type='corsa'].active")].map(b=>b.dataset.day);
  const runsCount = giorniCorsa.length;
  
  const dataGara=document.getElementById("dataGara").value; 
  const tempoObiettivo=+document.getElementById("tempoObiettivo").value;
    
  if(obbKm<=0||obbAsc<=0||!dataGara){alert("Inserisci valori validi e la data della gara!");return;}
  if(runsCount === 0 && giorniPalestra.length === 0){alert("Seleziona almeno un giorno di Corsa o Palestra!");return;}

  const { startDate, raceDate } = calculatePlanDates(dataGara, settimane);
  const plan=[]; 
  const baseVolumeCoeff = 0.6;

  for(let w=1;w<=settimane;w++){
    const weekStartDate = addDays(startDate, (w - 1) * 7);
    const w_mod = (w - 1) % 4;
    const w_cycle = Math.floor((w - 1) / 4);
    
    let cycleCoeff = baseVolumeCoeff + (w_cycle * 0.15);
    cycleCoeff = Math.min(cycleCoeff, 1.0);
    
    let weeklyCoeff = cycleCoeff;
    if (w_mod === 1) { 
        weeklyCoeff *= 1.10;
    } else if (w_mod === 2) { 
        weeklyCoeff *= 1.20;
    }

    const isScarico = (w_mod === 3);
    const moltiplicatoreScarico = isScarico ? 0.7 : 1;
    const finalCoeff = weeklyCoeff * moltiplicatoreScarico;
    
    const baseKm = obbKm * finalCoeff;
    const baseAsc = obbAsc * finalCoeff;

    const settimana=[]; 
    let totalKm=0,totalAsc=0;
    
    // Logica per assegnare la tipologia di corsa (Lungo, Ripetute/Qualit√†, Fondo)
    const runDaysCopy = [...giorniCorsa];
    let runAssignments = {};
    const hasLongRun = runDaysCopy.includes("Sabato") || runDaysCopy.includes("Domenica");
    
    // 1. Assegna il Lungo
    if (runDaysCopy.includes("Sabato")) {
        runAssignments["Sabato"] = "Lungo trail";
        runDaysCopy.splice(runDaysCopy.indexOf("Sabato"), 1);
    } else if (runDaysCopy.includes("Domenica")) {
        runAssignments["Domenica"] = "Lungo trail";
        runDaysCopy.splice(runDaysCopy.indexOf("Domenica"), 1);
    }
    
    // 2. Assegna Qualit√† (Ripetute) - cerca il primo giorno non Lungo
    if (runDaysCopy.length > 0) {
        const qualityDay = runDaysCopy[0];
        runAssignments[qualityDay] = "Ripetute collinari";
        runDaysCopy.splice(0, 1);
    }
    
    // 3. Assegna Fondo Lento agli altri giorni rimanenti
    runDaysCopy.forEach(day => {
        runAssignments[day] = "Fondo lento";
    });
    // runsCount √® il numero totale di giorni di corsa selezionati

    for(const day of GIORNI){
      if(giorniPalestra.includes(day)){
        settimana.push({
            day,type:"Palestra",summary:"üèãÔ∏è Palestra",
            details:{detailText:getDefaultDetails("Palestra"), distance: 0, ascent: 0, durationMin: 60, completed: false, gpxData: null}
        });
      } else if(giorniCorsa.includes(day)){
        const type = runAssignments[day] || "Fondo lento"; // Dovrebbe essere sempre assegnato
        const det=creaDettagliAllenamento(type,baseKm,baseAsc,runsCount,livello,false);
        totalKm+=det.distance; totalAsc+=det.ascent;
        settimana.push({day,type,summary:`üèÉ ${type} ‚Äî ${det.distance} km`,details:det});
      } else {
        settimana.push({day,type:"Riposo",summary:"Riposo",details:{detailText:getDefaultDetails("Riposo"), distance: 0, ascent: 0, durationMin: 0, completed: false, gpxData: null}});
      }
    }
    
    plan.push({
        settimana:w,
        startDate: weekStartDate.toISOString().split('T')[0], 
        targetKm:+totalKm.toFixed(1),targetAsc:Math.round(totalAsc),
        allenamenti:settimana,isScarico, 
        focus: isScarico ? "Settimana di scarico e recupero attivo" : "Costruzione volume e resistenza"
    });
  }

  const descrizione_generale = `Piano generato localmente per ${livello} su ${settimane} settimane, che termina il ${formatDate(raceDate)}.
Obiettivo: ${obbKm} km con ${obbAsc} m D+, Tempo Target: ${tempoObiettivo}h, con ${runsCount} allenamenti di corsa e ${giorniPalestra.length} di palestra a settimana.
Giorni di corsa: ${giorniCorsa.join(', ') || 'Nessuno'}. Giorni di palestra: ${giorniPalestra.join(', ') || 'Nessuno'}.`;

  STATE={settings:{livello,obbKm,obbAsc,settimane,giorniPalestra,giorniCorsa,dataGara,tempoObiettivo,descrizione_generale},planData:plan, planDataAI: null}; 
  saveState(); 
  document.getElementById("settingsCard").style.display="none";
  document.getElementById("aiPlanCard").style.display = 'none';
  document.getElementById("PlandCard").style.display = 'block';
  document.getElementById("planView").style.display = 'block';
  renderPiano();
}

// --- NUOVE FUNZIONI PER GESTIRE L'APERTURA DEGLI ACCORDION ---
function saveAccordionState(containerId) {
    const state = {};
    document.querySelectorAll(`#${containerId} .accordion`).forEach(btn => {
        // Usiamo il testo dell'accordion (es. "üìÖ Settimana 1...") come chiave
        const weekKey = btn.textContent.split('‚Äî')[0].trim(); 
        if (btn.classList.contains('active')) {
            state[weekKey] = true;
        }
    });
    return state;
}

function restoreAccordionState(containerId, savedState) {
    if (Object.keys(savedState).length === 0) return; // Non fare nulla se non c'√® stato

    document.querySelectorAll(`#${containerId} .accordion`).forEach(btn => {
        const weekKey = btn.textContent.split('‚Äî')[0].trim();
        const panel = btn.nextElementSibling;
        
        if (savedState[weekKey]) {
            btn.classList.add('active');
            if (panel) {
                panel.style.display = 'block';
            }
        } else {
            btn.classList.remove('active');
            if (panel) {
                panel.style.display = 'none';
            }
        }
    });
}
// --- FINE NUOVE FUNZIONI ---


function renderPiano(){
  const c=document.getElementById("planView");
  if(!STATE.planData?.length){c.textContent="Nessun piano ancora generato.";return;}
  
  // 1. SALVA LO STATO CORRENTE PRIMA DI RIGENERARE
  const savedState = saveAccordionState("planView");
  
  const descrizione_generale = STATE.settings.descrizione_generale || "Nessuna descrizione.";
  let htmlOutput = `<div class="card"><label>Descrizione Generale</label><div class="muted">${descrizione_generale}</div></div>`;
  const planData = STATE.planData;
  planData.forEach((w, wIdx) => {
    const totalKm = w.allenamenti.reduce((sum, a) => sum + (a.details?.distance || 0), 0).toFixed(1);
    const weekDisplayDate = w.startDate ? formatDate(w.startDate) : 'Data N/A';

    htmlOutput += `
        <div class="week">
            <div class="accordion">üìÖ Settimana ${w.settimana} (dal ${weekDisplayDate}) ‚Äî ${w.focus || w.summary} (${totalKm} km)</div>
            <div class="days panel">
                ${w.allenamenti.map((a, aIdx) => {
                    const d = a.details;
                    const isRun = a.type !== "Riposo" && a.type !== "Palestra";
                    const statusIcon = d.completed ? '‚úÖ' : (a.type === "Riposo" ? 'üí§' : (a.type === "Palestra" ? 'üí™' : '‚≠ï'));
            
                    const kmStr = a.type === "Palestra" || a.type === "Riposo" ? a.summary : a.type + ' ‚Äî ' + (d?.distance !== undefined ? d.distance + ' km' : 'N/A');
                    
                    
                    let detContent = isRun ? `<div class="muted">Obiettivo: ${d.distance} km ‚Ä¢ +${d.ascent} m ‚Ä¢ ${d.durationMin} min</div>` : (a.type === "Palestra" ? `<div class="muted">Durata stimata: ${d.durationMin} min</div>` : '');
                    
                    let gpxSection = '';
                    if (isRun) {
                        if (d.gpxData) {
                            gpxSection = `
                                <div class="gpx-data">
                                    <strong>Caricato (${d.completed ? 'Verificato ‚úÖ' : 'Non Verificato ‚ùå'}):</strong>
                                    <p class="muted">Km: ${d.gpxData.distanceKm.toFixed(2)} ‚Ä¢ D+: ${d.gpxData.ascentMeters} m ‚Ä¢ Durata: ${d.gpxData.durationMinutes} min</p>
                                </div>
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd;"></div>
                            `;
                        } else {
                            gpxSection = `
                                <button class="gpx-upload-btn" onclick="uploadGPX('local', ${wIdx}, ${aIdx})">
                                    Carica GPX
                                </button>
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd;"></div>
                            `;
                        }
                    }
                    
                    // Pulsante Modifica per tutti i tipi
                    gpxSection += `
                        <button class="gpx-upload-btn" style="background: #39a3f2;" onclick="editAIActivity('local', ${wIdx}, ${aIdx})">
                            ‚úèÔ∏è Modifica Dettagli
                        </button>
                    `;


                    return `
                        <div class="day">
                            <div class="day-header" data-toggle-panel="local-${wIdx}-${aIdx}">
                                <div><span class="day-status">${statusIcon}</span><strong>${a.day}</strong> ‚Äî ${kmStr}</div>
                                <div><span style="font-size:10px;">${d?.detailText || ''}</span></div>
                            </div>
                            <div class="day-details-panel" id="local-${wIdx}-${aIdx}">
                                <em>${d?.detailText || a.summary}</em>
                                ${detContent}
                                ${gpxSection}
                            </div>
                        </div>
                    `;
                }).join("")}
            </div>
        </div>
    `;
  });

  c.innerHTML = htmlOutput;
  attachAccordionListeners("planView");
  attachDayDetailListeners();
  
  // 2. RIPRISTINA LO STATO SALVATO
  restoreAccordionState("planView", savedState);
}


function calculatePace(km, durationMin) {
    if (km > 0 && durationMin > 0) {
        const paceMin = durationMin / km;
        const minutes = Math.floor(paceMin);
        const seconds = Math.round((paceMin - minutes) * 60);
        return `${minutes}'${String(seconds).padStart(2, '0')}" /km`;
    }
    return 'N/A';
}

// NUOVA FUNZIONE PER CHIUDERE IL DIALOG
function closeEditDialog() {
    document.getElementById("editModal").style.display = 'none';
}

// NUOVA FUNZIONE PER MOSTRARE IL DIALOG DI MODIFICA
function showEditDialog(planType, weekIdx, runIdx, activity) {
    const currentType = planType === 'local' ? activity.type : activity.tipo;
    const currentDetails = planType === 'local' ? activity.details.detailText : activity.dettagli;
    const currentKm = planType === 'local' ? activity.details.distance : activity.km;
    const currentAsc = planType === 'local' ? (activity.details.ascent || 0) : (activity.asc || 0);
    const currentDuration = planType === 'local' ? (activity.details.durationMin || 60) : (activity.durationMin || 60);

    const form = document.getElementById("modalForm");
    let formHtml = '';
    
    // 1. Dropdown per il tipo di allenamento
    let optionsHtml = CORSA_TYPES.map(t => 
        `<option value="${t}" ${currentType === t || currentType.includes(t) ? 'selected' : ''}>${t}</option>`
    ).join('');
    // Aggiungi sempre l'opzione Palestra e Riposo
    optionsHtml += `<option value="Palestra" ${currentType.includes("Palestra") ? 'selected' : ''}>üèãÔ∏è Palestra</option>`;
    optionsHtml += `<option value="Riposo" ${currentType.includes("Riposo") ? 'selected' : ''}>üí§ Riposo</option>`; // <-- Riposo aggiunto
    
    formHtml += `
        <label for="editType">Tipo Allenamento</label>
        <select id="editType">${optionsHtml}</select>
    `;

    // 2. Dettagli (testo libero)
    formHtml += `
        <label for="editDetails">Dettagli</label>
        <input id="editDetails" type="text" value="${currentDetails}" />
    `;
    
    // 3. Campi KM, ASC, DURATA
    formHtml += `
        <div id="runFields" style="display: block;">
            <label for="editKm">Chilometri (km)</label>
            <input id="editKm" type="number" step="0.1" value="${currentKm}" />
            
            <label for="editAsc">Dislivello (m)</label>
            <input id="editAsc" type="number" value="${currentAsc}" />
        </div>
        
        <label for="editDuration">Durata (minuti)</label>
        <input id="editDuration" type="number" value="${currentDuration}" />
    `;

    form.innerHTML = formHtml;
    document.getElementById("editModal").style.display = 'flex';
    
    // Assegna l'handler di salvataggio
    document.getElementById("saveEditBtn").onclick = () => saveEditedActivity(planType, weekIdx, runIdx);
    
    // Listener per abilitare/disabilitare i campi e AGGIORNARE I DETTAGLI
    document.getElementById("editType").onchange = function() {
        const runFields = document.getElementById("runFields");
        const detailsInput = document.getElementById("editDetails");
        const durationInput = document.getElementById("editDuration");
        const selectedType = this.value; 

        const isPalestra = selectedType.includes("Palestra");
        const isRiposo = selectedType.includes("Riposo");

        if (isPalestra || isRiposo) {
            runFields.style.display = 'none';
            if (isRiposo) {
                document.getElementById("editKm").value = 0;
                document.getElementById("editAsc").value = 0;
                durationInput.value = 0;
                durationInput.readOnly = true;
            } else {
                durationInput.readOnly = false;
                if (durationInput.value == 0) durationInput.value = 60;
                // Azzeramento per palestra
                document.getElementById("editKm").value = 0;
                document.getElementById("editAsc").value = 0;
            }
        } else {
            // Corsa
            runFields.style.display = 'block';
            durationInput.readOnly = false;
            if (durationInput.value == 0) durationInput.value = 60;
        }
        
        detailsInput.value = getDefaultDetails(selectedType);
    };
    
    // INIZIALIZZAZIONE: Se il tipo iniziale √® Palestra o Riposo, nascondi i campi corsa all'apertura.
    const initialType = document.getElementById("editType").value;
    const isInitialRiposo = initialType.includes("Riposo");
    if (initialType.includes("Palestra") || isInitialRiposo) {
         document.getElementById("runFields").style.display = 'none';
         if (isInitialRiposo) {
             document.getElementById("editDuration").readOnly = true;
         }
    }
}

// NUOVA FUNZIONE PER SALVARE I DATI DAL MODAL
function saveEditedActivity(planType, weekIdx, runIdx) {
    const plan = planType === 'local' ? STATE.planData : STATE.planDataAI.settimane;
    const activity = plan[weekIdx].allenamenti[runIdx];
    
    // Recupero i nuovi valori dal modal
    const newType = document.getElementById("editType").value;
    const newDetails = document.getElementById("editDetails").value;
    let newKm = 0;
    let newAsc = 0;
    let newDuration = 0;
    
    const isPalestra = newType.includes("Palestra");
    const isRiposo = newType.includes("Riposo");
    
    if (!isRiposo && !isPalestra) {
        // √à Corsa: recupera i valori e validali
        newKm = parseFloat(document.getElementById("editKm").value);
        newAsc = parseInt(document.getElementById("editAsc").value);
        newDuration = parseInt(document.getElementById("editDuration").value);

        if (isNaN(newKm) || newKm < 0) newKm = 0;
        if (isNaN(newAsc) || newAsc < 0) newAsc = 0;
        if (isNaN(newDuration) || newDuration < 1) newDuration = 60;
        
    } else if (isPalestra) {
        // √à Palestra
        newDuration = parseInt(document.getElementById("editDuration").value);
        if (isNaN(newDuration) || newDuration < 1) newDuration = 60;
        
    } else if (isRiposo) {
        // √à Riposo: km, asc, duration sono 0
        newKm = 0;
        newAsc = 0;
        newDuration = 0;
    }
    
    // Aggiornamento dello Stato
    if (planType === 'local') {
        activity.type = newType; 
        
        if (isRiposo) {
            activity.summary = "üí§ Riposo";
        } else if (isPalestra) {
            activity.summary = "üèãÔ∏è Palestra";
        } else {
            activity.summary = `üèÉ ${newType} ‚Äî ${newKm.toFixed(1)} km`; 
        }
        
        activity.details.detailText = newDetails;
        activity.details.distance = newKm;
        activity.details.ascent = newAsc;
        activity.details.durationMin = newDuration;
        activity.details.gpxData = null; // Azzera i dati GPX se l'attivit√† cambia tipo
        activity.details.completed = false;
        
    } else { // Piano AI
        activity.tipo = newType; 
        activity.dettagli = newDetails;
        activity.km = newKm;
        activity.asc = newAsc;
        activity.durationMin = newDuration;
        activity.gpxData = null; // Azzera i dati GPX se l'attivit√† cambia tipo
        activity.completed = false;
    }

    saveState();
    closeEditDialog();

    // Rirenderizza la vista
    if (planType === 'local') {
        renderPiano();
    } else {
        // Nota: Qui passiamo il piano AI salvato in STATE, non l'intera stringa JSON
        renderExternalPlan(JSON.stringify(STATE.planDataAI));
    }
    alert("Dettagli dell'allenamento aggiornati localmente!");
}


// --- MODIFICA FUNZIONE editAIActivity: ora chiama il nuovo modal ---
function editAIActivity(planType, weekIdx, runIdx) {
    const plan = planType === 'local' ? STATE.planData : STATE.planDataAI.settimane;
    const activity = plan[weekIdx].allenamenti[runIdx];
    
    // Passa i dati al nuovo dialog
    showEditDialog(planType, weekIdx, runIdx, activity);
}


function renderExternalPlan(jsonString) {
    const container = document.getElementById("piano-generato");
    const card = document.getElementById("aiPlanCard");
    
    // 1. SALVA LO STATO CORRENTE PRIMA DI RIGENERARE
    const savedState = saveAccordionState("piano-generato"); 
    
    container.innerHTML = "";
    
    let piano;
    let cleanText = jsonString;
    card.style.display = 'block';
    document.getElementById("planView").style.display = 'none';
    document.getElementById("PlandCard").style.display = 'none';

    try {
        const match = jsonString.match(/```json([\s\S]*?)```/);
        if (match) {
      
            cleanText = match[1];
        } else {
            // Tentativo di pulizia per JSON non formattato
            cleanText = jsonString.substring(jsonString.indexOf('{'), jsonString.lastIndexOf('}') + 1);
        }
        cleanText = cleanText
            .replace(/\\n/g, "").replace(/\n/g, "").replace(/\r/g, "").trim();
        
        // CORREZIONE: Pulizia per robustezza del parsing JSON
        cleanText = cleanText.replace(/^[^{]*/, '').replace(/[^}]+$/, '}');
        
        cleanText = cleanText.replace(/\\"/g, '"');
        piano = JSON.parse(cleanText);
    } catch (e) {
        // GESTIONE ERRORE JSON - Mantiene la card AI visibile per il debug
        container.innerHTML = `<p style="color:red;">‚ùå Errore nel formato JSON: ${e.message}</p><div style="background:#fff3f3; border:1px solid #ffaaaa; padding:10px; border-radius:8px; margin-top:10px; font-size:12px; white-space:pre-wrap; word-wrap:break-word;"><p><strong>Testo Ricevuto (tentativo di parsing):</strong></p>${jsonString.substring(0, 1000)} ${jsonString.length > 1000 ? '...' : ''}</div>`;
        return;
    }

    if (!piano.settimane || !Array.isArray(piano.settimane)) {
        container.innerHTML = `<p style="color:red;">‚ö†Ô∏è Struttura JSON valida, ma manca la chiave "settimane" o non √® un array.</p>`;
        return;
    }
    
    // LOGICA DI CALCOLO E AGGIUNTA DATE AL PIANO AI
    const dataGara = document.getElementById("dataGara").value;
    const settimane = piano.settimane.length;
    
    if (dataGara && settimane > 0) {
        const { startDate } = calculatePlanDates(dataGara, settimane);
        piano.settimane.forEach((w, index) => {
            const weekStartDate = addDays(startDate, index * 7);
            w.startDate = weekStartDate.toISOString().split('T')[0]; 
            
            w.allenamenti.forEach(a => {
                   // Assicura che completed e gpxData esistano per il salvataggio dello stato
                   a.completed = a.completed || false;
                   a.gpxData = a.gpxData || null;
                   // Assicura i valori per Riposo e Palestra per coerenza di salvataggio
                   if (a.tipo === "Riposo") { a.km = 0; a.asc = 0; a.durationMin = 0; a.dettagli = a.dettagli || getDefaultDetails("Riposo");}
                   if (a.tipo === "Palestra" && a.durationMin === undefined) { a.durationMin = 60; a.km = 0; a.asc = 0; a.dettagli = a.dettagli || getDefaultDetails("Palestra"); }
            });
        });
    }

    const settings = { 
        descrizione_generale: piano.descrizione_generale || 'Piano generato tramite AI. Dettagli generati da LLM.',
        ...STATE.settings,
    };
    STATE = {
        settings: settings,
        planData: null, 
        planDataAI: piano 
    };
    saveState();

    let htmlOutput = `<div class="card"><label>Descrizione Generale</label><div class="muted">${piano.descrizione_generale || "Nessuna descrizione fornita."}</div></div>`;
    piano.settimane.forEach((w, wIdx) => {
        const totalKm = w.allenamenti ? w.allenamenti.reduce((sum, a) => sum + (a.km || 0), 0).toFixed(1) : 0;
        const weekDisplayDate = w.startDate ? formatDate(w.startDate) : 'Data N/A';
        
        htmlOutput += `
            <div class="week">
                <div class="accordion">üìÖ Settimana ${w.numero} (dal ${weekDisplayDate}) ‚Äî ${w.focus || "Nessun focus"} (${totalKm} km)</div>
                <div class="days panel">
                    ${w.allenamenti.map((a, aIdx) => {
                        const isRun = a.tipo !== "Riposo" && a.tipo !== "Palestra";
                        const statusIcon = a.completed ? '‚úÖ' : (a.tipo === "Riposo" ? 'üí§' : (a.tipo === "Palestra" ? 'üí™' : '‚≠ï'));

                        const giornoDisplay = a.giorno ? `${a.giorno} ‚Äî ` : ''; 
                        const kmDisplay = a.tipo === "Palestra" || a.tipo === "Riposo" ? a.tipo : (a.km !== undefined ? a.km + ' km' : 'N/A');
  
                        const titleDisplay = a.tipo === "Palestra" ? 'üèãÔ∏è Palestra' : (a.tipo === "Riposo" ? 'üí§ Riposo' : a.tipo);
                        
                        let paceDisplay = '';
                        // Calcola il passo solo se √® una corsa
                        if(isRun && a.km > 0 && a.durationMin > 0) {
                            const paceText = a.pace || calculatePace(a.km, a.durationMin);
                            paceDisplay = ` ‚Ä¢ Passo: ${paceText}`;
                        }

                        let detContent = isRun ? `<div class="muted">Obiettivo: ${a.km} km ‚Ä¢ +${a.asc || 0} m ‚Ä¢ ${a.durationMin || 'N/A'} min ${paceDisplay}</div>` : (a.tipo === "Palestra" ? `<div class="muted">Durata stimata: ${a.durationMin || 60} min</div>` : '');
                        
                        let gpxSection = '';
                        if (isRun) { // Solo per la corsa
                            if (a.gpxData) {
                                gpxSection = `
                                    <div class="gpx-data">
                                        <strong>Caricato (${a.completed ? 'Verificato ‚úÖ' : 'Non Verificato ‚ùå'}):</strong>
                                        <p class="muted">Km: ${a.gpxData.distanceKm.toFixed(2)} ‚Ä¢ D+: ${a.gpxData.ascentMeters} m ‚Ä¢ Durata: ${a.gpxData.durationMinutes} min</p>
                                    </div>
                                `;
                            } else {
                                gpxSection = `
                                    <button class="gpx-upload-btn" onclick="uploadGPX('ai', ${wIdx}, ${aIdx})">
                                        Carica GPX
                                    </button>
                                `;
                            }
                            gpxSection += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd;"></div>`;
                        }
                        
                        // Pulsante Modifica per tutti i tipi
                        gpxSection += `
                            <button class="gpx-upload-btn" style="background: #39a3f2;" onclick="editAIActivity('ai', ${wIdx}, ${aIdx})">
                                ‚úèÔ∏è Modifica Dettagli
                            </button>
                        `;

                        return `
                        <div class="day">
                          
                            <div class="day-header" data-toggle-panel="ai-${wIdx}-${aIdx}">
                                <div><span class="day-status">${statusIcon}</span><strong>${giornoDisplay}${titleDisplay}</strong> ‚Äî ${kmDisplay}</div>
                                <div><span style="font-size:10px;">${a.dettagli || ''}</span></div>
                            </div>
                            <div class="day-details-panel" id="ai-${wIdx}-${aIdx}">
                                <em>${a.dettagli || 'Nessun dettaglio'}</em>
                                ${detContent}
                                ${gpxSection}
                            </div>
       
                        </div>
                        `;
                    }).join("")}
                </div>
            </div>
        `;
    });

    container.innerHTML = htmlOutput;
    attachAccordionListeners("piano-generato");
    attachDayDetailListeners();
    
    // 2. RIPRISTINA LO STATO SALVATO
    restoreAccordionState("piano-generato", savedState);
}

function parseGPX(xmlString) {
    try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "application/xml");
        
        // Semplice tentativo di estrarre metriche comuni GPX
        const trkpts = xmlDoc.querySelectorAll("trkpt");
        if (trkpts.length < 2) return null;

        let distanceKm = 0;
        let ascentMeters = 0;
        let prevLat = null, prevLon = null, prevEle = null;
        let startTime = null;
        let endTime = null;

        trkpts.forEach(pt => {
            const lat = parseFloat(pt.getAttribute("lat"));
            const lon = parseFloat(pt.getAttribute("lon"));
         
            const eleEl = pt.querySelector("ele");
            const ele = eleEl ? parseFloat(eleEl.textContent) : null;
            const timeEl = pt.querySelector("time");
            const time = timeEl ? new Date(timeEl.textContent) : null;
            if (time && !startTime) startTime = time;
            if (time) endTime = time;
            if (prevLat !== null && prevLon !== null) {
                // Calcola distanza (Formula Haversine - approssimativa)
                const R = 6371;
                // Raggio terrestre in km
                const dLat = (lat - prevLat) * Math.PI / 180;
                const dLon = (lon - prevLon) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(prevLat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                distanceKm += R * c;
                // Calcola dislivello (solo positivo)
                if (ele !== null && prevEle !== null && ele > prevEle) {
                    ascentMeters += (ele - prevEle);
                }
            }
            prevLat = lat;
            prevLon = lon;
            prevEle = ele;
        });

        const durationMs = endTime && startTime ? endTime.getTime() - startTime.getTime() : 0;
        const durationMinutes = Math.round(durationMs / 60000);

        return {
            distanceKm: distanceKm,
            ascentMeters: Math.round(ascentMeters),
            durationMinutes: durationMinutes
        };
    } catch (e) {
        console.error("Errore nel parsing GPX:", e);
        return null;
    }
}


function uploadGPX(planType, weekIdx, runIdx) {
    const plan = planType === 'local' ? STATE.planData : STATE.planDataAI.settimane;
    const run = plan[weekIdx].allenamenti[runIdx];
    
    // Controlla se l'attivit√† √® una corsa (i nomi delle propriet√† variano)
    const runType = planType === 'local' ? run.type : run.tipo;
    if (runType === "Riposo" || runType === "Palestra") {
        alert("Non √® necessario caricare un GPX per questa attivit√†.");
        return;
    }

    const input = document.getElementById("hiddenFileInput");
    // **FIX 1: Rimuovi l'handler precedente per evitare doppi eventi**
    input.onchange = null;
    // **FIX 2: Pulisci il valore per forzare l'evento 'change' anche con lo stesso file**
    input.value = '';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) {
             input.value = '';
             // Pulisci anche in caso di annullamento
             return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const xmlString = event.target.result;
            // **FIX 3: Ora chiama la funzione parseGPX, che √® stata aggiunta**
            const gpxData = parseGPX(xmlString);
            if (!gpxData) {
                alert("Errore nell'analisi del file GPX o dati mancanti.");
                input.value = '';
                return;
            }
            
            // Requisiti (logica di verifica mantenuta)
            const requiredKm = planType === 'local' ? run.details.distance : run.km;
            const requiredAscent = planType === 'local' ? run.details.ascent : (run.asc || 0);
            const requiredDurationMinutes = planType === 'local' ? run.details.durationMin : (run.durationMin || 60);
            const isCompleted = true //distMatch && ascMatch && durMatch;
            
            // Aggiorna lo stato
            if (planType === 'local') {
                run.details.gpxData = gpxData;
                run.details.completed = isCompleted;
            } else { // AI
                run.gpxData = gpxData;
                run.completed = isCompleted;
            }
            
            saveState();
            // Aggiorna la UI e notifica
            const message = `Distanza (Richiesto: ${requiredKm} km, Trovato: ${gpxData.distanceKm.toFixed(2)} km)\nDislivello (Richiesto: ${requiredAscent} m, Trovato: ${gpxData.ascentMeters} m)\nDurata (Richiesto: ${requiredDurationMinutes} min, Trovato: ${gpxData.durationMinutes} min)`;
            if (isCompleted) {
                alert(`‚úÖ Allenamento completato! Dati GPX verificati.\n\n${message}`);
            } else {
                alert(`‚ö†Ô∏è Caricamento completato, ma i dati non combaciano.\n\n${message}`);
            }
            
            if (planType === 'local') renderPiano();
            else renderExternalPlan(JSON.stringify(STATE.planDataAI));

            input.value = ''; 
        };
        reader.readAsText(file);
    };

    input.click();
}
  
async function generaPianoAI() {
  const container = document.getElementById("piano-generato");
  container.innerHTML = "<p>‚è≥ Generazione piano AI in corso‚Ä¶</p>";
  document.getElementById("aiPlanCard").style.display = 'block';
  document.getElementById("planView").style.display = 'none';

  let rawText = null;
  try {
    const livello = document.getElementById("livello").value;
    const obbKm = parseFloat(document.getElementById("obbKm").value);
    const obbAsc = parseFloat(document.getElementById("obbAsc").value);
    const giorniPalestra = Array.from(document.querySelectorAll(".chk-btn[data-type='palestra'].active")).map(b => b.dataset.day);
    const giorniCorsa = Array.from(document.querySelectorAll(".chk-btn[data-type='corsa'].active")).map(b => b.dataset.day);
    const settimane = parseInt(document.getElementById("settimane").value);
    // runsCount non √® pi√π necessario nel payload, ma lo conserviamo come controllo
    const runsCount = giorniCorsa.length; 

    const dataGara=document.getElementById("dataGara").value;
    const tempoObiettivo = parseFloat(document.getElementById("tempoObiettivo").value);
    if(!dataGara || !tempoObiettivo){alert("Inserisci la data della gara e il tempo obiettivo per generare un piano con l'AI.");return;} 
    if(runsCount === 0 && giorniPalestra.length === 0){alert("Seleziona almeno un giorno di Corsa o Palestra per generare il piano AI.");return;}
    
    // PAYLOAD AGGIORNATO: Inviamo i dati grezzi e precisi
    const response = await fetch("https://eoakctnc24hsvp9.m.pipedream.net", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        livello, 
        km: obbKm, // obbKm
        asc: obbAsc, // obbAsc
        settimane, 
        dataGara, // Aggiunto per completezza
        tempoObiettivo, 
        giorniCorsa, // NUOVO: Array di giorni di corsa
        giorniPalestra // NUOVO: Array di giorni di palestra
      })
    });
    rawText = await response.text(); 
    
    if (!response.ok) {
        throw new Error(`Errore HTTP ${response.status}: ${response.statusText}`);
    }

    renderExternalPlan(rawText); 
    
    const plandCardElement = document.getElementById("PlandCard"); 
    if (plandCardElement) {
      plandCardElement.style.display ='none';
    }
    
    document.getElementById("planView").style.display = 'none';
    document.getElementById("PlandCard").style.display = 'none';
    document.getElementById("aiPlanCard").style.display = 'block';

  } catch (err) {
    console.error("Errore Generazione AI:", err);
    let debugOutput = '';
    if (rawText) {
        debugOutput = `
            <div style="background:#fff3f3; border:1px solid #ffaaaa; padding:10px; border-radius:8px; margin-top:10px; font-size:12px; white-space:pre-wrap; word-wrap:break-word;">
                <p><strong>Contenuto della Risposta (Debug):</strong></p>
                ${rawText.substring(0, 1000)} ${rawText.length > 1000 ? '...' : ''}
            </div>
        `;
    }

    container.innerHTML = `
        <p style="color:red;">‚ùå Errore durante la generazione AI: ${err.message}</p>
        ${debugOutput}
    `;
  }
}

// --- MODIFICA 2: Aggiornata per gestire l'esportazione specifica ---
function esportaInPDF(elementId) {
    const { jsPDF } = window.jspdf;
    const container = document.getElementById(elementId); 
    
    if (!container || container.children.length === 0 || container.textContent.includes("Nessun piano")) {
        alert("Genera prima un piano di allenamento da esportare.");
        return;
    }

    let elementsToCapture = [];
    
    if (elementId === 'planView') {
        // Per il piano locale, esporta tutto il contenitore (comportamento precedente)
        elementsToCapture = [container];
    } else if (elementId === 'piano-generato') {
        // Per il piano AI, cattura SOLO le settimane con pannello espanso
        const weeks = container.querySelectorAll('.week');
        weeks.forEach(week => {
            const accordion = week.querySelector('.accordion');
            const panel = week.querySelector('.days.panel');
            
            // Cattura solo se l'accordion √® attivo (cio√® il pannello √® aperto)
            if (accordion && accordion.classList.contains('active') && panel && panel.style.display === 'block') {
           
                elementsToCapture.push(week);
            }
        });
        if (elementsToCapture.length === 0) {
             alert("Apri almeno una settimana del piano AI per esportare i dettagli giornalieri.");
            return;
        }
    } 

    const pdf = new jsPDF('p', 'mm', 'a4');
    let position = 0;
    const pdfWidth = 210; 
    const pdfHeight = 297;
    // Funzione helper per aggiungere un'immagine al PDF con gestione multi-pagina
    function addImageToPdf(imgData, canvasWidth, canvasHeight) {
        const imgHeight = canvasWidth > 0 ? (canvasHeight * pdfWidth / canvasWidth) : pdfHeight;
        
        if (position + imgHeight > pdfHeight && position !== 0) {
            pdf.addPage();
            position = 0;
        }

        pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
        position += imgHeight;
    }

    // Processa gli elementi da catturare in sequenza
    const capturePromises = elementsToCapture.map(element => {
        return new Promise(resolve => {
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                allowTaint: true 
   
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                resolve({ imgData, canvasWidth: canvas.width, canvasHeight: canvas.height });
            }).catch(error => {
                console.error("Errore nella cattura con html2canvas:", error);
            
                resolve(null);
            });
        });
    });
    Promise.all(capturePromises).then(results => {
        results.forEach(result => {
            if (result && result.imgData) {
                addImageToPdf(result.imgData, result.canvasWidth, result.canvasHeight);
            }
        });
        
        pdf.save(`TrailCoach_Piano_${elementId === 'planView' ? 'Locale' : 'AI_Dettaglio'}.pdf`);
    });
}


// --- FUNZIONI DI GESTIONE UI (Accordion) ---
function attachAccordionListeners(containerId) {
    document.querySelectorAll(`#${containerId} .accordion`).forEach((btn) => {
        const panel = btn.nextElementSibling;
        btn.addEventListener("click", function() {
            this.classList.toggle("active");
            const isVisible = panel.style.display === "block";
            panel.style.display = isVisible ? "none" : "block"; 
        });
    });
}
function attachDayDetailListeners() {
    document.querySelectorAll(".day-header").forEach(header => {
        header.addEventListener("click", () => {
            const panelId = header.getAttribute("data-toggle-panel");
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.style.display = panel.style.display === "block" ? "none" : "block";
            }
 
        });
    });
}

// --- LOGICA DI AVVIO ---
document.getElementById("genLocal").onclick = generaPiano;
document.getElementById("genAI").addEventListener("click", generaPianoAI);
document.getElementById("resetData").onclick = resetApplicationData; 

document.addEventListener('DOMContentLoaded', () => {
    loadState();
    
    // CORREZIONE 2: Uso l'ID corretto "PlandCard"
    const plandCard = document.getElementById("PlandCard"); 
    
    if(STATE.planDataAI){
        document.getElementById("planView").style.display = 'none';
        document.getElementById("aiPlanCard").style.display = 'block';
        renderExternalPlan(JSON.stringify(STATE.planDataAI)); 
    }
    else if(STATE.planData){ 
        document.getElementById("planView").style.display = 'block';
        document.getElementById("aiPlanCard").style.display = 'none';
        renderPiano();
    }
    
    // CORREZIONE CRUCIALE: Assicurati che PlandCard sia nascosto se c'√® un piano AI
    if (STATE.planDataAI && plandCard) {
        plandCard.style.display = 'none';
    }
});
</script>


</body>
</html>
