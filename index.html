<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v9</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">
<style>
:root{--gap:8px;--card-radius:12px;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;overflow-x:hidden;}
h1{text-align:center;font-size:22px;margin:8px 0;}
.card{background:#fff;border-radius:var(--card-radius);padding:12px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,.08);}
label{display:block;margin:6px 0 4px;font-weight:600;}
input[type="number"], select, input[type="text"]{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;}
button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:6px;}
button.save{background:#34c759;} button.orange{background:#ff9500;} button.red{background:#ff3b30;}
.week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
.week h3{margin:0;cursor:pointer;font-size:17px;}
.days{margin-top:6px;padding-left:10px;display:none;}
.days div{padding:4px 0;border-bottom:1px solid #eee;}
.small{font-size:13px;color:#666;}
.toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:6px 10px;font-size:13px;margin-top:-4px;}
.checkbox-group{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
.checkbox-group label{display:flex;align-items:center;gap:8px;background:#f2f2f2;padding:6px 10px;border-radius:8px;font-weight:500;font-size:15px;}
.checkbox-group input{width:auto;height:auto;margin:0;}
.checkbox-group label span{white-space: nowrap;}
@media(max-width:420px){.checkbox-group label{flex:1 1 48%; min-width:120px; text-align:left; padding:8px;}}
.summary{padding:8px;border-radius:8px;background:#fff7e6;border:1px solid #ffe5b4;font-size:14px;margin-bottom:8px;}
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v9</h1>

<div class="card" id="topSummaryCard" style="display:none;">
  <div id="summaryText" class="summary"></div>
</div>

<div class="card" id="settingsCard">
  <div>
    <span style="font-weight:600;">‚öôÔ∏è Impostazioni</span>
    <button id="toggleSettings" class="toggle-btn" aria-expanded="true">Nascondi</button>
  </div>
  <div id="settingsContent">
    <label>Livello atleta</label>
    <select id="livello">
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzato">Avanzato</option>
    </select>

    <label>Obiettivo distanza gara (km)</label>
    <input id="obbKm" type="number" placeholder="es. 20" />

    <label>Obiettivo dislivello gara (m)</label>
    <input id="obbD+" type="number" placeholder="es. 1000" />

    <label>Durata piano (settimane)</label>
    <input id="settimane" type="number" value="8" min="1" max="52" />

    <label>Allenamenti totali a settimana</label>
    <input id="allenTot" type="number" value="4" min="2" max="7" />

    <label>Giorni palestra (seleziona i giorni precisi)</label>
    <div class="checkbox-group" id="giorniPalestra">
      <label><input type="checkbox" value="Luned√¨"><span>Luned√¨</span></label>
      <label><input type="checkbox" value="Marted√¨"><span>Marted√¨</span></label>
      <label><input type="checkbox" value="Mercoled√¨"><span>Mercoled√¨</span></label>
      <label><input type="checkbox" value="Gioved√¨"><span>Gioved√¨</span></label>
      <label><input type="checkbox" value="Venerd√¨"><span>Venerd√¨</span></label>
      <label><input type="checkbox" value="Sabato"><span>Sabato</span></label>
      <label><input type="checkbox" value="Domenica"><span>Domenica</span></label>
    </div>

    <button id="genLocal" class="save">‚öôÔ∏è Genera piano</button>
  </div>
</div>

<div class="card">
  <label>Carica file .fit (allenamento Zepp/Garmin)</label>
  <input id="fitFile" type="file" accept=".fit" />
  <div id="fitInfo" class="small">Nessun file caricato.</div>
</div>

<div class="card">
  <label>Avanzamento</label>
  <canvas id="progressChart" width="360" height="140"></canvas>
  <div id="chartText" class="small"></div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView">Nessun piano ancora generato.</div>
</div>

<div class="card">
  <label>Storico allenamenti</label>
  <div id="historyList" class="small">Nessun allenamento registrato.</div>
</div>

<script>
// ===== Mock FitParser =====
!function(t){t.FitParser=function(){return{parse:(a,e)=>{try{ const r=Math.random(); e(null,{sessions:[{total_distance:5+r*15,total_ascent:Math.round(100+r*800)}]});}catch(err){e(err)}}}}}(window);

// ===== Stato e storage =====
const STORAGE_KEY = "trailcoach_v9_data";
let state = {
  settings: { livello:"principiante", obbKm:20, obbAsc:1000, settimane:8, allenTot:4, giorniPalestra:[] },
  planData: [],
  progress: { km:0, ascent:0 },
  history: []
};

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ try{ state=JSON.parse(raw); }catch(e){console.log("Errore parse storage",e);} }}

// ===== Utils generazione =====
function progressione(lvl){
  switch(lvl){ case "principiante": return [0.5,0.6,0.7,0.8,0.9,1.0]; case "intermedio": return [0.6,0.7,0.8,0.9,1.0]; case "avanzato": return [0.7,0.8,0.9,1.0]; default: return [0.6,0.8,1.0]; }
}
function generaAllenamentiCorsa(num){ const base=["üèÉ Corsa facile","‚õ∞Ô∏è Ripetute collinari","üèÉ Progressivo","üèÉ Medio costante","‚õ∞Ô∏è Lungo trail","üèÉ Fondo lento","üèÉ Fartlek naturale"]; const res=[]; for(let i=0;i<num;i++) res.push(base[i%base.length]); return res; }

// ===== Generazione piano dinamico =====
function generaPianoFromSettings(){
  const s = state.settings;
  const prog = progressione(s.livello);
  const giorniSettimana=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
  const giorniPalestra = s.giorniPalestra.slice();
  const allenTot = s.allenTot;

  const plan = [];
  for(let w=1; w<=s.settimane; w++){
    const p = prog[Math.min(w-1, prog.length-1)];
    // settimana di scarico se piano >6 settimane e ogni 4 settimane
    let scarico = (s.settimane>6 && w%4===0) ? 0.7 : 1;
    const targetKm = +(s.obbKm*p*scarico).toFixed(1);
    const targetAsc = Math.round(s.obbAsc*p*scarico);

    // distribuzione allenamenti
    const giorniCorsaNum = Math.max(0, allenTot - giorniPalestra.length);
    const corsaList = generaAllenamentiCorsa(giorniCorsaNum);
    let corsaIdx=0;
    const settimanaArr = [];
    for(const g of giorniSettimana){
      if(giorniPalestra.includes(g)){
        settimanaArr.push(`${g} ‚Äì üèãÔ∏è Palestra (Forza & Core)`);
      }else{
        if(corsaIdx<corsaList.length && settimanaArr.filter(x=>x.includes("‚Äì") && !x.includes("Riposo")).length<allenTot){
          settimanaArr.push(`${g} ‚Äì ${corsaList[corsaIdx++]}`);
        }else{
          settimanaArr.push(`${g} ‚Äì Riposo`);
        }
      }
    }
    plan.push({settimana:w,targetKm,targetAsc,allenamenti:settimanaArr,completato:false});
  }
  state.planData=plan;
  saveState();
  renderAll();
}

// ===== Render =====
function renderSummary(){
  const summaryCard=document.getElementById("topSummaryCard");
  if(!state.planData||state.planData.length===0){ summaryCard.style.display="none"; return; }
  summaryCard.style.display="block";
  const s=state.settings;
  const giorniP=s.giorniPalestra.length;
  const corsa=Math.max(0,s.allenTot-giorniP);
  document.getElementById("summaryText").textContent=`Allenamenti/settimana: ${s.allenTot} ‚Äî Palestra: ${giorniP} ‚Äî Corsa: ${corsa}`;
}

function renderPiano(){
  const div=document.getElementById("planView"); div.innerHTML="";
  if(!state.planData||state.planData.length===0){ div.textContent="Nessun piano ancora generato."; return; }
  state.planData.forEach(w=>{
    const week=document.createElement("div"); week.className="week";
    week.innerHTML=`<h3>üìÖ Settimana ${w.settimana} ‚Äì Target: ${w.targetKm} km / +${w.targetAsc} m ${w.completato?"‚úÖ":""}</h3>`;
    const days=document.createElement("div"); days.className="days";
    w.allenamenti.forEach(a=>{ const dd=document.createElement("div"); dd.textContent=a; days.appendChild(dd); });
    week.appendChild(days);
    week.querySelector("h3").onclick=()=>days.style.display=(days.style.display==="block"?"none":"block");
    div.appendChild(week);
  });
}

function renderProgress(){
  const c=document.getElementById("progressChart"), ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const totalTargetKm=state.planData.reduce((acc,w)=>acc+(w.targetKm||0),0)||state.settings.obbKm;
  const percKm=Math.min(state.progress.km/totalTargetKm,1);
  ctx.fillStyle="#007aff"; ctx.fillRect(20,50,(c.width-40)*percKm,20);
  ctx.fillStyle="#ccc"; ctx.fillRect(20+(c.width-40)*percKm,50,(c.width-40)*(1-percKm),20);
  ctx.fillStyle="#000"; ctx.fillText(`Km: ${state.progress.km.toFixed(1)} / ${totalTargetKm} km`,20,45);
  ctx.fillText(`D+: ${state.progress.ascent.toFixed(0)} m`,20,95);
  document.getElementById("chartText").textContent=`Storico: ${state.history.length} allenamenti caricati.`;
}

function renderHistory(){
  const div=document.getElementById("historyList");
  if(!state.history||state.history.length===0){ div.textContent="Nessun allenamento registrato."; return; }
  div.innerHTML=state.history.map(h=>`${h.date} ‚Üí ${h.km.toFixed(1)} km, +${h.asc.toFixed(0)} m (${h.filename})`).join("<br>");
}

function renderAll(){ renderSummary(); renderPiano(); renderProgress(); renderHistory(); }

// ===== Eventi =====
document.getElementById("toggleSettings").onclick=()=>{
  const content=document.getElementById("settingsContent");
  const btn=document.getElementById("toggleSettings");
  if(content.style.display==="none"){ content.style.display="block"; btn.textContent="Nascondi"; }
  else{ content.style.display="none"; btn.textContent="Mostra"; }
};

document.getElementById("genLocal").onclick=()=>{
  const s=state.settings;
  s.livello=document.getElementById("livello").value;
  s.obbKm=+document.getElementById("obbKm").value;
  s.obbAsc=+document.getElementById("obbD+").value;
  s.settimane=+document.getElementById("settimane").value;
  s.allenTot=+document.getElementById("allenTot").value;
  s.giorniPalestra=[...document.querySelectorAll("#giorniPalestra input:checked")].map(x=>x.value);
  if(!s.obbKm||!s.obbAsc){ alert("Inserisci obiettivi gara."); return; }
  generaPianoFromSettings();
};

document.getElementById("fitFile").addEventListener("change", async(ev)=>{
  const file=ev.target.files[0]; if(!file) return;
  const info=document.getElementById("fitInfo"); info.textContent="‚è≥ Lettura file...";
  try{
    const ab=await file.arrayBuffer();
    const parser=new FitParser();
    parser.parse(ab,(e,data)=>{
      if(e){info.textContent="Errore file"; return;}
      const s=data.sessions?.[0]; if(!s) return;
      state.progress.km+=s.total_distance||0;
      state.progress.ascent+=s.total_ascent||0;
      const date=new Date().toLocaleDateString("it-IT");
      state.history.unshift({date,km:s.total_distance||0,asc:s.total_ascent||0,filename:file.name});
      // aggiornamento completamento settimane dinamico
      let cumKm=0;
      state.planData.forEach(w=>{ cumKm+=w.targetKm; w.completato=(state.progress.km>=cumKm); });
      saveState(); renderAll();
      info.textContent=`üèÅ Totale: ${state.progress.km.toFixed(1)} km / +${state.progress.ascent.toFixed(0)} m`;
    });
  }catch(err){ info.textContent="Errore: "+err; }
});

// ===== Avvio =====
loadState(); renderAll();
</script>
</body>
</html>