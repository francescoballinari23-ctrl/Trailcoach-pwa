<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>üèîÔ∏è TrailCoach AI v17.2</title>
<meta name="theme-color" content="#000000">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    background:#fafafa; color:#111; margin:12px;
  }
  h1 { text-align:center; font-size:22px; margin:6px 0; }
  .card {
    background:#fff; border-radius:10px; padding:12px; margin:10px 0;
    box-shadow:0 1px 6px rgba(0,0,0,.06);
  }
  label { display:block; margin:8px 0 6px; font-weight:600; }
  input, select {
    width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;
    font-size:15px; box-sizing:border-box;
  }
  button {
    background:#007aff; color:#fff; border:none; padding:9px 14px;
    border-radius:8px; font-weight:600; cursor:pointer; font-size:14px;
  }
  button:hover { background:#005fd6; }
  button.reset { background:#ff3b30; margin-left:6px; }
  .week { 
    background:#f7f9ff; border-radius:8px; margin:8px 0;
    /* Rimosso padding-bottom:8px per farlo sembrare una "card" unica */
  }
  .days { margin-top:6px; padding: 0 10px 10px 10px; display: block; }
  .day { padding:6px 0; border-bottom:1px solid #eee; }
  .day:last-child { border-bottom: none; }
  .detail { background:#fff; border-radius:8px; padding:10px; margin-top:6px; border:1px solid #eee; }
  .chk-btn {
    background:#f2f2f2; border-radius:8px; padding:8px; text-align:center;
    cursor:pointer; border:1px solid transparent; font-weight:700;
  }
  .chk-btn.active { background:#007aff; color:#fff; border-color:#0060d6; }
  .checkbox-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:6px; }
  .checkbox-grid-bottom { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
  .muted { color:#666; font-size:13px; }
  button.small-btn {
    background:#eee; color:#007aff; border:1px solid #007aff;
    padding:6px 10px; font-size:13px; border-radius:8px; margin-left:8px;
  }
  button.small-btn:hover { background:#f0f6ff; }
  /* Stili aggiunti per la visualizzazione pulita del piano AI */
  .accordion {
    background-color: #2a5d84;
    color: white;
    cursor: pointer;
    padding: 12px;
    width: 100%;
    text-align: left;
    border: none;
    outline: none;
    transition: background-color 0.2s ease;
    border-radius: 8px 8px 0 0; /* Solo bordi superiori arrotondati */
    margin-top: 0;
    margin-bottom: 0;
    font-size: 16px;
    font-weight: 600;
  }
  .accordion.active, .accordion:hover {
    background-color: #357ca0;
  }
  .days.panel {
    background-color: #fcfcfc;
    overflow: hidden;
    padding-top: 10px;
    border-radius: 0 0 8px 8px; /* Solo bordi inferiori arrotondati */
    border: 1px solid #eee;
    border-top: none;
  }
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v17.2</h1>

<div style="text-align:center; margin-bottom:8px;">
  <button id="toggleSettings" style="display:none; background:#34c759;">‚öôÔ∏è Impostazioni</button>
</div>

<div class="card" id="settingsCard">
  <label>Livello atleta</label>
  <select id="livello">
    <option value="principiante">Principiante</option>
    <option value="intermedio">Intermedio</option>
    <option value="avanzato">Avanzato</option>
  </select>

  <label>Obiettivo distanza gara (km)</label>
  <input id="obbKm" type="number" value="42" />

  <label>Obiettivo dislivello gara (m)</label>
  <input id="obbAsc" type="number" value="2000" />

  <label>Durata piano (settimane)</label>
  <input id="settimane" type="number" value="12" min="1" max="52" />

  <label>Allenamenti totali a settimana (es. 4.5)</label>
  <input id="allenTot" type="number" step="0.5" value="4.5" min="2" max="7" />

  <label>Giorni palestra</label>
  <div class="checkbox-grid">
    <div class="chk-btn" data-day="Luned√¨">Lun</div>
    <div class="chk-btn" data-day="Marted√¨">Mar</div>
    <div class="chk-btn" data-day="Mercoled√¨">Mer</div>
  </div>
  <div class="checkbox-grid-bottom">
    <div class="chk-btn" data-day="Gioved√¨">Gio</div>
    <div class="chk-btn" data-day="Venerd√¨">Ven</div>
    <div class="chk-btn" data-day="Sabato">Sab</div>
    <div class="chk-btn" data-day="Domenica">Dom</div>
  </div>

  <div style="margin-top:10px;">
    <button id="genLocal">‚öôÔ∏è Genera piano</button>
    <button id="genAI">ü§ñ Genera con AI</button>
    <button id="resetData" class="reset">üóëÔ∏è Reset</button>
  </div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView" class="muted">Nessun piano ancora generato.</div>
</div>

<div class="card" id="aiPlanCard" style="display: none;">
  <h2><label>üìã Piano Generato (JSON)</label></h2>
  <div id="piano-generato"></div>
</div>

<input id="hiddenFileInput" type="file" accept=".gpx" style="display:none" />

<script>
const STORAGE_KEY="trailcoach_v17";
let STATE={settings:{},planData:[]};
const GIORNI=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
// ... [Altre funzioni utili (paceByLevel, saveState, loadState, ecc.)] ...

// Funzione di utility per la visualizzazione del piano interno (lasciata per compatibilit√†)
function renderPiano(){
  const c=document.getElementById("planView");
  if(!STATE.planData?.length){c.textContent="Nessun piano ancora generato.";return;}
  c.innerHTML="";
  STATE.planData.forEach(w=>{
    const wd=document.createElement("div"); wd.className="week";
    const h=document.createElement("h3");
    h.textContent=`üìÖ Settimana ${w.settimana} ‚Äî ${w.targetKm} km / +${w.targetAsc} m ${w.isScarico?"(Scarico)":""}`;
    wd.appendChild(h);
    const days=document.createElement("div"); days.className="days";

    w.allenamenti.forEach((a,idx)=>{
      const d=document.createElement("div"); d.className="day";
      const s=document.createElement("div");
      s.innerHTML=`<strong>${a.day}</strong> ‚Äî ${a.summary}`;
      // [Logica per dettagli e GPX...]
      d.appendChild(s);
      const det=document.createElement("div"); det.className="detail"; det.style.display="none";
      if(a.details){
        let gpxTxt=a.details.gpx?`<div class="muted">üìà GPX caricato: ${a.details.gpx.km} km ‚Ä¢ +${a.details.gpx.asc} m</div>`:"";
        det.innerHTML=`<div><em>${a.details.detailText}</em></div>
        <div class="muted">Obiettivo: ${a.details.distance} km ‚Ä¢ +${a.details.ascent} m ‚Ä¢ ${a.details.durationMin} min</div>${gpxTxt}`;
      }
      d.appendChild(det);
      days.appendChild(d);
    });
    wd.appendChild(days);
    h.onclick=()=>{days.style.display=days.style.display==="block"?"none":"block";};
    c.appendChild(wd);
  });
}
// ... [Resto delle funzioni (generaPiano, uploadGPX, ecc.)] ...

// üõ†Ô∏è FUNZIONE AGGIUNTA/MODIFICATA: Visualizzazione del JSON Esterno
/**
/**
 * Funzione per convertire e visualizzare il testo JSON esterno (dall'AI o da input).
 * @param {string} jsonString - La stringa JSON da tradurre.
 */
function renderExternalPlan(jsonString) {
    const container = document.getElementById("piano-generato");
    const card = document.getElementById("aiPlanCard");
    container.innerHTML = ""; // Pulisce il contenuto precedente
    
    let piano;
    let cleanText = jsonString; // Inizia col testo grezzo
    card.style.display = 'block';

    try {
        // 1. Pulizia ESTREMA per rimuovere blocchi di codice Markdown e newline di escape
        // Rimuove blocchi di codice Markdown (```json ... ```) se presenti
        const match = jsonString.match(/```json([\s\S]*?)```/);
        if (match) {
            cleanText = match[1];
        } else {
            // Se non c'√® Markdown, tenta di estrarre il blocco JSON tra la prima { e l'ultima }
            cleanText = jsonString.substring(jsonString.indexOf('{'), jsonString.lastIndexOf('}') + 1);
        }
        
        // Rimuove tutti i caratteri newline e di escape dei newline
        cleanText = cleanText
            .replace(/\\n/g, "")
            .replace(/\n/g, "")
            .replace(/\r/g, "")
            .trim();
        
        // Tenta il parsing
        piano = JSON.parse(cleanText);
    } catch (e) {
        // In caso di errore di parsing, mostra il testo pulito per il debug
        container.innerHTML = `
            <p style="color:red;">‚ùå Errore nel formato JSON. Impossibile eseguire JSON.parse().</p>
            <p class="muted">Testo pulito (da debug):</p>
            <pre style="white-space: pre-wrap; background: #ffebeb; padding: 10px; border: 1px solid red; border-radius: 5px;">${cleanText}</pre>
            <p class="muted">Errore: ${e.message}</p>
        `;
        return;
    }

    // 2. Controllo dell'array 'settimane' (Qui √® dove falliva precedentemente)
    if (!piano.settimane || !Array.isArray(piano.settimane)) {
        container.innerHTML = `
            <p style="color:red;">‚ö†Ô∏è Struttura JSON valida, ma manca la chiave "settimane" o non √® un array.</p>
            <p class="muted">Assicurati che l'AI usi SEMPRE la chiave "settimane".</p>
        `;
        return;
    }

    // 3. Generazione Descrizione Generale
    // Il resto della funzione rimane invariato
    let htmlOutput = `<div class="card"><label>Descrizione Generale</label><div class="muted">${piano.descrizione_generale || "Nessuna descrizione fornita."}</div></div>`;

    // 4. Iterazione e Generazione Settimane
    piano.settimane.forEach(w => {
        const totalKm = w.allenamenti ? w.allenamenti.reduce((sum, a) => sum + (a.km || 0), 0).toFixed(1) : 0;
        
        htmlOutput += `
            <div class="week">
                <div class="accordion">üìÖ Settimana ${w.numero} ‚Äî ${w.focus || "Nessun focus"} (${totalKm} km)</div>
                <div class="days panel">
                    ${w.allenamenti.map(a => `
                        <div class="day">
                            <div><strong>${a.tipo}</strong> ‚Äî ${a.km !== undefined ? a.km + ' km' : 'N/A'}</div>
                            <div class="muted">${a.dettagli || 'Nessun dettaglio'}</div>
                        </div>
                    `).join("")}
                </div>
            </div>
        `;
    });

    container.innerHTML = htmlOutput;
    
    // 5. Riattiva l'Accordion
    document.querySelectorAll(".accordion").forEach(btn => {
      btn.addEventListener("click", function() {
        this.classList.toggle("active");
        const panel = this.nextElementSibling;
        const isVisible = panel.style.display === "block";
        panel.style.display = isVisible ? "none" : "block";
      });
    });
}


// üõ†Ô∏è FUNZIONE MODIFICATA: Cattura il risultato AI (simulato) e lo passa a renderExternalPlan
async function generaPianoAI() {
  // ... [Il tuo codice per raccogliere i dati di input] ...
  const container = document.getElementById("piano-generato");
  container.innerHTML = "<p>‚è≥ Generazione piano AI in corso‚Ä¶</p>";
  document.getElementById("aiPlanCard").style.display = 'block';

  try {
    const response = await fetch("https://eoakctnc24hsvp9.m.pipedream.net", {
      // ... [corpo della richiesta] ...
    });

    if (!response.ok) throw new Error("Errore nella richiesta AI");
    const rawText = await response.text();

    // üéØ Passa la stringa grezza alla funzione di rendering esterno
    renderExternalPlan(rawText); 

  } catch (err) {
    console.error(err);
    container.innerHTML = `<p style="color:red;">‚ùå Errore durante la generazione AI: ${err.message}</p>`;
  }
}

// TEST DI INIZIALIZZAZIONE (Puoi rimuovere questo blocco se usi solo il pulsante AI)
document.addEventListener('DOMContentLoaded', () => {
    // [La tua logica di caricamento STATE e renderPiano va qui...]
    
    // ‚ö†Ô∏è Blocco per la visualizzazione immediata del piano JSON di test
    const testoJSONCorretto = `
{
  "descrizione_generale": "Piano di allenamento per principianti, focalizzato sul completamento di un trail di 32km con 2000m D+ in 12 settimane. L'allenamento √® strutturato per aumentare gradualmente il volume e la difficolt√†, con un focus sulla corsa lenta, camminata in salita e discesa controllata. Importante: Ascolta il tuo corpo e riposa quando necessario. Adatta il piano in base alle tue sensazioni. Questo piano non include allenamento in palestra. Concentrati sull'alimentazione e sull'idratazione.",
  "settimane": [
    {
      "numero": 1,
      "focus": "Costruzione della base aerobica e adattamento al terreno.",
      "allenamenti": [
        { "tipo": "Corsa lenta", "km": 6, "dettagli": "Terreno misto (strada/sterrato). Ritmo molto confortevole, che permetta di parlare." },
        { "tipo": "Camminata in salita", "km": 4, "dettagli": "Percorso collinare con dislivello moderato (150-200m D+). Alternare camminata veloce e corsa leggera." },
        { "tipo": "Corsa lenta", "km": 5, "dettagli": "Terreno pianeggiante. Ritmo confortevole." },
        { "tipo": "Riposo/Cross-training", "km": 0, "dettagli": "Attivit√† leggera come camminata, yoga, nuoto. Ascolta il tuo corpo." },
        { "tipo": "Lunghetto", "km": 8, "dettagli": "Terreno misto. Alterna corsa lenta e camminata in salita se necessario." }
      ]
    },
    {
      "numero": 2,
      "focus": "Aumento del volume e introduzione di dislivello.",
      "allenamenti": [
        { "tipo": "Corsa lenta", "km": 7, "dettagli": "Terreno misto. Ritmo molto confortevole." },
        { "tipo": "Camminata in salita", "km": 5, "dettagli": "Percorso collinare con dislivello (200-250m D+). Concentrati sulla tecnica." },
        { "tipo": "Corsa lenta", "km": 6, "dettagli": "Terreno pianeggiante." },
        { "tipo": "Riposo/Cross-training", "km": 0, "dettagli": "Attivit√† leggera." },
        { "tipo": "Lunghetto", "km": 10, "dettagli": "Terreno misto con un po' di dislivello." }
      ]
    },
    {
      "numero": 12,
      "focus": "GARA!",
      "allenamenti": [
        { "tipo": "Gara", "km": 32, "dettagli": "32km con 2000m D+. Dai il massimo!" },
        { "tipo": "Riposo", "km": 0, "dettagli": "Recupero post-gara." },
        { "tipo": "Riposo", "km": 0, "dettagli": "Recupero post-gara." },
        { "tipo": "Riposo", "km": 0, "dettagli": "Recupero post-gara." },
        { "tipo": "Camminata leggera", "km": 3, "dettagli": "Camminata defaticante." }
      ]
    }
  ]
}
`;
    // Disattivare la visualizzazione del piano interno all'avvio:
    document.getElementById("planView").style.display = 'none';

    // ‚û°Ô∏è Chiama la funzione di rendering per visualizzare il piano di test all'apertura.
    // Rimuovi o commenta questa riga se vuoi che il piano appaia solo dopo aver cliccato "Genera con AI".
    renderExternalPlan(testoJSONCorretto); 
});

document.getElementById("genAI").addEventListener("click", generaPianoAI);
// ... [Il resto della tua logica e chiusura script] ...
</script>

</body>
</html>
