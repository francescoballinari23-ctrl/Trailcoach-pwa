<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI - Minimal</title>
<style>
/* Stili essenziali */
:root{--card-radius:12px;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;}
h1{text-align:center;font-size:22px;margin:6px 0;}
.card{background:#fff;border-radius:var(--card-radius);padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.06);}
label{display:block;margin:8px 0 6px;font-weight:600;}
input[type="number"], select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box;}
button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:8px;cursor:pointer;}
.week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
.days{margin-top:6px;padding-left:10px;}
.days .day{padding:6px 0;border-bottom:1px solid #eee;}
.detail{background:#fff;border-radius:8px;padding:10px;margin:6px 0 10px;border:1px solid #eee;font-size:14px;}
.muted{color:#666;font-size:13px;}
.checkbox-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;}
.checkbox-grid-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;}
.chk-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;background:#f2f2f2;cursor:pointer;border:1px solid transparent;font-weight:700;}
.chk-btn.active{background:#007aff;color:#fff;border-color:#0060d6;}
</style>
</head>
<body>
<h1>🏔️ TrailCoach AI - Minimal</h1>

<div class="card" id="settingsCard">
    <span style="font-weight:600;">⚙️ Impostazioni</span>
    <div id="settingsContent">
        <label>Livello atleta</label>
        <select id="livello"><option value="principiante">Principiante</option><option value="intermedio">Intermedio</option><option value="avanzato">Avanzato</option></select>
        <label>Obiettivo distanza gara (km)</label>
        <input id="obbKm" type="number" value="20" placeholder="es. 20" />
        <label>Obiettivo dislivello gara (m)</label>
        <input id="obbAsc" type="number" value="1000" placeholder="es. 1000" />
        <label>Durata piano (settimane)</label>
        <input id="settimane" type="number" value="8" min="1" max="52" />
        <label>Allenamenti totali a settimana</label>
        <input id="allenTot" type="number" value="4" min="2" max="7" />
        <div class="muted" style="margin-top:-6px;">*Include sessioni di corsa e palestra.</div>

        <label>Giorni palestra (toggle)</label>
        <div>
            <div class="checkbox-grid" id="palestraTop">
                <div class="chk-btn" data-day="Lunedì">Lun</div>
                <div class="chk-btn" data-day="Martedì">Mar</div>
                <div class="chk-btn" data-day="Mercoledì">Mer</div>
            </div>
            <div class="checkbox-grid-bottom" id="palestraBottom">
                <div class="chk-btn" data-day="Giovedì">Gio</div>
                <div class="chk-btn" data-day="Venerdì">Ven</div>
                <div class="chk-btn" data-day="Sabato">Sab</div>
                <div class="chk-btn" data-day="Domenica">Dom</div>
            </div>
        </div>
        <div style="margin-top:8px;"><button id="genLocal" class="save">⚙️ Genera piano</button></div>
    </div>
</div>

<div class="card">
    <label>Piano settimanale</label>
    <div id="planView" class="small">Nessun piano ancora generato.</div>
</div>

<script>
const GIORNI = ["Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato","Domenica"];

function formatTime(mins){ const h=Math.floor(mins/60); const m=Math.round(mins%60); return h>0?`${h}h ${m}m`:`${m}m`; }
function paceByLevel(lvl){ return lvl==="principiante"?6 : lvl==="intermedio"?5.5 : 5; }

function creaDettagliAllenamento(type, weeklyKm, weeklyAsc, livello, isScarico, fractionFactor=1){
    let dist=0, asc=0; 
    const pace=paceByLevel(livello);
    if(type==="Lungo trail"){ dist=weeklyKm*0.6*fractionFactor; asc=weeklyAsc*0.6*fractionFactor; }
    else if(type==="Fondo lento"){ dist=weeklyKm*0.1*fractionFactor; asc=weeklyAsc*0.1*fractionFactor; }
    else { dist=weeklyKm*0.3*fractionFactor; asc=weeklyAsc*0.3*fractionFactor; }
    if(isScarico){ dist*=0.7; asc*=0.7; }
    dist = Math.max(0, dist); asc = Math.max(0, asc);
    let detailsText="";
    if(type==="Lungo trail") detailsText="Lungo: ritmo lento, endurance, salita costante";
    else if(type==="Fartlek") detailsText="Fartlek: alternare 2–3' veloce / 2' lento";
    else if(type==="Medio costante") detailsText="Medio: ritmo sostenuto per la maggior parte della distanza";
    else if(type==="Progressivo") detailsText="Progressivo: aumenta ritmo negli ultimi km";
    else if(type==="Ripetute") detailsText=`${Math.min(12, Math.max(4, Math.round(dist/2)))}×400 m in salita, recupero 90–120s`;
    else detailsText="Ritmo facile, tecnica e recupero";
    return { distance:+dist.toFixed(1), ascent:Math.round(asc), durationMin:Math.round(dist*pace), detailText };
}

function tipoAllenamentoForDay(day, runIndex, totalRuns){
    const runTypes = ["Fartlek", "Ripetute", "Progressivo", "Medio costante", "Fondo lento"];
    if(day==="Domenica" && totalRuns > 1) return "Lungo trail";
    if(totalRuns >= 3 && day === "Sabato") return "Medio costante";
    return runTypes[runIndex % runTypes.length];
}

function generaPiano(settings){
    const plan=[];
    const totaleSettimane=settings.settimane;
    const gymDaysCount = settings.giorniPalestra.length;
    
    for(let w=1; w<=totaleSettimane; w++){
        const isScarico=(w===totaleSettimane-1);
        let targetKm=settings.obbKm*(w/totaleSettimane);
        let targetAsc=settings.obbAsc*(w/totaleSettimane);
        if(w === totaleSettimane) { targetKm=0; targetAsc=0; }
        
        const freeDays=GIORNI.filter(d=>!settings.giorniPalestra.includes(d));
        let totalRuns = Math.min(Math.max(0, settings.allenTot - gymDaysCount), freeDays.length);
        
        // Logica Extra Week (solo se ci sono giorni liberi)
        let isExtraRunWeek = false;
        let extraRunDay = null; 
        if (w % 2 === 0 && w < totaleSettimane && totalRuns < freeDays.length) {
            isExtraRunWeek = true;
            const assignedRunDays = freeDays.slice(0, totalRuns);
            extraRunDay = freeDays.find(day => !assignedRunDays.includes(day));
            if (extraRunDay) { totalRuns++; } else { isExtraRunWeek = false; }
        }
        const runDays = freeDays.slice(0, totalRuns);

        const settimana=[];
        let runIndex=0;
        for(const day of GIORNI){
            if(settings.giorniPalestra.includes(day)){
                settimana.push({ day,type:"Palestra",summary:"🏋️ Palestra",details:{ note:"Forza & Core" }});
            } else if(runDays.includes(day)){
                let type, factor = 1;
                const isCurrentDayExtra = isExtraRunWeek && day === extraRunDay;
                if (isCurrentDayExtra) {
                    type = "Fondo lento"; factor = 0.5;
                } else {
                    type = tipoAllenamentoForDay(day, runIndex, totalRuns);
                    runIndex++;
                }
                
                const det=creaDettagliAllenamento(type,targetKm,targetAsc,settings.livello,isScarico, factor);
                let summaryText = `🏃 ${type} — ${det.distance} km`;
                if(w === totaleSettimane && day === "Domenica") summaryText = "🏆 GARA - Ritiro pettorale";
                if(isCurrentDayExtra) summaryText += " (Extra)";

                settimana.push({ day,type:"Corsa",summary:summaryText,details:det});
            } else {
                settimana.push({ day,type:"Riposo",summary:"Riposo",details:{ note:"Recupero" }});
            }
        }
        plan.push({ settimana:w,targetKm:+targetKm.toFixed(1),allenamenti:settimana});
    }
    return plan;
}

function renderAll(planData){
    const planView=document.getElementById("planView");
    if(!planData || !planData.length){ planView.innerHTML="Nessun piano ancora generato."; return; }
    planView.innerHTML="";
    planData.forEach(s=>{
        const wDiv=document.createElement("div"); wDiv.className="week";
        const h=document.createElement("h3");
        let title = `Settimana ${s.settimana} — ${s.targetKm} km`;
        if (s.settimana % 2 === 0) { title += " ✨"; }
        h.innerHTML=title;
        wDiv.appendChild(h);
        const d=document.createElement("div"); d.className="days"; 
        s.allenamenti.forEach(a=>{
            const dayDiv=document.createElement("div"); dayDiv.className="day";
            dayDiv.innerHTML=`${a.day}: <strong>${a.summary}</strong>`;
            if(a.type==="Corsa" && a.details.distance > 0){
                dayDiv.innerHTML+=`<br><span class="muted">${a.details.distance} km | ${a.details.ascent} m D+ | ${formatTime(a.details.durationMin)}</span>`;
            }
            if(a.details.detailText) dayDiv.innerHTML+=`<div class="detail">${a.details.detailText}</div>`;
            d.appendChild(dayDiv);
        });
        wDiv.appendChild(d);
        planView.appendChild(wDiv);
    });
}

// ---------------------- Eventi ----------------------
function handleToggle(btn) {
    btn.classList.toggle("active");
}

document.querySelectorAll(".chk-btn").forEach(btn => btn.addEventListener("click", () => handleToggle(btn)));

document.getElementById("genLocal").addEventListener("click",()=>{
    const lvl=document.getElementById("livello").value;
    const km=parseFloat(document.getElementById("obbKm").value) || 0.0;
    const asc=parseFloat(document.getElementById("obbAsc").value) || 0.0;
    const settimane=parseInt(document.getElementById("settimane").value) || 8;
    const allenTot=parseInt(document.getElementById("allenTot").value) || 4;
    const palestra=Array.from(document.querySelectorAll(".chk-btn.active")).map(b=>b.dataset.day);

    if(km === 0 || asc === 0){ alert("Inserisci km e dislivello validi."); return; }
    
    const settings = { livello:lvl, obbKm:km, obbAsc:asc, settimane:settimane, allenTot, giorniPalestra:palestra };
    const plan = generaPiano(settings);
    renderAll(plan);
});
</script>
</body>
</html>
