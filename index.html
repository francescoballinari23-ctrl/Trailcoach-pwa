<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrailCoach v13</title>
<link rel="manifest" href="manifest.json">
<script src="fit-parser.min.js"></script> <!-- ‚úÖ Parser locale -->
<style>
body {
  font-family: Arial, sans-serif;
  background: #f9f9f9;
  color: #333;
  padding: 20px;
}
h1 {
  text-align: center;
}
button {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 5px;
  cursor: pointer;
  margin: 5px;
}
button:hover { background: #0056b3; }
#output {
  background: #fff;
  border-radius: 6px;
  padding: 15px;
  margin-top: 15px;
}
.giorno-btn.active {
  background: #28a745;
}
.file-upload {
  background: #eee;
  padding: 12px;
  border-radius: 8px;
}
</style>
</head>
<body>

<h1>üèîÔ∏è TrailCoach v13</h1>

<div class="file-upload">
  <h3>üìÇ Carica file attivit√† (.FIT o .GPX)</h3>
  <input type="file" id="fileInput" accept=".fit,.gpx" />
</div>

<div>
  <h3>üí™ Giorni di palestra</h3>
  <div id="giorniPalestra"></div>
</div>

<div>
  <h3>üìÖ Imposta durata piano</h3>
  <input type="number" id="settimane" value="4" min="1" max="12"> settimane
</div>

<button id="generaPiano">Genera Piano</button>

<div id="output"></div>

<script>
// ============ VARIABILI GLOBALI ============
let STATE = {
  fitData: null,
  gpxData: null,
  giorniPalestra: [],
  settimane: 4,
};

// ============ INIZIALIZZAZIONE ============
document.addEventListener("DOMContentLoaded", () => {
  initPalestra();
  document.getElementById("generaPiano").addEventListener("click", generaPiano);
  document.getElementById("fileInput").addEventListener("change", handleFileUpload);
});

// ============ SELEZIONE GIORNI PALESTRA ============
function initPalestra() {
  const giorni = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];
  const container = document.getElementById("giorniPalestra");
  giorni.forEach((giorno, i) => {
    const btn = document.createElement("button");
    btn.textContent = giorno;
    btn.className = "giorno-btn";
    btn.onclick = () => {
      btn.classList.toggle("active");
      updateGiorniPalestra();
    };
    container.appendChild(btn);
  });
}

function updateGiorniPalestra() {
  STATE.giorniPalestra = Array.from(document.querySelectorAll(".giorno-btn.active")).map(
    btn => btn.textContent
  );
}

// ============ CARICAMENTO FILE FIT o GPX ============
async function handleFileUpload(evt) {
  const file = evt.target.files[0];
  if (!file) return;

  const ext = file.name.split(".").pop().toLowerCase();
  const arrayBuffer = await file.arrayBuffer();

  if (ext === "fit") {
    parseFIT(arrayBuffer);
  } else if (ext === "gpx") {
    parseGPX(arrayBuffer);
  } else {
    alert("Formato non supportato. Usa .FIT o .GPX");
  }
}

// ============ PARSING FIT ============
function parseFIT(arrayBuffer) {
  try {
    const fitParser = new FitParser({
      force: true,
      speedUnit: "km/h",
      lengthUnit: "km",
      temperatureUnit: "celsius",
      elapsedRecordField: true,
    });

    fitParser.parse(arrayBuffer, function (error, data) {
      if (error) {
        alert("Errore nel parsing FIT: " + error);
        console.error(error);
        return;
      }

      STATE.fitData = data;
      console.log("Dati FIT:", data);

      // Convertiamo in un formato GPX-like per analisi locale
      STATE.gpxData = convertFITtoGPXLike(data);
      mostraInfoAttivit√†(STATE.gpxData);
    });
  } catch (err) {
    alert("Errore FIT parser non caricato correttamente.");
    console.error(err);
  }
}

// ============ CONVERSIONE FIT ‚Üí GPX-LIKE ============
function convertFITtoGPXLike(fit) {
  const records = fit.records || [];
  let totalDistance = 0;
  let totalAscent = 0;
  let totalDescent = 0;

  for (let i = 1; i < records.length; i++) {
    const prev = records[i - 1];
    const curr = records[i];
    if (curr.distance && prev.distance) {
      totalDistance = curr.distance;
    }
    if (curr.altitude && prev.altitude) {
      const diff = curr.altitude - prev.altitude;
      if (diff > 0) totalAscent += diff;
      else totalDescent += Math.abs(diff);
    }
  }

  return {
    distanza: (totalDistance / 1000).toFixed(2), // km
    salita: Math.round(totalAscent),
    discesa: Math.round(totalDescent),
    durata: fit.activity?.timestamp ? fit.activity.timestamp : "ND",
  };
}

// ============ PARSING GPX ============
function parseGPX(arrayBuffer) {
  const text = new TextDecoder().decode(arrayBuffer);
  const xml = new DOMParser().parseFromString(text, "text/xml");
  const trkpts = xml.getElementsByTagName("trkpt");

  let totalDist = 0, totalUp = 0, totalDown = 0;
  let lastLat = null, lastLon = null, lastEle = null;

  for (let i = 0; i < trkpts.length; i++) {
    const el = trkpts[i];
    const lat = parseFloat(el.getAttribute("lat"));
    const lon = parseFloat(el.getAttribute("lon"));
    const ele = parseFloat(el.getElementsByTagName("ele")[0]?.textContent || 0);

    if (lastLat != null) {
      const d = haversine(lastLat, lastLon, lat, lon);
      totalDist += d;
      const diff = ele - lastEle;
      if (diff > 0) totalUp += diff;
      else totalDown += Math.abs(diff);
    }

    lastLat = lat; lastLon = lon; lastEle = ele;
  }

  STATE.gpxData = {
    distanza: (totalDist / 1000).toFixed(2),
    salita: Math.round(totalUp),
    discesa: Math.round(totalDown),
    durata: "ND"
  };
  mostraInfoAttivit√†(STATE.gpxData);
}

// ============ FUNZIONI DI SUPPORTO ============
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI/180;
  const œÜ2 = lat2 * Math.PI/180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI/180;
  const ŒîŒª = (lon2 - lon1) * Math.PI/180;

  const a = Math.sin(ŒîœÜ/2)**2 +
            Math.cos(œÜ1)*Math.cos(œÜ2)*
            Math.sin(ŒîŒª/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // metri
}

// ============ MOSTRA DATI ATTIVIT√Ä ============
function mostraInfoAttivit√†(data) {
  const out = document.getElementById("output");
  out.innerHTML = `
    <h3>üìä Dati Attivit√†</h3>
    <p><b>Distanza:</b> ${data.distanza} km</p>
    <p><b>Salita:</b> ${data.salita} m</p>
    <p><b>Discesa:</b> ${data.discesa} m</p>
  `;
}

// ============ GENERA PIANO ============
function generaPiano() {
  const settimane = parseInt(document.getElementById("settimane").value) || 4;
  const giorni = STATE.giorniPalestra.length > 0 ? STATE.giorniPalestra : ["Lun", "Mer", "Ven"];

  let piano = `<h3>üèãÔ∏è Piano ${settimane} settimane</h3><ul>`;
  for (let s = 1; s <= settimane; s++) {
    piano += `<li><b>Settimana ${s}</b>: ${giorni.join(", ")}</li>`;
  }
  piano += "</ul>";

  document.getElementById("output").innerHTML = piano;
}
</script>
</body>
</html>