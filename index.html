<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v15.4</title>
<meta name="theme-color" content="#000000">
<style>
:root{--card-radius:12px;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;}
h1{text-align:center;font-size:22px;margin:6px 0;}
.card{background:#fff;border-radius:var(--card-radius);padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.06);}
label{display:block;margin:8px 0 6px;font-weight:600;}
input[type="number"], select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box;}
button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:8px;cursor:pointer;}
button.reset{background:#ff3b30;margin-left:8px;}
.week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
.week h3{margin:0;cursor:pointer;font-size:17px;display:flex;justify-content:space-between;align-items:center;}
.days{margin-top:6px;padding-left:10px;display:none;}
.days .day{padding:6px 0;border-bottom:1px solid #eee;}
.small{font-size:13px;color:#666;margin-top:6px;}
.toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:6px 10px;font-size:13px;margin-top:-4px;}
.checkbox-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;}
.checkbox-grid-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;}
.chk-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;background:#f2f2f2;cursor:pointer;border:1px solid transparent;font-weight:700;}
.chk-btn.active{background:#007aff;color:#fff;border-color:#0060d6;}
.detail{background:#fff;border-radius:8px;padding:10px;margin:6px 0 10px;border:1px solid #eee;font-size:14px;}
.muted{color:#666;font-size:13px;}
.fileline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
.meta{font-size:13px;color:#333;margin-top:6px;}
.alert{background:#fff3cd;border:1px solid #ffeeba;padding:8px;border-radius:8px;margin-top:8px;color:#856404;}
a.guide{color:#0060d6;text-decoration:underline;}
</style>
</head>
<body>
<h1>ğŸ”ï¸ TrailCoach AI v15.4</h1>

<div class="card" id="topSummaryCard" style="display:none;">
Â  <div id="summaryText" class="muted"></div>
</div>

<div class="card" id="settingsCard">
Â  <div>
Â  Â  <span style="font-weight:600;">âš™ï¸ Impostazioni</span>
Â  Â  <button id="toggleSettings" class="toggle-btn" aria-expanded="true">Nascondi</button>
Â  </div>
Â  <div id="settingsContent">
Â  Â  <label>Livello atleta</label>
Â  Â  <select id="livello">
Â  Â  Â  <option value="principiante">Principiante</option>
Â  Â  Â  <option value="intermedio">Intermedio</option>
Â  Â  Â  <option value="avanzato">Avanzato</option>
Â  Â  </select>

Â  Â  <label>Obiettivo distanza gara (km)</label>
Â  Â  <input id="obbKm" type="number" placeholder="es. 20" />

Â  Â  <label>Obiettivo dislivello gara (m)</label>
Â  Â  <input id="obbAsc" type="number" placeholder="es. 1000" />

Â  Â  <label>Durata piano (settimane)</label>
Â  Â  <input id="settimane" type="number" value="8" min="1" max="52" />

Â  Â  <label>Allenamenti totali a settimana</label>
Â  Â  <input id="allenTot" type="number" value="4" min="2" max="7" />

Â  Â  <label>Giorni palestra (toggle)</label>
Â  Â  <div>
Â  Â  Â  <div class="checkbox-grid" id="palestraTop">
Â  Â  Â  Â  <div class="chk-btn" data-day="LunedÃ¬">Lun</div>
Â  Â  Â  Â  <div class="chk-btn" data-day="MartedÃ¬">Mar</div>
Â  Â  Â  Â  <div class="chk-btn" data-day="MercoledÃ¬">Mer</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="checkbox-grid-bottom" id="palestraBottom">
Â  Â  Â  Â  <div class="chk-btn" data-day="GiovedÃ¬">Gio</div>
Â  Â  Â  Â  <div class="chk-btn" data-day="VenerdÃ¬">Ven</div>
Â  Â  Â  Â  <div class="chk-btn" data-day="Sabato">Sab</div>
Â  Â  Â  Â  <div class="chk-btn" data-day="Domenica">Dom</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div style="margin-top:8px;">
Â  Â  Â  <button id="genLocal" class="save">âš™ï¸ Genera piano</button>
Â  Â  Â  <button id="resetData" class="reset">ğŸ—‘ï¸ Reset dati</button>
Â  Â  </div>
Â  </div>
</div>

<div class="card">
Â  <label>Avanzamento</label>
Â  <canvas id="progressChart" width="360" height="140"></canvas>
Â  <div id="chartText" class="small"></div>
</div>

<div class="card">
Â  <label>Piano settimanale</label>
Â  <div id="planView" class="small">Nessun piano ancora generato.</div>
</div>

<div class="card">
Â  <label>Storico allenamenti</label>
Â  <div id="historyList" class="small">Nessun allenamento registrato.</div>
</div>

<input id="hiddenFileInput" type="file" accept=".gpx" style="display:none" />

<script>
// ---------------------- Stato & storage ----------------------
const STORAGE_KEY = "trailcoach_v15_4_state";
const DEFAULT_STATE = {
Â  settings: { livello:"principiante", obbKm:20, obbAsc:1000, settimane:8, allenTot:4, giorniPalestra:[] },
Â  planData: [],
Â  progress: { km:0, ascent:0 },
Â  history: []
};
let STATE = JSON.parse(JSON.stringify(DEFAULT_STATE));
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ try{ STATE = JSON.parse(raw); }catch(e){ console.warn("loadState parse error", e); } } }

// ---------------------- Utility ----------------------
function formatTime(mins){ const h=Math.floor(mins/60); const m=Math.round(mins%60); return h>0?`${h}h ${m}m`:`${m}m`; }

// ---------------------- Core logica ----------------------
const GIORNI = ["LunedÃ¬","MartedÃ¬","MercoledÃ¬","GiovedÃ¬","VenerdÃ¬","Sabato","Domenica"];
function paceByLevel(lvl){ return lvl==="principiante"?6 : lvl==="intermedio"?5.5 : 5; }

function creaDettagliAllenamento(type, weeklyKm, weeklyAsc, livello, isScarico, fractionFactor=1){
Â  Â  let dist=0, asc=0;Â 
Â  Â  const pace=paceByLevel(livello);
Â  Â  // La frazione Ã¨ basata sulla presunzione di 3-4 corse, ma non Ã¨ perfettamente accurata
Â  Â  // Ho uniformato la divisione di base per la maggior parte delle corse (35% del totale settimanale)
Â  Â  // Il 'Lungo trail' prende il 60%
Â  Â  if(type==="Lungo trail"){ dist=weeklyKm*0.6*fractionFactor; asc=weeklyAsc*0.6*fractionFactor; }
Â  Â  else if(type==="Fondo lento"){ dist=weeklyKm*0.1*fractionFactor; asc=weeklyAsc*0.1*fractionFactor; }
Â  Â  else { dist=weeklyKm*0.3*fractionFactor; asc=weeklyAsc*0.3*fractionFactor; } // Tutti gli altri tipi usano 30%

Â  Â  if(isScarico){ dist*=0.7; asc*=0.7; }
Â  Â  
Â  Â  let detailsText="";
Â  Â  // Nota: i dettagli sono specificati qui, quindi se il tipo non Ã¨ in lista, non avrÃ  dettagli specifici
Â  Â  if(type==="Lungo trail") detailsText="Lungo: ritmo lento, endurance, salita costante";
Â  Â  else if(type==="Fartlek") detailsText="Fartlek: alternare 2â€“3' veloce / 2' lento";
Â  Â  else if(type==="Medio costante") detailsText="Medio: ritmo sostenuto per la maggior parte della distanza";
Â  Â  else if(type==="Progressivo") detailsText="Progressivo: aumenta ritmo negli ultimi km";
Â  Â  else if(type==="Ripetute") detailsText=`${Math.min(12, Math.max(4, Math.round(dist/2)))}Ã—400 m in salita, recupero 90â€“120s`;
Â  Â  else detailsText="Ritmo facile, tecnica e recupero";
Â  Â  
Â  Â  return { distance:+dist.toFixed(1), ascent:Math.round(asc), durationMin:Math.round(dist*pace), detailText };
}

// LOGICA AGGIORNATA PER LA VARIETÃ€
function tipoAllenamentoForDay(day, runIndex, totalRuns){
    // Tipi di corsa diversi da Long Trail e Fondo Lento
    const runTypes = ["Fartlek", "Ripetute", "Progressivo", "Medio costante"];
    const nonLongRunIndex = runIndex; // Indice per gli allenamenti non-lungo

    // 1. Assegna il Lungo trail/Medio nel weekend
    if(day==="Domenica" && totalRuns > 1) return "Lungo trail";
    // Se ci sono 3 o piÃ¹ corse, metti un Medio/Progressivo il sabato
    if(totalRuns >= 3 && day === "Sabato") return "Medio costante";

    // 2. Assegna gli allenamenti rimanenti
    // Usa l'indice modulo la lunghezza per ciclare i tipi
    const type = runTypes[nonLongRunIndex % runTypes.length];
    
    // Assegna "Fondo lento" se l'indice Ã¨ troppo grande (es. piÃ¹ di 5 allenamenti)
    if(runIndex >= runTypes.length) return "Fondo lento";

    return type;
}

function generaPiano(settings){
Â  Â  const plan=[];
Â  Â  const totaleSettimane=settings.settimane;
Â  Â  const provaGaraSettimana=Math.max(1,totaleSettimane-3);
Â  Â  const scaricoSettimana=totaleSettimane-1;

Â  Â  for(let w=1; w<=totaleSettimane; w++){
Â  Â  Â  Â  const isScarico=(w===scaricoSettimana);
Â  Â  Â  Â  const isProvaGara=(w===provaGaraSettimana);
Â  Â  Â  Â  let targetKm=settings.obbKm*(w/totaleSettimane);
Â  Â  Â  Â  let targetAsc=settings.obbAsc*(w/totaleSettimane);
Â  Â  Â  Â  
Â  Â  Â  Â  // Logica di tapering
Â  Â  Â  Â  if(w > totaleSettimane-3){ // Tapering
Â  Â  Â  Â  Â  Â  targetKm = settings.obbKm * (1 - (totaleSettimane - w) * 0.2); 
Â  Â  Â  Â  Â  Â  targetAsc = settings.obbAsc * (1 - (totaleSettimane - w) * 0.2); 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  targetKm=settings.obbKm*(w/totaleSettimane);
Â  Â  Â  Â  Â  Â  targetAsc=settings.obbAsc*(w/totaleSettimane);
Â  Â  Â  Â  }
Â  Â  Â  Â  if(w === totaleSettimane) { targetKm=0; targetAsc=0; } // Giorno gara

Â  Â  Â  Â  // Giorni liberi dalla palestra
Â  Â  Â  Â  const freeDays=GIORNI.filter(d=>!settings.giorniPalestra.includes(d));
Â  Â  Â  Â  
Â  Â  Â  Â  // Determina i giorni di corsa effettivi per la settimana
Â  Â  Â  Â  const totalRuns=Math.min(settings.allenTot-settings.giorniPalestra.length, freeDays.length);
Â  Â  Â  Â  const runDays=[];
        // Semplificazione: assegna i giorni di corsa ai primi giorni liberi
Â  Â  Â  Â  for(let i=0;i<totalRuns;i++){
Â  Â  Â  Â  Â  Â  runDays.push(freeDays[i]);
Â  Â  Â  Â  }

Â  Â  Â  Â  const settimana=[];
Â  Â  Â  Â  let runIndex=0;
Â  Â  Â  Â  for(const day of GIORNI){
Â  Â  Â  Â  Â  Â  if(settings.giorniPalestra.includes(day)){
Â  Â  Â  Â  Â  Â  Â  Â  settimana.push({ day,type:"Palestra",summary:"ğŸ‹ï¸ Palestra",details:{ note:"Forza & Core" },uploaded:null,completed:false });
Â  Â  Â  Â  Â  Â  } else if(runDays.includes(day)){
                // Assegna il tipo di allenamento
Â  Â  Â  Â  Â  Â  Â  Â  const type=tipoAllenamentoForDay(day,runIndex,totalRuns);
Â  Â  Â  Â  Â  Â  Â  Â  const det=creaDettagliAllenamento(type,targetKm,targetAsc,settings.livello,isScarico);
Â  Â  Â  Â  Â  Â  Â  Â  
                let summaryText = `ğŸƒ ${type} â€” ${det.distance} km`;
                if(w === totaleSettimane && day === "Domenica") summaryText = "ğŸ† GARA - Ritiro pettorale";
                if(w === totaleSettimane-1 && day === "Domenica") summaryText = "Lunghezza ridotta"; // Scarico

Â  Â  Â  Â  Â  Â  Â  Â  settimana.push({ day,type:"Corsa",summary:summaryText,details:det,uploaded:null,completed:false });
Â  Â  Â  Â  Â  Â  Â  Â  runIndex++;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  settimana.push({ day,type:"Riposo",summary:"Riposo",details:{ note:"Recupero" },uploaded:null,completed:false });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  plan.push({ settimana:w,targetKm:+targetKm.toFixed(1),targetAsc:Math.round(targetAsc),isScarico,allenamenti:settimana,completato:false });
Â  Â  }

Â  Â  STATE.settings=settings;
Â  Â  STATE.planData=plan;
Â  Â  saveState();
Â  Â  renderAll();
}

// ---------------------- Rendering ----------------------
function renderAll(){
Â  Â  const planView=document.getElementById("planView");
Â  Â  if(!STATE.planData.length){ planView.innerHTML="Nessun piano ancora generato."; return; }
Â  Â  planView.innerHTML="";
Â  Â  STATE.planData.forEach(s=>{
Â  Â  Â  Â  const wDiv=document.createElement("div"); wDiv.className="week";
Â  Â  Â  Â  const h=document.createElement("h3");
        // Aggiungi un flag visivo per lo scarico o la settimana di gara
        let title = `Settimana ${s.settimana}`;
        if(s.settimana === STATE.settings.settimane) title += " (GARA)";
        else if(s.settimana === STATE.settings.settimane-1) title += " (SCARICO)";
        title += ` â€” ${s.targetKm} km`;

Â  Â  Â  Â  h.innerHTML=title;
Â  Â  Â  Â  h.addEventListener("click",()=>{ d.style.display=d.style.display==="none"?"block":"none"; });
Â  Â  Â  Â  wDiv.appendChild(h);
Â  Â  Â  Â  const d=document.createElement("div"); d.className="days"; d.style.display="block"; // Mostra di default
Â  Â  Â  Â  s.allenamenti.forEach(a=>{
Â  Â  Â  Â  Â  Â  const dayDiv=document.createElement("div"); dayDiv.className="day";
Â  Â  Â  Â  Â  Â  dayDiv.innerHTML=`${a.day}: <strong>${a.summary}</strong>`;
Â  Â  Â  Â  Â  Â  
            // Aggiunge i dettagli specifici (km, asc, tempo)
            if(a.type==="Corsa"){
                dayDiv.innerHTML+=`<br><span class="muted">${a.details.distance} km | ${a.details.ascent} m D+ | ${formatTime(a.details.durationMin)}</span>`;
            }

            // Aggiunge i dettagli aggiuntivi
Â  Â  Â  Â  Â  Â  if(a.details.detailText) dayDiv.innerHTML+=`<div class="detail">${a.details.detailText}</div>`;
Â  Â  Â  Â  Â  Â  
            // Pulsante per caricare GPX
Â  Â  Â  Â  Â  Â  if(a.type==="Corsa" || a.type==="Palestra"){
Â  Â  Â  Â  Â  Â  Â  Â  const upBtn=document.createElement("button"); 
                upBtn.textContent=a.uploaded ? `âœ… Caricato: ${a.uploaded.name}` : "ğŸ“ Carica GPX";
                upBtn.style.backgroundColor = a.uploaded ? '#4cd964' : '#007aff';
                upBtn.style.marginTop = '6px';
Â  Â  Â  Â  Â  Â  Â  Â  upBtn.addEventListener("click",()=>{ handleUpload(a); });
Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.appendChild(upBtn);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  d.appendChild(dayDiv);
Â  Â  Â  Â  });
Â  Â  Â  Â  wDiv.appendChild(d);
Â  Â  Â  Â  planView.appendChild(wDiv);
Â  Â  });
}

// ---------------------- Upload GPX ----------------------
function handleUpload(allenamento){
Â  Â  const input=document.getElementById("hiddenFileInput");
Â  Â  input.onchange=e=>{
Â  Â  Â  Â  const file=input.files[0];
Â  Â  Â  Â  if(file && file.name.toLowerCase().endsWith(".gpx")){
Â  Â  Â  Â  Â  Â  const reader=new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload=ev=>{
Â  Â  Â  Â  Â  Â  Â  Â  allenamento.uploaded={ name:file.name, content:ev.target.result };
Â  Â  Â  Â  Â  Â  Â  Â  allenamento.completed=true;
Â  Â  Â  Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  Â  Â  Â  Â  alert("GPX caricato correttamente! (Nota: l'analisi GPX non Ã¨ implementata in questa versione)");
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  } else alert("File non valido. Solo GPX.");
        input.value = ""; // Resetta l'input file per consentire caricamenti successivi
Â  Â  };
Â  Â  input.click();
}

// ---------------------- Init impostazioni ----------------------
function initSettings(){
    if(!STATE.settings) STATE.settings = DEFAULT_STATE.settings;
    document.getElementById("livello").value = STATE.settings.livello;
    document.getElementById("obbKm").value = STATE.settings.obbKm;
    document.getElementById("obbAsc").value = STATE.settings.obbAsc;
    document.getElementById("settimane").value = STATE.settings.settimane;
    document.getElementById("allenTot").value = STATE.settings.allenTot;

    document.querySelectorAll(".chk-btn").forEach(btn => {
        const day = btn.dataset.day;
        if (STATE.settings.giorniPalestra.includes(day)) {
            btn.classList.add("active");
        }
    });
}

// ---------------------- Eventi ----------------------
document.getElementById("genLocal").addEventListener("click",()=>{
Â  Â  const lvl=document.getElementById("livello").value;
Â  Â  const km=parseFloat(document.getElementById("obbKm").value);
Â  Â  const asc=parseFloat(document.getElementById("obbAsc").value);
Â  Â  const settimane=parseInt(document.getElementById("settimane").value);
Â  Â  const allenTot=parseInt(document.getElementById("allenTot").value);
Â  Â  const palestra=Array.from(document.querySelectorAll(".chk-btn.active")).map(b=>b.dataset.day);
Â  Â  if(!km||!asc){ alert("Inserisci km e dislivello"); return; }
Â  Â  generaPiano({ livello:lvl, obbKm:km, obbAsc:asc, settimane:settimane, allenTot, giorniPalestra:palestra });
});

document.getElementById("resetData").addEventListener("click",()=>{
Â  Â  if(confirm("Vuoi resettare tutti i dati (impostazioni, piano e storico)?")){ 
        STATE=JSON.parse(JSON.stringify(DEFAULT_STATE)); 
        localStorage.removeItem(STORAGE_KEY);
        initSettings(); // Ricarica le impostazioni di default nella UI
        renderAll(); 
    }
});

document.querySelectorAll(".chk-btn").forEach(btn=>{
Â  Â  btn.addEventListener("click",()=>{ 
        btn.classList.toggle("active"); 
        // Salva lo stato della palestra immediatamente
        const palestra=Array.from(document.querySelectorAll(".chk-btn.active")).map(b=>b.dataset.day);
        STATE.settings.giorniPalestra = palestra;
        saveState();
    });
});

document.getElementById("toggleSettings").addEventListener("click",()=>{
Â  Â  const c=document.getElementById("settingsContent");
    const isHidden = c.style.display === "none";
Â  Â  c.style.display=isHidden?"block":"none";
    document.getElementById("toggleSettings").textContent = isHidden ? "Nascondi" : "Mostra";
});

// ---------------------- Init ----------------------
loadState();
initSettings();
renderAll();
</script>
</body>
</html>
