<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v9.4.2.2</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="data:application/json,{\"name\":\"TrailCoach AI\",\"display\":\"standalone\"}">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;overflow-x:hidden;}
h1{text-align:center;font-size:22px;margin:8px 0;}
.card{background:#fff;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,.08);}
label{display:block;margin:6px 0 4px;font-weight:600;}
input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;}
button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:6px;}
button.save{background:#34c759;}button.orange{background:#ff9500;}button.red{background:#ff3b30;}
.week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
.week h3{margin:0;cursor:pointer;font-size:17px;}
.days{margin-top:6px;padding-left:10px;display:none;}
.days div{padding:4px 0;border-bottom:1px solid #eee;}
.small{font-size:13px;color:#666;}
canvas{width:100%;max-width:400px;margin:10px auto;display:block;}
.hidden{display:none;}
.history-item{border-bottom:1px solid #eee;padding:4px 0;font-size:14px;}
.toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:2px 8px;font-size:13px;margin-top:-4px;}
.day-buttons{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;}
.day-buttons button{flex:1 0 30px;padding:4px;font-size:12px;}
.active{background:#34c759;color:#fff;}
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v9.4.2.2</h1>

<div class="card" id="settingsCard">
  <div>
    <span style="font-weight:600;">‚öôÔ∏è Impostazioni</span>
    <button id="toggleSettings" class="toggle-btn">Nascondi</button>
  </div>
  <div id="settingsContent">
    <label>Livello atleta</label>
    <select id="livello">
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzato">Avanzato</option>
    </select>

    <label>Obiettivo distanza gara (km)</label>
    <input id="obbKm" type="number" placeholder="es. 20" />

    <label>Obiettivo dislivello gara (m)</label>
    <input id="obbD+" type="number" placeholder="es. 1000" />

    <label>Durata piano (settimane)</label>
    <input id="settimane" type="number" value="8" min="1" max="52" />

    <label>Numero allenamenti a settimana</label>
    <input id="numAllenamenti" type="number" value="3" min="2" max="7" />

    <div>
      <label>Giorni palestra</label>
      <div class="day-buttons" id="palestraDays">
        <button data-day="Lun">Lun</button>
        <button data-day="Mar">Mar</button>
        <button data-day="Mer">Mer</button>
        <button data-day="Gio">Gio</button>
        <button data-day="Ven">Ven</button>
        <button data-day="Sab">Sab</button>
        <button data-day="Dom">Dom</button>
      </div>
    </div>

    <button id="genLocal" class="save">‚öôÔ∏è Genera piano</button>
    <button id="resetPlan" class="red">üóëÔ∏è Reset piano</button>
  </div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView">Nessun piano ancora generato.</div>
</div>

<div class="card">
  <label>Avanzamento</label>
  <canvas id="progressChart" width="360" height="180"></canvas>
  <div id="chartText" class="small"></div>
</div>

<div class="card">
  <label>Storico allenamenti</label>
  <div id="historyList" class="small">Nessun allenamento caricato.</div>
</div>

<script>
// --- Dati globali ---
let planData=[], progress={km:0,ascent:0,duration:0};
let palestraSelected = [];
const STORAGE_KEY="trailcoach_plan_v9_4_2_2";

// --- Selezione giorni palestra ---
document.querySelectorAll("#palestraDays button").forEach(btn=>{
  btn.onclick=()=>{
    btn.classList.toggle("active");
    palestraSelected = Array.from(document.querySelectorAll("#palestraDays button.active")).map(b=>b.dataset.day);
  };
});

// --- Progressione ---
function progressione(lvl){
  switch(lvl){
    case "principiante": return [0.5,0.6,0.7,0.8,0.9,1.0];
    case "intermedio": return [0.6,0.7,0.8,0.9,1.0];
    case "avanzato": return [0.7,0.8,0.9,1.0];
    default: return [0.6,0.8,1.0];
  }
}

// --- Genera piano ---
function generaPiano(lvl, km, asc, weeks, numAllenamenti){
  const prog = progressione(lvl);
  planData=[];
  const giorniSettimana=["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
  for(let w=0; w<weeks; w++){
    const p = prog[Math.min(w,prog.length-1)];
    let days=[];
    let giorniCorsa=[];
    for(let i=0;i<7;i++){
      if(!palestraSelected.includes(giorniSettimana[i])) giorniCorsa.push(i);
    }
    giorniCorsa = giorniCorsa.slice(0,numAllenamenti);
    for(let d=0; d<7; d++){
      let allenamento = giorniCorsa.includes(d)?"Corsa":"Riposo";
      if(palestraSelected.includes(giorniSettimana[d])) allenamento="Palestra";
      days.push({dayIdx:d,allenamento,done:null});
    }
    planData.push({settimana:w+1,targetKm:(km*p).toFixed(1),targetAsc:Math.round(asc*p),days});
  }
  salvaLocale(); renderPiano(); drawChart(); toggleSettings(false);
}

// --- Render piano ---
function renderPiano(){
  const div=document.getElementById("planView"); div.innerHTML="";
  planData.forEach((w,wi)=>{
    const week=document.createElement("div"); week.className="week";
    week.innerHTML=`<h3>üìÖ Settimana ${w.settimana} ‚Äì Target: ${w.targetKm} km / +${w.targetAsc} m</h3>`;
    const days=document.createElement("div"); days.className="days";
    w.days.forEach((d,di)=>{
      const dayDiv=document.createElement("div");
      dayDiv.innerHTML=`<strong>${["Lun","Mar","Mer","Gio","Ven","Sab","Dom"][di]}:</strong> ${d.allenamento} 
        <input type="file" accept=".fit" id="fitInput-${wi}-${di}" />
        <span id="fitInfo-${wi}-${di}" class="small"></span>`;
      days.appendChild(dayDiv);
      document.getElementById(`fitInput-${wi}-${di}`).addEventListener("change",(ev)=>handleFitFileUpload(ev,wi,di));
    });
    week.appendChild(days);
    week.querySelector("h3").onclick=()=>days.style.display=days.style.display==="none"?"block":"none";
    div.appendChild(week);
  });
}

// --- Caricamento file ---
async function handleFitFileUpload(ev, weekIdx, dayIdx){
  const file=ev.target.files[0]; if(!file) return;
  const infoEl=document.getElementById(`fitInfo-${weekIdx}-${dayIdx}`);
  infoEl.textContent="‚è≥ Lettura file...";
  try{
    const ab=await file.arrayBuffer();
    const parsed=parseFitMock(ab); 
    progress.km+=parsed.distance;
    progress.ascent+=parsed.ascent;
    progress.duration+=parsed.duration;
    planData[weekIdx].days[dayIdx].done=parsed;
    infoEl.textContent=`üèÅ ${parsed.distance.toFixed(1)} km / +${parsed.ascent.toFixed(0)} m / ${parsed.duration} min`;
    salvaLocale(); drawChart(); renderHistory();
  }catch(e){infoEl.textContent="‚ö†Ô∏è Errore: "+e;}
  ev.target.value="";
}

// --- Parser mock ---
function parseFitMock(ab){ return {distance:Math.random()*10+5, ascent:100+Math.random()*500, duration:Math.floor(Math.random()*60+20)}; }

// --- Grafico ---
function drawChart(){
  const c=document.getElementById("progressChart"), ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const percKm=Math.min(progress.km/targetKm,1);
  const percAsc=Math.min(progress.ascent/targetAsc,1);
  ctx.fillStyle="#007aff"; ctx.fillRect(40,80,280*percKm,25);
  ctx.fillStyle="#ccc"; ctx.fillRect(40+280*percKm,80,280*(1-percKm),25);
  ctx.fillStyle="#ff9500"; ctx.fillRect(40,120,280*percAsc,25);
  ctx.fillStyle="#ccc"; ctx.fillRect(40+280*percAsc,120,280*(1-percAsc),25);
  ctx.fillStyle="#000"; ctx.fillText("Km",10,98); ctx.fillText("D+",10,138);
  document.getElementById("chartText").textContent=`${progress.km.toFixed(1)} km / ${targetKm} km ‚Äî +${progress.ascent.toFixed(0)} m / +${targetAsc} m ‚Äî ${progress.duration} min`;
}

// --- Storico ---
function renderHistory(){
  const div=document.getElementById("historyList"); let items=[];
  planData.forEach(w=>{
    w.days.forEach(d=>{
      if(d.done) items.push({date:`Set ${w.settimana} - Giorno ${d.dayIdx+1}`,...d.done});
    });
  });
  div.innerHTML = items.length ? items.map(h=>`<div class="history-item">${h.date} ‚Üí ${h.distance.toFixed(1)} km, +${h.ascent.toFixed(0)} m, ${h.duration} min</div>`).join("") : "Nessun allenamento caricato.";
}

// --- Salvataggio locale ---
function salvaLocale(){ localStorage.setItem(STORAGE_KEY,JSON.stringify({planData,progress})); }
function caricaLocale(){
  const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
  try{
    const data=JSON.parse(raw);
    planData=data.planData||[]; progress=data.progress||{km:0,ascent:0,duration:0};
    renderPiano(); drawChart(); renderHistory();
  }catch(e){console.log("Errore load",e);}
}

// --- Toggle impostazioni ---
function toggleSettings(){
  const content=document.getElementById("settingsContent");
  const btn=document.getElementById("toggleSettings");
  if(content.classList.contains("hidden")){content.classList.remove("hidden");btn.textContent="Nascondi";}
  else{content.classList.add("hidden");btn.textContent="Mostra";}
}

// --- Eventi ---
document.getElementById("genLocal").onclick=()=>{
  const lvl=document.getElementById("livello").value;
  const km=+document.getElementById("obbKm").value;
  const asc=+document.getElementById("obbD+").value;
  const weeks=+document.getElementById("settimane").value;
  const numA=+document.getElementById("numAllenamenti").value;
  if(!km||!asc){ alert("Inserisci obiettivi gara."); return; }
  progress={km:0,ascent:0,duration:0}; planData=[];
  generaPiano(lvl, km, asc, weeks, numA);
};

document.getElementById("resetPlan").onclick=()=>{
  if(confirm("Vuoi cancellare il piano e tutti i dati salvati?")){
    planData=[]; progress={km:0,ascent:0,duration:0};
    localStorage.removeItem(STORAGE_KEY);
    renderPiano(); drawChart(); renderHistory();
    
    toggleSettings(false);
  }
};

document.getElementById("toggleSettings").onclick=toggleSettings;

// --- Avvio ---
caricaLocale();
window.addEventListener("load",()=>{setTimeout(()=>window.scrollTo(0,1),500);});
</script>
</body>
</html>