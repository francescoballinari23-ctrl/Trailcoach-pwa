<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>üèîÔ∏è TrailCoach AI v14.1</title>
<meta name="theme-color" content="#000000">
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;}
  h1{text-align:center;font-size:22px;margin:6px 0;}
  .card{background:#fff;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.06);}
  label{display:block;margin:8px 0 6px;font-weight:600;}
  input[type="number"], select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box;}
  button{background:#007aff;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;}
  button:hover{opacity:0.9;}
  button.reset{background:#ff3b30;margin-left:8px;}
  .week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
  .week h3{margin:0;cursor:pointer;font-size:17px;display:flex;justify-content:space-between;align-items:center;}
  .days{margin-top:6px;padding-left:10px;display:none;}
  .days .day{padding:6px 0;border-bottom:1px solid #eee;}
  .detail{background:#fff;border-radius:8px;padding:10px;margin:6px 0 10px;border:1px solid #eee;font-size:14px;}
  .muted{color:#666;font-size:13px;}
  .fileline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
  .meta{font-size:13px;color:#333;margin-top:6px;}
  .chk-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;background:#f2f2f2;cursor:pointer;border:1px solid transparent;font-weight:700;}
  .chk-btn.active{background:#007aff;color:#fff;border-color:#0060d6;}
  .checkbox-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;}
  .checkbox-grid-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;}
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v14.1</h1>

<div class="card" id="settingsCard">
  <label>Livello atleta</label>
  <select id="livello">
    <option value="principiante">Principiante</option>
    <option value="intermedio">Intermedio</option>
    <option value="avanzato">Avanzato</option>
  </select>

  <label>Obiettivo distanza gara (km)</label>
  <input id="obbKm" type="number" placeholder="es. 30" />

  <label>Obiettivo dislivello gara (m)</label>
  <input id="obbAsc" type="number" placeholder="es. 1500" />

  <label>Durata piano (settimane)</label>
  <input id="settimane" type="number" value="8" min="1" max="52" />

  <label>Allenamenti totali a settimana</label>
  <input id="allenTot" type="number" value="4" min="2" max="7" step="0.5" />

  <label>Giorni palestra</label>
  <div class="checkbox-grid" id="palestraTop">
    <div class="chk-btn" data-day="Luned√¨">Lun</div>
    <div class="chk-btn" data-day="Marted√¨">Mar</div>
    <div class="chk-btn" data-day="Mercoled√¨">Mer</div>
  </div>
  <div class="checkbox-grid-bottom" id="palestraBottom">
    <div class="chk-btn" data-day="Gioved√¨">Gio</div>
    <div class="chk-btn" data-day="Venerd√¨">Ven</div>
    <div class="chk-btn" data-day="Sabato">Sab</div>
    <div class="chk-btn" data-day="Domenica">Dom</div>
  </div>

  <button id="genPlan">‚öôÔ∏è Genera piano</button>
  <button id="resetData" class="reset">üóëÔ∏è Reset</button>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView" class="muted">Nessun piano ancora generato.</div>
</div>

<div class="card">
  <label>Storico allenamenti</label>
  <div id="historyList" class="muted">Nessun allenamento registrato.</div>
</div>

<input id="hiddenFileInput" type="file" accept=".gpx" style="display:none" />

<script>
// ---------------------- Stato base ----------------------
const STORAGE_KEY = "trailcoach_v14_1_state";
const GIORNI = ["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
let STATE = JSON.parse(localStorage.getItem(STORAGE_KEY) || `{
  "settings": {"livello":"principiante","obbKm":20,"obbAsc":800,"settimane":8,"allenTot":4,"giorniPalestra":[]},
  "planData": [],
  "history": []
}`);

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }

// ---------------------- Utility ----------------------
function paceByLevel(lvl){ return lvl==="principiante"?6 : lvl==="intermedio"?5.5 : 5; }
function formatTime(mins){ const h=Math.floor(mins/60); const m=Math.round(mins%60); return h>0?`${h}h ${m}m`:`${m}m`; }

// ---------------------- Selezione giorni corsa ----------------------
function selectRunDays(allenTot, giorniPalestra){
  const totalRuns = Math.max(0, allenTot - giorniPalestra.length);
  const freeDays = GIORNI.filter(d => !giorniPalestra.includes(d));
  const selected = [];
  if(totalRuns >= freeDays.length) return freeDays;
  const step = freeDays.length / totalRuns;
  for(let i=0;i<totalRuns;i++){
    const idx = Math.floor(i*step + step/2);
    selected.push(freeDays[idx]);
  }
  return selected;
}

// ---------------------- Dettagli allenamento ----------------------
function creaDettagliAllenamento(type, weeklyKm, weeklyAsc, runsCount, indexRun, livello, isScarico){
  let dist, asc;
  const basePace = paceByLevel(livello);

  if(type === "Lungo trail"){
    dist = weeklyKm * 0.45;
    asc  = weeklyAsc * 0.5;
  } else if(["Ripetute","Fartlek","Progressivo"].includes(type)){
    dist = weeklyKm * 0.25 / (runsCount-1);
    asc  = weeklyAsc * 0.25 / (runsCount-1);
  } else {
    dist = weeklyKm * 0.30 / (runsCount-2);
    asc  = weeklyAsc * 0.25 / (runsCount-2);
  }
  if(isScarico){ dist *= 0.7; asc *= 0.7; }

  const durationMin = dist * basePace;
  let details = "";
  if(type==="Ripetute") details = "6‚Äì10√ó400m in salita, recupero 90s";
  else if(type==="Fartlek") details = "Alterna 2‚Äô veloci / 2‚Äô lenti";
  else if(type==="Progressivo") details = "Aumenta ritmo negli ultimi km";
  else if(type==="Lungo trail") details = "Endurance, ritmo lento e costante";
  else details = "Ritmo facile, tecnica e recupero";

  return { distance:+dist.toFixed(1), ascent:Math.round(asc), durationMin:Math.round(durationMin), detailText:details };
}

// ---------------------- Generazione piano (v14.1) ----------------------
function generaPiano(settings){
  const plan=[];
  const totalWeeks=settings.settimane;
  const giorniPalestra=settings.giorniPalestra;
  const allenTot=settings.allenTot;
  const runBase=Math.floor(allenTot - giorniPalestra.length);
  const mezzoAllenamento=(allenTot - giorniPalestra.length)%1>=0.5;

  // progressione carico
  const progression=[];
  for(let w=1;w<=totalWeeks;w++){
    const phase=w/totalWeeks;
    const grow=phase<0.8?0.5+0.5*phase:1.0;
    const scarico=(w===totalWeeks-1)?0.7:(w===totalWeeks?0.5:1);
    progression.push(grow*scarico);
  }

  for(let w=1;w<=totalWeeks;w++){
    const coeff=progression[w-1];
    const weekKm=+(settings.obbKm*coeff).toFixed(1);
    const weekAsc=Math.round(settings.obbAsc*coeff);
    const isScarico=(w===totalWeeks-1)||(w===totalWeeks);

    let runCount=runBase;
    if(mezzoAllenamento && w%2===0) runCount+=1;

    const runDays=selectRunDays(runCount+giorniPalestra.length,giorniPalestra);
    const settimana=[];
    let runIndex=0;

    for(const day of GIORNI){
      if(giorniPalestra.includes(day)){
        settimana.push({day,type:"Palestra",summary:"üèãÔ∏è Palestra",details:{note:"Forza & Core"},uploaded:null,completed:false});
      } else if(runDays.includes(day)){
        let type="Fondo lento";
        if(day==="Sabato"||day==="Domenica") type="Lungo trail";
        else if(runIndex===0) type=["Ripetute","Progressivo","Fartlek"][w%3];

        const det=creaDettagliAllenamento(type,weekKm,weekAsc,runCount,runIndex,settings.livello,isScarico);
        settimana.push({day,type:"Corsa",summary:`üèÉ ${type} ‚Äî ${det.distance} km`,details:det,uploaded:null,completed:false});
        runIndex++;
      } else {
        settimana.push({day,type:"Riposo",summary:"Riposo",details:{note:"Recupero"},uploaded:null,completed:false});
      }
    }
    plan.push({settimana:w,targetKm:weekKm,targetAsc:weekAsc,isScarico,allenamenti:settimana,completato:false});
  }

  STATE.settings=settings;
  STATE.planData=plan;
  saveState();
  renderPiano();
  renderHistory();
}

// ---------------------- Render piano ----------------------
function renderPiano(){
  const container=document.getElementById("planView");
  container.innerHTML="";
  if(!STATE.planData||STATE.planData.length===0){container.textContent="Nessun piano generato.";return;}
  STATE.planData.forEach((w,weekIndex)=>{
    const weekDiv=document.createElement("div");
    weekDiv.className="week";
    const header=document.createElement("h3");
    header.innerHTML=`Settimana ${w.settimana} ‚Äî Target: ${w.targetKm} km / +${w.targetAsc} m ${w.isScarico?"(Scarico)":""}`;
    weekDiv.appendChild(header);
    const btnToggle=document.createElement("button");
    btnToggle.textContent="Apri";
    header.appendChild(btnToggle);
    const daysDiv=document.createElement("div");
    daysDiv.className="days";

    w.allenamenti.forEach((a,dayIndex)=>{
      const d=document.createElement("div");d.className="day";
      const s=document.createElement("div");s.innerHTML=`<strong>${a.day}</strong> ‚Äî ${a.summary}`;
      const btn=document.createElement("button");btn.textContent="Dettagli";btn.style.background="#444";btn.style.marginLeft="8px";
      s.appendChild(btn);
      d.appendChild(s);

      const detail=document.createElement("div");detail.className="detail";detail.style.display="none";
      if(a.type==="Corsa"){
        detail.innerHTML=`<strong>${a.summary}</strong><br><span class="muted">${a.details.distance} km, +${a.details.ascent} m ‚Äî ${formatTime(a.details.durationMin)}</span><br><em>${a.details.detailText}</em>`;
        const file=document.createElement("div");file.className="fileline";
        const upl=document.createElement("button");upl.textContent="üìé Carica GPX";upl.style.background="#222";
        upl.onclick=()=>triggerUploadFor(weekIndex,dayIndex);
        file.appendChild(upl);
        detail.appendChild(file);
      } else if(a.type==="Palestra"){
        detail.textContent="Forza e Core ‚Äî esercizi funzionali";
      } else detail.textContent="Riposo o recupero attivo";
      d.appendChild(detail);
      btn.onclick=()=>detail.style.display=detail.style.display==="none"?"block":"none";
      daysDiv.appendChild(d);
    });
    btnToggle.onclick=()=>{daysDiv.style.display=daysDiv.style.display==="block"?"none":"block";};
    weekDiv.appendChild(daysDiv);
    container.appendChild(weekDiv);
  });
}

// ---------------------- Upload GPX ----------------------
let uploadContext=null;
const hiddenInput=document.getElementById("hiddenFileInput");
function triggerUploadFor(weekIndex,dayIndex){uploadContext={weekIndex,dayIndex};hiddenInput.click();}
hiddenInput.addEventListener("change",async(e)=>{
  const f=e.target.files[0];if(!f)return;
  const txt=await f.text();
  const {km,asc}=parseGpxText(txt);
  const week=STATE.planData[uploadContext.weekIndex];
  const dayObj=week.allenamenti[uploadContext.dayIndex];
  dayObj.uploaded={filename:f.name,km,asc,date:new Date().toLocaleDateString()};
  dayObj.completed=true;
  STATE.history.unshift({date:new Date().toLocaleDateString(),km,asc,filename:f.name,week:week.settimana,day:dayObj.day});
  saveState();
  renderHistory();
});

function parseGpxText(txt){
  const ele=[...txt.matchAll(/<ele>([\d\.\-]+)<\/ele>/g)].map(m=>parseFloat(m[1]));
  const coords=[...txt.matchAll(/<trkpt[^>]*lat="([^"]+)" lon="([^"]+)"/g)].map(m=>({lat:+m[1],lon:+m[2]}));
  let asc=0;for(let i=1;i<ele.length;i++){const diff=ele[i]-ele[i-1];if(diff>0)asc+=diff;}
  let km=0;for(let i=1;i<coords.length;i++)km+=haversine(coords[i-1],coords[i]);
  return{km:+km.toFixed(2),asc:Math.round(asc)};
}
function haversine(p1,p2){const R=6371,toRad=x=>x*Math.PI/180,dLat=toRad(p2.lat-p1.lat),dLon=toRad(p2.lon-p1.lon);const a=Math.sin(dLat/2)**2+Math.cos(toRad(p1.lat))*Math.cos(toRad(p2.lat))*Math.sin(dLon/2)**2;return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));}

// ---------------------- Storico ----------------------
function renderHistory(){
  const h=document.getElementById("historyList");
  if(!STATE.history.length){h.textContent="Nessun allenamento registrato.";return;}
  h.innerHTML=STATE.history.map(x=>`${x.date} ‚Äî ${x.day} (${x.week}) ‚Üí ${x.km} km +${x.asc} m`).join("<br>");
}

// ---------------------- Eventi ----------------------
document.getElementById("genPlan").onclick=()=>{
  const s={
    livello:document.getElementById("livello").value,
    obbKm:+document.getElementById("obbKm").value||20,
    obbAsc:+document.getElementById("obbAsc").value||800,
    settimane:+document.getElementById("settimane").value||8,
    allenTot:+document.getElementById("allenTot").value||4,
    giorniPalestra:[...document.querySelectorAll(".chk-btn.active")].map(b=>b.dataset.day)
  };
  generaPiano(s);
};
document.getElementById("resetData").onclick=()=>{if(confirm("Cancellare tutto?")){localStorage.removeItem(STORAGE_KEY);location.reload();}};
document.querySelectorAll(".chk-btn").forEach(b=>b.onclick=()=>b.classList.toggle("active"));
renderPiano();renderHistory();
</script>
</body>
</html>