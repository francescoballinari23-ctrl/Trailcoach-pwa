<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v8</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;overflow-x:hidden;}
h1{text-align:center;font-size:22px;margin:8px 0;}
.card{background:#fff;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,.08);}
label{display:block;margin:6px 0 4px;font-weight:600;}
input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;}
button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:6px;}
button.save{background:#34c759;}button.orange{background:#ff9500;}button.red{background:#ff3b30;}
.week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
.week h3{margin:0;cursor:pointer;font-size:17px;}
.days{margin-top:6px;padding-left:10px;display:none;}
.days div{padding:4px 0;border-bottom:1px solid #eee;}
.small{font-size:13px;color:#666;}
.toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:2px 8px;font-size:13px;margin-top:-4px;}
.checkbox-group{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
.checkbox-group label{font-weight:500;display:flex;align-items:center;gap:4px;background:#f2f2f2;padding:4px 8px;border-radius:8px;}
</style>
</head>
<body>
<h1>🏔️ TrailCoach AI v8</h1>

<div class="card" id="settingsCard">
  <div>
    <span style="font-weight:600;">⚙️ Impostazioni</span>
    <button id="toggleSettings" class="toggle-btn">Nascondi</button>
  </div>
  <div id="settingsContent">
    <label>Livello atleta</label>
    <select id="livello">
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzato">Avanzato</option>
    </select>

    <label>Obiettivo distanza gara (km)</label>
    <input id="obbKm" type="number" placeholder="es. 20" />

    <label>Obiettivo dislivello gara (m)</label>
    <input id="obbD+" type="number" placeholder="es. 1000" />

    <label>Durata piano (settimane)</label>
    <input id="settimane" type="number" value="8" min="1" max="52" />

    <label>Allenamenti totali a settimana</label>
    <input id="allenTot" type="number" value="4" min="2" max="7" />

    <label>Giorni palestra</label>
    <div class="checkbox-group" id="giorniPalestra">
      <label><input type="checkbox" value="Lunedì">Lun</label>
      <label><input type="checkbox" value="Martedì">Mar</label>
      <label><input type="checkbox" value="Mercoledì">Mer</label>
      <label><input type="checkbox" value="Giovedì">Gio</label>
      <label><input type="checkbox" value="Venerdì">Ven</label>
      <label><input type="checkbox" value="Sabato">Sab</label>
      <label><input type="checkbox" value="Domenica">Dom</label>
    </div>

    <button id="genLocal" class="save">⚙️ Genera piano</button>
  </div>
</div>

<div class="card">
  <label>Avanzamento</label>
  <canvas id="progressChart" width="360" height="180"></canvas>
  <div id="chartText" class="small"></div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView">Nessun piano ancora generato.</div>
</div>

<script>
// === Funzioni base ===
let planData=[], progress={km:0,ascent:0}, targetKm=0, targetAsc=0;
const STORAGE_KEY="trailcoach_plan_v8";

function progressione(lvl){
  switch(lvl){
    case "principiante": return [0.5,0.6,0.7,0.8,0.9,1.0];
    case "intermedio":   return [0.6,0.7,0.8,0.9,1.0];
    case "avanzato":     return [0.7,0.8,0.9,1.0];
    default: return [0.6,0.8,1.0];
  }
}

function generaAllenamentiCorsa(num){
  const allenamentiBase=[
    "🏃 Corsa facile",
    "⛰️ Ripetute collinari",
    "🏃 Progressivo",
    "🏃 Medio costante",
    "⛰️ Lungo trail",
    "🏃 Fondo lento",
    "🏃 Fartlek naturale"
  ];
  return allenamentiBase.slice(0,num);
}

function generaPiano(lvl, km, asc, weeks, allenTot, giorniPalestra){
  const prog=progressione(lvl);
  planData=[];
  const giorniSettimana=["Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato","Domenica"];

  for(let w=1;w<=weeks;w++){
    const p=prog[Math.min(w-1,prog.length-1)];
    const giorniCorsa=allenTot - giorniPalestra.length;
    const allenCorsa=generaAllenamentiCorsa(giorniCorsa);
    const allenSettimana=[];

    giorniSettimana.forEach(g=>{
      if(giorniPalestra.includes(g)) allenSettimana.push(`🏋️ ${g} – Palestra / Forza e Core`);
      else if(allenCorsa.length>0) allenSettimana.push(`${g} – ${allenCorsa.shift()}`);
    });

    planData.push({
      settimana:w,
      targetKm:(km*p).toFixed(1),
      targetAsc:Math.round(asc*p),
      allenamenti:allenSettimana
    });
  }

  salvaLocale(); renderPiano(); drawChart(); toggleSettings(false);
}

// === Render Piano ===
function renderPiano(){
  const div=document.getElementById("planView");
  div.innerHTML="";
  planData.forEach(w=>{
    const week=document.createElement("div");
    week.className="week";
    week.innerHTML=`<h3>📅 Settimana ${w.settimana} – Target: ${w.targetKm} km / +${w.targetAsc}m</h3>`;
    const days=document.createElement("div");
    days.className="days";
    w.allenamenti.forEach(d=>{
      const dd=document.createElement("div");
      dd.textContent=d;
      days.appendChild(dd);
    });
    week.appendChild(days);
    week.querySelector("h3").onclick=()=>days.style.display=days.style.display==="none"?"block":"none";
    div.appendChild(week);
  });
}

// === Chart ===
function drawChart(){
  const c=document.getElementById("progressChart"),ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle="#007aff";ctx.fillRect(40,80,280,25);
  ctx.fillStyle="#ff9500";ctx.fillRect(40,120,280,25);
  ctx.fillStyle="#000";ctx.fillText("Km",10,98);ctx.fillText("D+",10,138);
  document.getElementById("chartText").textContent=`Piano generato con ${planData.length} settimane.`;
}

// === Salvataggio locale ===
function salvaLocale(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({planData}));
}
function caricaLocale(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw)return;
  try{const data=JSON.parse(raw);planData=data.planData||[];renderPiano();drawChart();}catch(e){}
}

// === Eventi ===
document.getElementById("genLocal").onclick=()=>{
  const lvl=livello.value;
  targetKm=+document.getElementById("obbKm").value;
  targetAsc=+document.getElementById("obbD+").value;
  const weeks=+document.getElementById("settimane").value;
  const allenTot=+document.getElementById("allenTot").value;
  const giorniSel=[...document.querySelectorAll("#giorniPalestra input:checked")].map(c=>c.value);
  if(!targetKm||!targetAsc){alert("Inserisci obiettivi gara.");return;}
  generaPiano(lvl,targetKm,targetAsc,weeks,allenTot,giorniSel);
};

function toggleSettings(show){
  const content=document.getElementById("settingsContent");
  const btn=document.getElementById("toggleSettings");
  if(show===undefined) show = content.classList.contains("hidden");
  if(show){content.classList.remove("hidden");btn.textContent="Nascondi";}
  else{content.classList.add("hidden");btn.textContent="Mostra";}
}
document.getElementById("toggleSettings").onclick=()=>toggleSettings();
caricaLocale();
</script>
</body>
</html>