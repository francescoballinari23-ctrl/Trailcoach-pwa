<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v10 (Fit Fix)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">
<style>
  :root{--card-radius:12px;}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;}
  h1{text-align:center;font-size:22px;margin:6px 0;}
  .card{background:#fff;border-radius:var(--card-radius);padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.06);}
  label{display:block;margin:8px 0 6px;font-weight:600;}
  input[type="number"], select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box;}
  button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:8px;cursor:pointer;}
  button.reset{background:#ff3b30;margin-left:8px;}
  .week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
  .week h3{margin:0;cursor:pointer;font-size:17px;display:flex;justify-content:space-between;align-items:center;}
  .days{margin-top:6px;padding-left:10px;display:none;}
  .days .day{padding:6px 0;border-bottom:1px solid #eee;}
  .small{font-size:13px;color:#666;margin-top:6px;}
  .toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:6px 10px;font-size:13px;margin-top:-4px;}
  .checkbox-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;}
  .checkbox-grid-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;}
  .chk-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;background:#f2f2f2;cursor:pointer;border:1px solid transparent;font-weight:700;}
  .chk-btn.active{background:#007aff;color:#fff;border-color:#0060d6;}
  .detail{background:#fff;border-radius:8px;padding:10px;margin:6px 0 10px;border:1px solid #eee;font-size:14px;}
  .muted{color:#666;font-size:13px;}
  .fileline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
  .meta{font-size:13px;color:#333;margin-top:6px;}
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v10</h1>

<div class="card" id="topSummaryCard" style="display:none;">
  <div id="summaryText" class="muted"></div>
</div>

<div class="card" id="settingsCard">
  <div>
    <span style="font-weight:600;">‚öôÔ∏è Impostazioni</span>
    <button id="toggleSettings" class="toggle-btn" aria-expanded="true">Nascondi</button>
  </div>
  <div id="settingsContent">
    <label>Livello atleta</label>
    <select id="livello">
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzato">Avanzato</option>
    </select>

    <label>Obiettivo distanza gara (km)</label>
    <input id="obbKm" type="number" placeholder="es. 20" />

    <label>Obiettivo dislivello gara (m)</label>
    <input id="obbD+" type="number" placeholder="es. 1000" />

    <label>Durata piano (settimane)</label>
    <input id="settimane" type="number" value="8" min="1" max="52" />

    <label>Allenamenti totali a settimana</label>
    <input id="allenTot" type="number" value="4" min="2" max="7" />

    <label>Giorni palestra</label>
    <div>
      <div class="checkbox-grid" id="palestraTop">
        <div class="chk-btn" data-day="Luned√¨">Lun</div>
        <div class="chk-btn" data-day="Marted√¨">Mar</div>
        <div class="chk-btn" data-day="Mercoled√¨">Mer</div>
      </div>
      <div class="checkbox-grid-bottom" id="palestraBottom">
        <div class="chk-btn" data-day="Gioved√¨">Gio</div>
        <div class="chk-btn" data-day="Venerd√¨">Ven</div>
        <div class="chk-btn" data-day="Sabato">Sab</div>
        <div class="chk-btn" data-day="Domenica">Dom</div>
      </div>
    </div>

    <div style="margin-top:8px;">
      <button id="genLocal" class="save">‚öôÔ∏è Genera piano</button>
      <button id="resetData" class="reset">üóëÔ∏è Reset dati</button>
    </div>
  </div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView" class="small">Nessun piano ancora generato.</div>
</div>

<div class="card">
  <label>Storico allenamenti</label>
  <div id="historyList" class="small">Nessun allenamento registrato.</div>
</div>

<input id="hiddenFileInput" type="file" accept=".fit" style="display:none" />

<!-- ‚úÖ libreria corretta e funzionante -->
<script src="https://unpkg.com/fit-file-parser@1.1.4/dist/fit-file-parser.min.js"></script>

<script>
// ---------------------- Stato e storage ----------------------
const STORAGE_KEY="trailcoach_v10_state";
const DEFAULT_STATE={settings:{livello:"principiante",obbKm:20,obbAsc:1000,settimane:8,allenTot:4,giorniPalestra:[]},planData:[],history:[]};
let STATE=JSON.parse(JSON.stringify(DEFAULT_STATE));
function saveState(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(STATE)); }
function loadState(){ const raw=localStorage.getItem(STORAGE_KEY); if(raw) STATE=JSON.parse(raw); }

// ---------------------- Utility ----------------------
function paceByLevel(lvl){ return lvl==="principiante"?6:lvl==="intermedio"?5.5:5; }
function formatTime(mins){ const h=Math.floor(mins/60); const m=Math.round(mins%60); return h>0?`${h}h ${m}m`:`${m}m`; }
function tipoAllenamentoForIndex(i){ const types=["Fondo facile","Ripetute collinari","Progressivo","Medio costante","Lungo trail","Fartlek","Fondo lento"]; return types[i%types.length]; }
function creaDettagliAllenamento(type,weeklyKm,weeklyAsc,runsCount,indexRun,livello,isScarico){
  const baseDistFractions=new Array(runsCount).fill(1); if(runsCount>0) baseDistFractions[runsCount-1]=1.4;
  const sum=baseDistFractions.reduce((a,b)=>a+b,0);
  const fraction=runsCount>0?baseDistFractions[indexRun]/sum:0;
  let dist=weeklyKm*fraction; if(isScarico) dist*=0.7;
  let asc=weeklyAsc*fraction; if(isScarico) asc*=0.7;
  const pace=paceByLevel(livello); const durationMin=dist*pace;
  let details="";
  if(type.includes("Ripetute")) details=`${Math.min(12,Math.max(4,Math.round(dist)))}√ó400 m in salita, recupero 90‚Äì120s`;
  else if(type.includes("Progressivo")) details=`Progressivo: aumenta ritmo negli ultimi km`;
  else if(type.includes("Medio")) details=`Medio: ${Math.max(4,Math.round(dist*0.6))} km a ritmo sostenuto`;
  else if(type.includes("Lungo")) details=`Lungo: ritmo lento, endurance`;
  else if(type.includes("Fartlek")) details=`Fartlek: alternare 2‚Äì3' veloce / 2' lento`;
  else details=`Ritmo facile, tecnica e recupero`;
  return {distance:+dist.toFixed(1),ascent:Math.round(asc),durationMin:Math.round(durationMin),detailText:details};
}

// ---------------------- Genera piano ----------------------
function selectRunDays(allenTot,giorniPalestra){
  const runNeeded=Math.max(0,allenTot-giorniPalestra.length);
  const free=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"].filter(d=>!giorniPalestra.includes(d));
  if(runNeeded>=free.length) return free.slice(0,runNeeded);
  const step=free.length/runNeeded; const out=[];
  for(let i=0;i<runNeeded;i++){out.push(free[Math.floor(i*step+step/2)]);}
  return out;
}
function generaPiano(settings){
  const plan=[]; const prog=settings.livello==="principiante"?[0.5,0.6,0.7,0.8,0.9,1.0]:settings.livello==="intermedio"?[0.6,0.7,0.8,0.9,1.0]:[0.7,0.8,0.9,1.0];
  for(let w=1;w<=settings.settimane;w++){
    const coeff=prog[Math.min(w-1,prog.length-1)];
    const isScarico=w%4===0&&settings.settimane>6;
    const km=+(settings.obbKm*coeff*(isScarico?0.7:1)).toFixed(1);
    const asc=Math.round(settings.obbAsc*coeff*(isScarico?0.7:1));
    const runDays=selectRunDays(settings.allenTot,settings.giorniPalestra);
    const settimana=[]; let runIndex=0;
    const giorni=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
    for(const g of giorni){
      if(settings.giorniPalestra.includes(g)) settimana.push({day:g,type:"Palestra",summary:"üèãÔ∏è Palestra"});
      else if(runDays.includes(g)){
        const type=tipoAllenamentoForIndex(runIndex);
        const d=creaDettagliAllenamento(type,km,asc,runDays.length,runIndex,settings.livello,isScarico);
        settimana.push({day:g,type:"Corsa",summary:`üèÉ ${type}`,details:d});
        runIndex++;
      } else settimana.push({day:g,type:"Riposo",summary:"Riposo"});
    }
    plan.push({settimana:w,targetKm:km,targetAsc:asc,allenamenti:settimana,isScarico});
  }
  STATE.settings=settings; STATE.planData=plan; saveState(); renderPiano();
}

// ---------------------- Rendering ----------------------
function renderPiano(){
  const c=document.getElementById("planView"); c.innerHTML="";
  if(!STATE.planData.length){c.textContent="Nessun piano ancora generato.";return;}
  STATE.planData.forEach((w)=>{
    const week=document.createElement("div"); week.className="week";
    const h=document.createElement("h3");
    h.innerHTML=`üìÖ Settimana ${w.settimana} ‚Äî ${w.targetKm} km / +${w.targetAsc} m ${w.isScarico?"(scarico)":""}`;
    const t=document.createElement("button"); t.textContent="Apri"; t.style.fontSize="13px"; h.appendChild(t);
    week.appendChild(h);
    const days=document.createElement("div"); days.className="days";
    w.allenamenti.forEach((a)=>{
      const d=document.createElement("div"); d.className="day";
      d.innerHTML=`<strong>${a.day}</strong> ‚Äî ${a.summary}`;
      if(a.details){
        const det=document.createElement("div"); det.className="detail";
        det.innerHTML=`<div>${a.details.distance} km ‚Äî +${a.details.ascent} m ‚Äî ${formatTime(a.details.durationMin)}</div><div><em>${a.details.detailText}</em></div>`;
        d.appendChild(det);
        const upload=document.createElement("button"); upload.textContent="üìé Carica .fit"; upload.style.fontSize="13px";
        upload.addEventListener("click",()=>triggerUploadFor(a,w));
        d.appendChild(upload);
      }
      days.appendChild(d);
    });
    t.addEventListener("click",()=>{days.style.display=days.style.display==="block"?"none":"block";t.textContent=days.style.display==="block"?"Chiudi":"Apri";});
    week.appendChild(days); c.appendChild(week);
  });
  renderHistory();
}

// ---------------------- Upload FIT ----------------------
function triggerUploadFor(activity,week){
  const input=document.getElementById("hiddenFileInput");
  input.onchange=(e)=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
      try{
        const parser=new FitParser({force:true});
        parser.parse(ev.target.result,(err,data)=>{
          if(err){alert("Errore nel parsing del file FIT");return;}
          const records=data.records||[];
          const totalKm=records.reduce((sum,r,i,a)=>{
            if(i===0)return 0;
            const prev=a[i-1];
            if(r.position_lat&&r.position_long&&prev.position_lat&&prev.position_long){
              const dx=r.position_lat-prev.position_lat;
              const dy=r.position_long-prev.position_long;
              return sum+Math.sqrt(dx*dx+dy*dy)*110;
            }
            return sum;
          },0);
          const ascent=records.reduce((s,r,i,a)=>i>0?s+Math.max(0,r.altitude-a[i-1].altitude):0,0);
          const date=(data.sessions&&data.sessions[0]?.start_time)||"";
          activity.uploaded={filename:file.name,km:totalKm,asc:ascent,date};
          STATE.history.unshift({name:file.name,km:+totalKm.toFixed(1),asc:+ascent.toFixed(0),date:new Date().toLocaleDateString()});
          saveState(); renderPiano();
        });
      }catch(e){alert("Errore FitParser: "+e.message);}
    };
    reader.readAsArrayBuffer(file);
  };
  input.click();
}

// ---------------------- Storico ----------------------
function renderHistory(){
  const c=document.getElementById("historyList"); if(!STATE.history.length){c.textContent="Nessun allenamento registrato.";return;}
  c.innerHTML=STATE.history.map(h=>`üìÅ ${h.name} ‚Äî ${h.km.toFixed(1)} km / +${h.asc} m (${h.date})`).join("<br>");
}

// ---------------------- Eventi ----------------------
document.getElementById("settingsCard").addEventListener("click",(e)=>{
  if(e.target.classList.contains("chk-btn")){
    e.target.classList.toggle("active");
    STATE.settings.giorniPalestra=[...document.querySelectorAll(".chk-btn.active")].map(b=>b.getAttribute("data-day"));
    saveState();
  }
});
document.getElementById("genLocal").addEventListener("click",()=>{
  const s={
    livello:document.getElementById("livello").value,
    obbKm:+document.getElementById("obbKm").value||20,
    obbAsc:+document.getElementById("obbD+").value||1000,
    settimane:+document.getElementById("settimane").value||8,
    allenTot:+document.getElementById("allenTot").value||4,
    giorniPalestra:STATE.settings.giorniPalestra||[]
  };
  generaPiano(s);
});
document.getElementById("resetData").addEventListener("click",()=>{localStorage.removeItem(STORAGE_KEY);STATE=JSON.parse(JSON.stringify(DEFAULT_STATE));renderPiano();});

// ---------------------- Init ----------------------
loadState(); renderPiano();
</script>
</body>
</html>