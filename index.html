<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v14.2</title>
<meta name="theme-color" content="#000000">
<style>
:root{--card-radius:12px;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;}
h1{text-align:center;font-size:22px;margin:6px 0;}
.card{background:#fff;border-radius:var(--card-radius);padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.06);}
label{display:block;margin:8px 0 6px;font-weight:600;}
input[type="number"], select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box;}
button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:8px;cursor:pointer;}
button.reset{background:#ff3b30;margin-left:8px;}
.week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
.week h3{margin:0;cursor:pointer;font-size:17px;display:flex;justify-content:space-between;align-items:center;}
.days{margin-top:6px;padding-left:10px;display:none;}
.days .day{padding:6px 0;border-bottom:1px solid #eee;}
.small{font-size:13px;color:#666;margin-top:6px;}
.toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:6px 10px;font-size:13px;margin-top:-4px;}
.checkbox-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;}
.checkbox-grid-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;}
.chk-btn{display:flex;align-items:center;justify-content:center;padding:8px;border-radius:8px;background:#f2f2f2;cursor:pointer;border:1px solid transparent;font-weight:700;}
.chk-btn.active{background:#007aff;color:#fff;border-color:#0060d6;}
.detail{background:#fff;border-radius:8px;padding:10px;margin:6px 0 10px;border:1px solid #eee;font-size:14px;}
.muted{color:#666;font-size:13px;}
.fileline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px;}
.meta{font-size:13px;color:#333;margin-top:6px;}
.alert{background:#fff3cd;border:1px solid #ffeeba;padding:8px;border-radius:8px;margin-top:8px;color:#856404;}
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v14.2</h1>

<div class="card" id="topSummaryCard" style="display:none;">
  <div id="summaryText" class="muted"></div>
</div>

<div class="card" id="settingsCard">
  <div>
    <span style="font-weight:600;">‚öôÔ∏è Impostazioni</span>
    <button id="toggleSettings" class="toggle-btn" aria-expanded="true">Nascondi</button>
  </div>
  <div id="settingsContent">
    <label>Livello atleta</label>
    <select id="livello">
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzato">Avanzato</option>
    </select>

    <label>Obiettivo distanza gara (km)</label>
    <input id="obbKm" type="number" placeholder="es. 20" />

    <label>Obiettivo dislivello gara (m)</label>
    <input id="obbAsc" type="number" placeholder="es. 1000" />

    <label>Durata piano (settimane)</label>
    <input id="settimane" type="number" value="12" min="4" max="52" />

    <label>Allenamenti totali a settimana</label>
    <input id="allenTot" type="number" value="4" min="2" max="7" step="0.5"/>

    <label>Giorni palestra (toggle)</label>
    <div>
      <div class="checkbox-grid" id="palestraTop">
        <div class="chk-btn" data-day="Luned√¨">Lun</div>
        <div class="chk-btn" data-day="Marted√¨">Mar</div>
        <div class="chk-btn" data-day="Mercoled√¨">Mer</div>
      </div>
      <div class="checkbox-grid-bottom" id="palestraBottom">
        <div class="chk-btn" data-day="Gioved√¨">Gio</div>
        <div class="chk-btn" data-day="Venerd√¨">Ven</div>
        <div class="chk-btn" data-day="Sabato">Sab</div>
        <div class="chk-btn" data-day="Domenica">Dom</div>
      </div>
    </div>

    <div style="margin-top:8px;">
      <button id="genLocal" class="save">‚öôÔ∏è Genera piano</button>
      <button id="resetData" class="reset">üóëÔ∏è Reset dati</button>
    </div>
  </div>
</div>

<div class="card">
  <label>Avanzamento</label>
  <canvas id="progressChart" width="360" height="140"></canvas>
  <div id="chartText" class="small"></div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView" class="small">Nessun piano ancora generato.</div>
</div>

<div class="card">
  <label>Storico allenamenti</label>
  <div id="historyList" class="small">Nessun allenamento registrato.</div>
</div>

<input id="hiddenFileInput" type="file" accept=".gpx" style="display:none" />

<script>
// ---------------------- Stato & storage ----------------------
const STORAGE_KEY = "trailcoach_v14_state";
const DEFAULT_STATE = {
  settings: { livello:"principiante", obbKm:20, obbAsc:1000, settimane:12, allenTot:4, giorniPalestra:[] },
  planData: [],
  progress: { km:0, ascent:0 },
  history: []
};
let STATE = JSON.parse(JSON.stringify(DEFAULT_STATE));
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }
function loadState(){ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ try{ STATE = JSON.parse(raw); }catch(e){ console.warn("loadState parse error", e); } } }

// ---------------------- Utility ----------------------
const GIORNI = ["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
function paceByLevel(lvl){ return lvl==="principiante"?6 : lvl==="intermedio"?5.5 : 5; }
function formatTime(mins){ const h=Math.floor(mins/60); const m=Math.round(mins%60); return h>0?`${h}h ${m}m`:`${m}m`; }

// ---------------------- Funzione dettagli allenamento ----------------------
function creaDettagliAllenamento(type, km, asc, livello){
  const pace = paceByLevel(livello);
  let detailsText = "";
  if(type==="Lungo trail") detailsText="Ritmo lento, endurance, salita costante";
  else if(type==="Fartlek") detailsText="Alternare 2‚Äì3' veloce / 2' lento";
  else if(type==="Medio costante") detailsText="Medio: ritmo sostenuto per la maggior parte della distanza";
  else if(type==="Ripetute") detailsText=`${Math.min(12, Math.max(4, Math.round(km)))}√ó400 m in salita, recupero 90‚Äì120s`;
  else if(type==="Progressivo") detailsText="Progressivo: aumenta ritmo negli ultimi km";
  else detailsText="Ritmo facile, tecnica e recupero";

  return {
    distance: +km.toFixed(1),
    ascent: Math.round(asc),
    durationMin: Math.round(km*pace),
    detailText: detailsText
  };
}

// ---------------------- Generazione piano ----------------------
function generaPiano(settings){
  const plan = [];
  
  for(let w=1; w<=settings.settimane; w++){
    // Scarico penultima settimana
    const isScarico = (w === settings.settimane - 1);
    const isUltimaGara = (w === settings.settimane);

    // Target settimanale: progressione lineare fino alla gara
    let progressFactor = w / settings.settimane;
    let targetKm = isUltimaGara ? settings.obbKm : +(settings.obbKm * progressFactor).toFixed(1);
    let targetAsc = Math.round(settings.obbAsc * progressFactor);

    const freeRunDays = GIORNI.filter(d => !settings.giorniPalestra.includes(d));

    // Seleziona 1 lungo nel weekend
    const weekend = freeRunDays.filter(d => d === "Sabato" || d === "Domenica");
    const longDay = weekend[0] || freeRunDays[0];

    const runsCount = Math.floor(settings.allenTot - settings.giorniPalestra.length);
    const runDays = [];

    // Lungo
    runDays.push(longDay);

    // Aggiungi altri allenamenti (forza/velocit√†)
    const remainingRuns = runsCount - 1;
    const restDays = freeRunDays.filter(d => d !== longDay);
    for(let i=0;i<remainingRuns;i++){
      runDays.push(restDays[i % restDays.length]);
    }

    const settimana = [];
    for(const day of GIORNI){
      if(settings.giorniPalestra.includes(day)){
        settimana.push({ day, type:"Palestra", summary:"üèãÔ∏è Palestra", details:{ note:"Forza & Core" }, uploaded:null, completed:false });
      } else if(runDays.includes(day)){
        let type = "Fondo lento"; // default
        if(day === longDay) type = isUltimaGara ? "Lungo gara" : "Lungo trail";
        else if(day !== longDay && runsCount > 1) type = "Medio costante"; // esercizio di velocit√†/forza

        const det = creaDettagliAllenamento(type, targetKm, targetAsc, runsCount, runDays.indexOf(day), settings.livello, isScarico);
        settimana.push({ day, type:"Corsa", summary:`üèÉ ${type} ‚Äî ${det.distance} km`, details:det, uploaded:null, completed:false });
      } else {
        settimana.push({ day, type:"Riposo", summary:"Riposo", details:{ note:"Recupero" }, uploaded:null, completed:false });
      }
    }

    plan.push({ settimana:w, targetKm, targetAsc, isScarico, allenamenti:settimana, completato:false });
  }

  STATE.settings = settings;
  STATE.planData = plan;
  saveState();
  renderAll();
}


// ---------------------- Selezione giorni corsa ----------------------
function selectRunDays(allenTot, giorniPalestra, weekNum){
  const totalRuns = allenTot - giorniPalestra.length;
  const fullRuns = Math.floor(totalRuns);
  const halfRun = totalRuns - fullRuns; // 0 o 0.5
  const freeDays = GIORNI.filter(d=>!giorniPalestra.includes(d));
  const selected = [];

  // Alternanza allenamenti
  if(fullRuns>0){
    const step = freeDays.length/fullRuns;
    for(let i=0;i<fullRuns;i++) selected.push(freeDays[Math.floor(i*step)]);
  }

  if(halfRun>0 && freeDays.length>selected.length){
    const remaining = freeDays.filter(d=>!selected.includes(d));
    selected.push(remaining[Math.floor(remaining.length/2)]);
  }

  return selected;
}

// ---------------------- Render piano ----------------------
function renderAll(){ renderSettingsToUI(); renderSummary(); renderPiano(); renderProgress(); renderHistory(); }

function renderSettingsToUI(){
  const s=STATE.settings;
  document.getElementById("livello").value=s.livello;
  document.getElementById("obbKm").value=s.obbKm;
  document.getElementById("obbAsc").value=s.obbAsc;
  document.getElementById("settimane").value=s.settimane;
  document.getElementById("allenTot").value=s.allenTot;
  document.querySelectorAll(".chk-btn").forEach(b=>{
    const day=b.getAttribute("data-day");
    b.classList.toggle("active",s.giorniPalestra.includes(day));
  });
}

function renderSummary(){
  const top=document.getElementById("topSummaryCard");
  if(!STATE.planData||STATE.planData.length===0){ top.style.display="none"; return; }
  top.style.display="block";
  const s=STATE.settings;
  const gym=s.giorniPalestra.length;
  const run=Math.max(0,s.allenTot-gym);
  document.getElementById("summaryText").textContent=`Allenamenti/settimana: ${s.allenTot} ‚Äî Palestra: ${gym} ‚Äî Corsa: ${run} ‚Äî Durata: ${s.settimane} settimane`;
}

function renderPiano(){
  const container = document.getElementById("planView");
  container.innerHTML = "";
  if(!STATE.planData || STATE.planData.length===0){ 
    container.textContent = "Nessun piano ancora generato."; 
    return; 
  }

  STATE.planData.forEach((w, weekIndex)=>{
    const weekDiv = document.createElement("div"); 
    weekDiv.className="week";

    const header = document.createElement("h3");
    const left = document.createElement("span");
    left.innerText = `üìÖ Settimana ${w.settimana} ‚Äì Target: ${w.targetKm} km / +${w.targetAsc} m ${w.completato ? "‚úÖ" : ""}${w.isScarico ? " ‚Äî Scarico" : ""}`;
    header.appendChild(left);

    const btnToggle = document.createElement("button");
    btnToggle.textContent = "Apri";
    btnToggle.style.fontSize="13px";

    const daysDiv = document.createElement("div");
    daysDiv.className="days";
    daysDiv.style.display="none"; // nascosto di default

    // Listener per aprire/chiudere la settimana
    btnToggle.addEventListener("click", ()=>{
        if(daysDiv.style.display==="block"){
            daysDiv.style.display="none";
            btnToggle.textContent="Apri";
        } else {
            daysDiv.style.display="block";
            btnToggle.textContent="Chiudi";
        }
    });

    header.appendChild(btnToggle);
    weekDiv.appendChild(header);

    // Ciclo giorni
    w.allenamenti.forEach((a, dayIndex)=>{
      const d = document.createElement("div"); 
      d.className="day";
      const summary = document.createElement("div");
      summary.innerHTML = `<strong>${a.day}</strong> ‚Äî ${a.summary}${a.completed ? " ‚úÖ" : ""}`;
      summary.style.display="flex"; 
      summary.style.justifyContent="space-between"; 
      summary.style.alignItems="center";

      const openBtn = document.createElement("button");
      openBtn.textContent = "Dettagli";
      openBtn.style.fontSize="13px";
      summary.appendChild(openBtn);
      d.appendChild(summary);

      const detailBox = document.createElement("div");
      detailBox.className="detail";
      detailBox.style.display="none";

      if(a.type === "Corsa" && a.details){
        detailBox.innerHTML = `
          <div><strong>${a.summary.split("‚Äî")[0].trim()}</strong></div>
          <div class="muted">Obiettivo: ${a.details.distance} km ‚Äî +${a.details.ascent} m ‚Äî ${formatTime(a.details.durationMin)}</div>
          <div style="margin-top:8px;"><em>${a.details.detailText}</em></div>
        `;
      } else if(a.type === "Palestra"){
        detailBox.innerHTML = `<div><strong>Palestra</strong></div><div class="muted">Forza & Core ‚Äî esercizi consigliati</div>`;
      } else {
        detailBox.innerHTML = `<div><strong>Riposo</strong></div><div class="muted">Recupero attivo consigliato</div>`;
      }

      openBtn.addEventListener("click", ()=>{
        detailBox.style.display = detailBox.style.display === "none" ? "block" : "none";
      });

      d.appendChild(detailBox);
      daysDiv.appendChild(d);
    });

    weekDiv.appendChild(daysDiv);
    container.appendChild(weekDiv);
  });
}


// ---------------------- Upload GPX ----------------------
let uploadContext=null;
const hiddenInput=document.getElementById("hiddenFileInput");

hiddenInput.addEventListener("change", async ev=>{
  const f=ev.target.files[0];
  if(!f || !uploadContext){ ev.target.value=""; return; }
  const { weekIndex, dayIndex }=uploadContext;
  const dayObj=STATE.planData[weekIndex].allenamenti[dayIndex];
  const statusSpan=document.querySelectorAll(".week")[weekIndex].querySelectorAll(".days .day")[dayIndex].querySelector(".meta");
  if(statusSpan) statusSpan.textContent="‚è≥ Lettura file...";

  try{
    const txt=await f.text();
    const { km, asc }=parseGpxText(txt);
    const date=new Date().toLocaleDateString();
    dayObj.uploaded={ filename:f.name, km, asc, date };
    dayObj.completed=true;
    STATE.progress.km=(STATE.progress.km||0)+km;
    STATE.progress.ascent=(STATE.progress.ascent||0)+asc;
    STATE.history.unshift({ date, km, asc, filename:f.name, week:STATE.planData[weekIndex].settimana, day:dayObj.day });
    saveState();
    renderAll();
  }catch(e){ console.error(e); if(statusSpan) statusSpan.textContent="Errore lettura file";}
  finally{ setTimeout(()=>{ ev.target.value=""; uploadContext=null; },300); }
});

function parseGpxText(txt){
  try{
    const eleMatches=[...txt.matchAll(/<trkpt[^>]*>[\s\S]*?<ele>([\d\.\-]+)<\/ele>/g)];
    const coordsMatches=[...txt.matchAll(/<trkpt[^>]*lat="([^"]+)"\s+lon="([^"]+)"[^>]*>/g)];
    const elev=eleMatches.map(m=>parseFloat(m[1]));
    let asc=0;
    for(let i=1;i<elev.length;i++){ const diff=elev[i]-elev[i-1]; if(diff>0) asc+=diff; }
    let km=0;
    if(coordsMatches.length>=2){
      const pts=coordsMatches.map(m=>({lat:parseFloat(m[1]),lon:parseFloat(m[2])}));
      for(let i=1;i<pts.length;i++){ km+=haversineKm(pts[i-1].lat, pts[i-1].lon, pts[i].lat, pts[i].lon); }
    } else km=Math.max(0, coordsMatches.length/1000);
    return { km:+km.toFixed(2), asc:Math.round(asc) };
  }catch(e){ console.error(e); return { km:0, asc:0 }; }
}

function haversineKm(lat1, lon1, lat2, lon2){
  const R=6371;
  const toRad=v=>v*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function triggerUploadFor(weekIndex, dayIndex){ uploadContext={ weekIndex, dayIndex }; hiddenInput.click(); }

// ---------------------- Render altri elementi ----------------------
function renderProgress(){
  const c=document.getElementById("progressChart"), ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const totalTargetKm=STATE.planData.reduce((a,b)=>a+b.targetKm,0)||STATE.settings.obbKm;
  const perc=Math.min((STATE.progress.km||0)/totalTargetKm,1);
  ctx.fillStyle="#007aff"; ctx.fillRect(20,50,(c.width-40)*perc,18);
  ctx.fillStyle="#eee"; ctx.fillRect(20+(c.width-40)*perc,50,(c.width-40)*(1-perc),18);
  ctx.fillStyle="#000"; ctx.fillText(`Km: ${(STATE.progress.km||0).toFixed(1)} / ${totalTargetKm.toFixed(1)} km`,20,45);
  ctx.fillText(`D+: ${(STATE.progress.ascent||0).toFixed(0)} m`,20,85);
  document.getElementById("chartText").textContent=`Storico: ${STATE.history.length} allenamenti.`;
}

function renderHistory(){
  const h=document.getElementById("historyList");
  if(!STATE.history||STATE.history.length===0){ h.textContent="Nessun allenamento registrato."; return; }
  h.innerHTML=STATE.history.map(x=>`${x.date} ‚Äî Settimana ${x.week||"-"} ${x.day||"-"} ‚Üí ${x.km.toFixed(1)} km, +${x.asc.toFixed(0)} m (${x.filename})`).join("<br>");
}

// ---------------------- Eventi ----------------------
document.getElementById("toggleSettings").addEventListener("click",()=>{
  const content=document.getElementById("settingsContent");
  const btn=document.getElementById("toggleSettings");
  if(content.style.display==="none"){ content.style.display="block"; btn.textContent="Nascondi"; }
  else{ content.style.display="none"; btn.textContent="Mostra"; }
});

document.getElementById("settingsCard").addEventListener("click",(e)=>{
  if(e.target.classList && e.target.classList.contains("chk-btn")){
    const btn=e.target; btn.classList.toggle("active");
    STATE.settings.giorniPalestra=[...document.querySelectorAll(".chk-btn.active")].map(n=>n.getAttribute("data-day"));
    saveState();
  }
});

document.getElementById("genLocal").addEventListener("click",()=>{
  const s={
    livello:document.getElementById("livello").value,
    obbKm:Number(document.getElementById("obbKm").value)||20,
    obbAsc:Number(document.getElementById("obbAsc").value)||1000,
    settimane:Number(document.getElementById("settimane").value)||12,
    allenTot:Number(document.getElementById("allenTot").value)||4,
    giorniPalestra:STATE.settings.giorniPalestra
  };
  generaPiano(s);
});

document.getElementById("resetData").addEventListener("click",()=>{
  if(confirm("Confermi reset dati e piano?")){
    STATE=JSON.parse(JSON.stringify(DEFAULT_STATE));
    saveState(); renderAll();
  }
});

// ---------------------- Init ----------------------
loadState(); renderAll();
</script>
</body>
</html>
