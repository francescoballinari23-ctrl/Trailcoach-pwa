<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>TrailCoach AI v9.1</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.json">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#fafafa;color:#111;margin:12px;}
h1{text-align:center;font-size:22px;margin:8px 0;}
.card{background:#fff;border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,.08);}
label{display:block;margin:6px 0 4px;font-weight:600;}
input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-size:15px;}
button{background:#007aff;color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;margin-top:6px;}
button.save{background:#34c759;}button.orange{background:#ff9500;}button.red{background:#ff3b30;}
.week{background:#f7f9ff;border-radius:8px;margin:8px 0;padding:8px 10px;}
.week h3{margin:0;cursor:pointer;font-size:17px;}
.days{margin-top:6px;padding-left:10px;display:none;}
.days div{padding:4px 0;border-bottom:1px solid #eee;}
.small{font-size:13px;color:#666;}
canvas{width:100%;max-width:400px;margin:10px auto;display:block;}
.hidden{display:none;}
.toggle-btn{float:right;background:#eee;color:#111;font-weight:500;border-radius:6px;padding:2px 8px;font-size:13px;margin-top:-4px;}
.day-select label{display:inline-block;margin:4px 6px;padding:4px 8px;border:1px solid #ccc;border-radius:6px;}
.day-select input{margin-right:4px;}
</style>
</head>
<body>
<h1>üèîÔ∏è TrailCoach AI v9.1</h1>

<div class="card" id="settingsCard">
  <div>
    <span style="font-weight:600;">‚öôÔ∏è Impostazioni</span>
    <button id="toggleSettings" class="toggle-btn">Nascondi</button>
  </div>
  <div id="settingsContent">
    <label>Livello atleta</label>
    <select id="livello">
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzato">Avanzato</option>
    </select>

    <label>Obiettivo distanza gara (km)</label>
    <input id="obbKm" type="number" placeholder="es. 20" />

    <label>Obiettivo dislivello gara (m)</label>
    <input id="obbD+" type="number" placeholder="es. 1000" />

    <label>Durata piano (settimane)</label>
    <input id="settimane" type="number" value="8" min="1" max="52" />

    <label>Allenamenti totali / settimana</label>
    <input id="allenTot" type="number" value="4" min="2" max="7" />

    <label>Giorni palestra üèãÔ∏è</label>
    <div class="day-select" id="palestraDays">
      <label><input type="checkbox" value="Luned√¨">Lun</label>
      <label><input type="checkbox" value="Marted√¨">Mar</label>
      <label><input type="checkbox" value="Mercoled√¨">Mer</label>
      <label><input type="checkbox" value="Gioved√¨">Gio</label>
      <label><input type="checkbox" value="Venerd√¨">Ven</label>
      <label><input type="checkbox" value="Sabato">Sab</label>
      <label><input type="checkbox" value="Domenica">Dom</label>
    </div>

    <button id="genLocal" class="save">‚öôÔ∏è Genera piano</button>
  </div>
</div>

<div class="card">
  <label>Carica file .fit (allenamento Zepp/Garmin)</label>
  <input id="fitFile" type="file" accept=".fit" />
  <div id="fitInfo" class="small">Carica per aggiornare il progresso.</div>
</div>

<div class="card">
  <label>Avanzamento</label>
  <canvas id="progressChart" width="360" height="180"></canvas>
  <div id="chartText" class="small"></div>
</div>

<div class="card">
  <label>Piano settimanale</label>
  <div id="planView">Nessun piano ancora generato.</div>
</div>

<div class="card">
  <label>Storico allenamenti</label>
  <div id="historyList" class="small">Nessun allenamento caricato.</div>
</div>

<script>
// Simulatore FitParser
!function(t){t.FitParser=function(){return{parse:(a,e)=>{try{e(null,{sessions:[{total_distance:Math.random()*10+5,total_ascent:200+Math.random()*500}]})}catch(r){e(r)}}}}}(window);

const STORAGE_KEY="trailcoach_v9_1";
let planData=[], progress={km:0,ascent:0}, targetKm=0,targetAsc=0,history=[];

function progressione(lvl){
  switch(lvl){
    case "principiante": return [0.5,0.6,0.7,0.8,0.9,1.0];
    case "intermedio": return [0.6,0.7,0.8,0.9,1.0];
    case "avanzato": return [0.7,0.8,0.9,1.0];
    default: return [0.6,0.8,1.0];
  }
}

function generaPiano(lvl,km,asc,weeks,allenTot,giorniPalestra){
  const prog=progressione(lvl);
  planData=[];
  for(let w=1;w<=weeks;w++){
    let coeff=prog[Math.min(w-1,prog.length-1)];
    if(weeks>6 && w%4===0 && w>4) coeff*=0.7; // settimana di scarico
    planData.push({
      settimana:w,
      targetKm:(km*coeff).toFixed(1),
      targetAsc:Math.round(asc*coeff),
      completato:false,
      allenamenti:creaAllenamenti(allenTot,giorniPalestra)
    });
  }
  salvaLocale();renderPiano();drawChart();toggleSettings(false);
}

function creaAllenamenti(allenTot,giorniPalestra){
  const allCorsa=["Corsa facile","Ripetute collinari","Lungo trail","Medio","Progressivo"];
  let giorni=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
  let lista=[];
  giorni.forEach(g=>{
    if(giorniPalestra.includes(g)) lista.push(`${g} ‚Äì üèãÔ∏è Palestra`);
    else if(lista.filter(a=>a.includes("Corsa")).length < allenTot - giorniPalestra.length)
      lista.push(`${g} ‚Äì üèÉ ${allCorsa[Math.floor(Math.random()*allCorsa.length)]}`);
    else lista.push(`${g} ‚Äì Riposo`);
  });
  return lista;
}

function renderPiano(){
  const div=document.getElementById("planView");
  div.innerHTML="";
  planData.forEach(w=>{
    const week=document.createElement("div");
    week.className="week";
    week.innerHTML=`<h3>üìÖ Settimana ${w.settimana} ‚Äì Target: ${w.targetKm} km / +${w.targetAsc}m ${w.completato?"‚úÖ":""}</h3>`;
    const days=document.createElement("div");
    days.className="days";
    w.allenamenti.forEach(d=>{const dd=document.createElement("div");dd.textContent=d;days.appendChild(dd);});
    week.appendChild(days);
    week.querySelector("h3").onclick=()=>days.style.display=days.style.display==="none"?"block":"none";
    div.appendChild(week);
  });
}

function drawChart(){
  const c=document.getElementById("progressChart"),ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const percKm=Math.min(progress.km/targetKm,1);
  const percAsc=Math.min(progress.ascent/targetAsc,1);
  ctx.fillStyle="#007aff";ctx.fillRect(40,80,280*percKm,25);
  ctx.fillStyle="#ccc";ctx.fillRect(40+280*percKm,80,280*(1-percKm),25);
  ctx.fillStyle="#ff9500";ctx.fillRect(40,120,280*percAsc,25);
  ctx.fillStyle="#ccc";ctx.fillRect(40+280*percAsc,120,280*(1-percAsc),25);
  ctx.fillStyle="#000";ctx.fillText("Km",10,98);ctx.fillText("D+",10,138);
  document.getElementById("chartText").textContent=
  `${progress.km.toFixed(1)} km / ${targetKm} km ‚Äî +${progress.ascent.toFixed(0)} m / +${targetAsc} m`;
}

function aggiornaPiano(){
  let cum=0;
  planData.forEach(w=>{cum+=+w.targetKm;if(progress.km>=cum)w.completato=true;});
  renderPiano();drawChart();renderHistory();
}

function renderHistory(){
  const div=document.getElementById("historyList");
  div.innerHTML=history.length?history.map(h=>`<div>${h.date} ‚Üí ${h.km.toFixed(1)} km, +${h.asc.toFixed(0)} m</div>`).join(""):"Nessun allenamento caricato.";
}

function salvaLocale(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify({planData,progress,targetKm,targetAsc,history}));
}
function caricaLocale(){
  const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return;
  try{const d=JSON.parse(raw);
    planData=d.planData||[];progress=d.progress||{km:0,ascent:0};
    targetKm=d.targetKm||0;targetAsc=d.targetAsc||0;
    history=d.history||[];
    renderPiano();drawChart();renderHistory();
    if(planData.length>0)toggleSettings(false);
  }catch(e){console.log("Errore load",e);}
}

function adattaPianoAutomaticamente(){
  if(history.length<3)return;
  const last3=history.slice(0,3);
  const mediaKm=last3.reduce((a,b)=>a+b.km,0)/3;
  const mediaTarget=targetKm/planData.length;
  const ratio=mediaKm/mediaTarget;
  planData.forEach((w,i)=>{
    if(!w.completato){
      if(ratio>1.1){w.targetKm=(w.targetKm*1.05).toFixed(1);w.targetAsc=Math.round(w.targetAsc*1.05);}
      else if(ratio<0.8){w.targetKm=(w.targetKm*0.9).toFixed(1);w.targetAsc=Math.round(w.targetAsc*0.9);}
      if(ratio<0.8 && i%4===0){w.targetKm=(w.targetKm*0.7).toFixed(1);}
    }
  });
  salvaLocale();renderPiano();
}

document.getElementById("genLocal").onclick=()=>{
  const lvl=livello.value;
  targetKm=+document.getElementById("obbKm").value;
  targetAsc=+document.getElementById("obbD+").value;
  const weeks=+document.getElementById("settimane").value;
  const allenTot=+document.getElementById("allenTot").value;
  const giorniPalestra=[...document.querySelectorAll("#palestraDays input:checked")].map(i=>i.value);
  if(!targetKm||!targetAsc){alert("Inserisci obiettivi gara.");return;}
  progress={km:0,ascent:0};history=[];
  generaPiano(lvl,targetKm,targetAsc,weeks,allenTot,giorniPalestra);
};

document.getElementById("fitFile").addEventListener("change",async ev=>{
  const file=ev.target.files[0];if(!file)return;
  const info=document.getElementById("fitInfo");info.textContent="‚è≥ Lettura file...";
  try{
    const ab=await file.arrayBuffer();const parser=new FitParser();
    parser.parse(ab,(e,data)=>{
      if(e){info.textContent="Errore file";return;}
      const s=data.sessions?.[0];const dist=s.total_distance||0,asc=s.total_ascent||0;
      progress.km+=dist;progress.ascent+=asc;
      history.unshift({date:new Date().toLocaleDateString("it-IT"),km:dist,asc});
      aggiornaPiano();adattaPianoAutomaticamente();
      info.textContent=`üèÅ Totale: ${progress.km.toFixed(1)} km / +${progress.ascent.toFixed(0)} m`;
      salvaLocale();
    });
  }catch(e){info.textContent="Errore: "+e;}
});

function toggleSettings(show){
  const c=document.getElementById("settingsContent");
  const b=document.getElementById("toggleSettings");
  if(show===undefined)show=c.classList.contains("hidden");
  if(show){c.classList.remove("hidden");b.textContent="Nascondi";}
  else{c.classList.add("hidden");b.textContent="Mostra";}
}
document.getElementById("toggleSettings").onclick=()=>toggleSettings();

caricaLocale();
window.addEventListener("load",()=>setTimeout(()=>window.scrollTo(0,1),500));
</script>
</body>
</html>